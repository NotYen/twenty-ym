# Twenty CRM 完整使用指南

## 📦 快速開始

### 方式一：一鍵啟動（推薦）

```bash
./一鍵啟動.sh
```

這個腳本會自動：
- ✅ 檢查系統環境
- ✅ 啟動 PostgreSQL 和 Redis
- ✅ 設置所有環境變數
- ✅ 啟動後端、前端和 Worker
- ✅ 驗證多租戶配置

### 方式二：分步啟動

```bash
# 1. 啟動服務
./start-twenty-local.sh

# 2. 如果遇到問題，運行診斷
./診斷並修復.sh

# 3. 停止服務
./stop-twenty-local.sh
```

## 🔧 配置說明

所有配置都在 `twenty-config.sh` 文件中：

```bash
# 修改外部訪問地址
export EXTERNAL_HOST="your-domain.com"

# 修改端口
export FRONTEND_PORT=8866
export BACKEND_PORT=8867

# 多租戶配置
export DEFAULT_SUBDOMAIN="apple"
export IS_MULTIWORKSPACE_ENABLED="true"
```

## 🌐 訪問地址

### 開發環境（使用 nip.io）

- **默認工作區**：`http://apple.118.168.188.27.nip.io:8866`
- **後端 API**：`http://118.168.188.27.nip.io:8867`

### 生產環境（使用真實域名）

修改 `twenty-config.sh`：
```bash
export EXTERNAL_HOST="your-domain.com"
```

訪問地址變為：
- **默認工作區**：`http://apple.your-domain.com:8866`

## 🐛 常見問題

### 問題 1：訪問跳轉到錯誤的 URL（`.domain.com`）

**症狀**：訪問時跳轉到 `http://.118.168.188.27.nip.io:8866/welcome`

**原因**：`defaultSubdomain` 環境變數未正確傳遞給後端

**解決方案**：

```bash
# 方法 1：使用一鍵啟動腳本（推薦）
./stop-twenty-local.sh
./一鍵啟動.sh

# 方法 2：運行診斷並修復
./診斷並修復.sh
```

### 問題 2：環境變數重啟後失效

**原因**：環境變數只在當前 shell 會話中有效

**解決方案**：始終使用提供的啟動腳本，它們會自動加載配置

### 問題 3：端口被佔用

**解決方案**：

```bash
# 檢查佔用端口的進程
lsof -i :8866
lsof -i :8867

# 使用停止腳本清理
./stop-twenty-local.sh
```

### 問題 4：數據庫連接失敗

**解決方案**：

```bash
# 檢查 PostgreSQL 狀態
brew services list | grep postgresql

# 重啟 PostgreSQL
brew services restart postgresql@16

# 檢查端口
lsof -i :5432
```

## 📊 服務狀態檢查

### 檢查所有服務

```bash
# PostgreSQL
lsof -i :5432

# Redis
lsof -i :6379

# 後端 API
lsof -i :8867

# 前端 Web
lsof -i :8866

# Worker
ps aux | grep queue-worker
```

### 查看日誌

```bash
# 實時查看所有日誌
tail -f twenty.log

# 只看錯誤
grep -i error twenty.log

# 只看後端日誌
grep "twenty-server" twenty.log
```

## 🔄 多租戶管理

### 創建新的 Workspace

1. 訪問默認工作區：`http://apple.118.168.188.27.nip.io:8866`
2. 以管理員身份登入
3. 在管理面板創建新 workspace
4. 系統會自動分配子域名（如 `banana.118.168.188.27.nip.io:8866`）

### 切換 Workspace

方式一：通過 URL 直接訪問
```
http://{subdomain}.118.168.188.27.nip.io:8866
```

方式二：在應用內切換
- 點擊左上角 workspace 選擇器
- 選擇要切換的 workspace

## 🚀 遷移到新機器

### 準備工作

1. **在舊機器上**：

```bash
# 備份數據庫
pg_dump -h localhost -p 5432 -U postgres -d default > twenty_backup.sql

# 打包項目（包含配置）
tar -czf twenty-migration.tar.gz \
    twenty-config.sh \
    一鍵啟動.sh \
    stop-twenty-local.sh \
    診斷並修復.sh \
    twenty_backup.sql
```

2. **在新機器上**：

```bash
# 1. 安裝依賴
brew install node yarn postgresql@16 redis

# 2. 克隆項目
git clone <your-repo>
cd twenty-ym

# 3. 解壓配置文件
tar -xzf twenty-migration.tar.gz

# 4. 修改配置（如果 IP 變了）
vim twenty-config.sh
# 更新 EXTERNAL_HOST

# 5. 安裝依賴
yarn install

# 6. 恢復數據庫
createdb -U postgres default
psql -U postgres -d default < twenty_backup.sql

# 7. 一鍵啟動
./一鍵啟動.sh
```

### 最小化配置文件

只需要這些文件就能在新機器上運行：

```
📁 twenty-ym/
├── 📄 twenty-config.sh          # 配置文件
├── 📄 一鍵啟動.sh                # 啟動腳本
├── 📄 stop-twenty-local.sh      # 停止腳本
├── 📄 診斷並修復.sh              # 診斷腳本
└── 📄 twenty_backup.sql         # 數據庫備份（可選）
```

## 🔐 環境變數說明

### 必需的環境變數

| 變數名 | 說明 | 示例值 |
|--------|------|--------|
| `FRONTEND_URL` | 前端訪問地址 | `http://118.168.188.27.nip.io:8866` |
| `SERVER_URL` | 後端 API 地址 | `http://118.168.188.27.nip.io:8867` |
| `DEFAULT_SUBDOMAIN` | 默認工作區子域名 | `apple` |
| `IS_MULTIWORKSPACE_ENABLED` | 啟用多租戶 | `true` |
| `PG_DATABASE_URL` | PostgreSQL 連接 | `postgres://postgres:postgres@localhost:5432/default` |
| `REDIS_URL` | Redis 連接 | `redis://localhost:6379` |

### 可選的環境變數

| 變數名 | 說明 | 默認值 |
|--------|------|--------|
| `EMAIL_DRIVER` | 郵件驅動 | `LOGGER` |
| `IS_BILLING_ENABLED` | 啟用計費 | `false` |
| `SIGN_IN_PREFILLED` | 預填登入信息 | `false` |

## 📚 腳本說明

### 一鍵啟動.sh

完整的啟動腳本，包含：
- 環境檢查
- 依賴服務啟動
- 環境變數設置
- Twenty 服務啟動
- 配置驗證

### stop-twenty-local.sh

優雅地停止所有服務：
1. Worker
2. 前端 Web
3. 後端 API
4. Redis
5. PostgreSQL

### 診斷並修復.sh

自動診斷常見問題：
- 檢查環境變數
- 檢查後端配置
- 檢查數據庫 workspace
- 提供自動修復選項

## 🎯 最佳實踐

### 開發環境

1. **使用 nip.io**：無需配置 DNS
   ```bash
   export EXTERNAL_HOST="118.168.188.27.nip.io"
   ```

2. **啟用預填登入**：快速測試
   ```bash
   export SIGN_IN_PREFILLED="true"
   ```

3. **禁用計費**：避免不必要的配置
   ```bash
   export IS_BILLING_ENABLED="false"
   ```

### 生產環境

1. **使用真實域名**：
   ```bash
   export EXTERNAL_HOST="crm.your-company.com"
   ```

2. **禁用預填登入**：
   ```bash
   export SIGN_IN_PREFILLED="false"
   ```

3. **啟用 HTTPS**：配置反向代理（Nginx/Caddy）

4. **限制 workspace 創建**：
   ```bash
   export IS_WORKSPACE_CREATION_LIMITED_TO_SERVER_ADMINS="true"
   ```

## 🛠️ 故障排除流程

```mermaid
graph TD
    A[遇到問題] --> B{服務運行中?}
    B -->|否| C[./一鍵啟動.sh]
    B -->|是| D[./診斷並修復.sh]
    D --> E{配置正確?}
    E -->|否| F[修復配置並重啟]
    E -->|是| G[檢查日誌: tail -f twenty.log]
    F --> H[./stop-twenty-local.sh]
    H --> C
    G --> I{找到錯誤?}
    I -->|是| J[根據錯誤修復]
    I -->|否| K[聯繫技術支持]
```

## 📞 支持

如遇到無法解決的問題：

1. 查看完整日誌：`cat twenty.log`
2. 查看診斷結果：`./診斷並修復.sh`
3. 檢查配置：`./twenty-config.sh --show`
4. 提供以上信息尋求幫助

