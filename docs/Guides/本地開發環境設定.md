# Windows 本地開發環境設定

本文件說明如何在 Windows 上設定本地開發環境，無需每次 build Docker image。

---

## 為什麼使用本地開發？

| 項目 | Docker Build | 本地開發 |
|------|-------------|----------|
| 啟動時間 | 40+ 分鐘 | 2-3 分鐘 |
| 代碼變更 | 需要 rebuild | 即時熱更新 |
| Pull code 後 | 可能需要 rebuild | 直接運行 |

---

## 前置需求

### 1. 安裝 Node.js

下載並安裝 Node.js 22.x 或以上版本（LTS 版本即可）：
- https://nodejs.org/

確認安裝：
```powershell
node --version
```

> **注意**：專案預設要求 Node.js 24.x，但 Node 24 尚未 LTS。
> 如果你使用 Node 22.x，需要修改 `package.json` 中的 engines 設定：
> ```json
> "engines": {
>     "node": ">=22.0.0",
>     ...
> }
> ```
> 本地開發使用 Node 22 通常沒有問題，Docker/生產環境仍使用 Node 24。

### 2. 安裝 Yarn

```powershell
npm install -g yarn
```

確認安裝：
```powershell
yarn --version
```

### 3. Docker Desktop

確保 Docker Desktop 已安裝並運行（用於 PostgreSQL 和 Redis）。

---

## 快速開始

### 步驟 1：啟動資料庫服務

只需要用 Docker 運行 PostgreSQL 和 Redis：

```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM\docker
docker-compose up -d postgres redis
```

### 步驟 2：建立環境變數檔案

在 `packages/twenty-server/` 目錄下建立 `.env` 檔案：

```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM
copy packages\twenty-server\.env.example packages\twenty-server\.env
```

然後編輯 `.env`，確保以下設定正確：

```ini
NODE_ENV=development

# 資料庫連線（密碼要與 docker/.env 中的 POSTGRES_PASSWORD 一致）
PG_DATABASE_URL=postgres://postgres:postgres123@localhost:5432/default

# Redis 連線
REDIS_URL=redis://localhost:6379

# App Secret
APP_SECRET=change_me_local_dev_secret_key_32chars

# 前端 URL
FRONTEND_URL=http://localhost:3001

# 後端 URL
SERVER_URL=http://localhost:3000

# 登入設定
SIGN_IN_PREFILLED=false
AUTH_PASSWORD_ENABLED=true

# 多租戶
IS_MULTIWORKSPACE_ENABLED=true
DEFAULT_SUBDOMAIN=default

# Debug
IS_DEBUG_MODE=true

# Storage
STORAGE_TYPE=local
```

### 步驟 3：安裝依賴

由於專案較大，需要先增加 Node.js 記憶體限制：

```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM

# 設定 Node.js 記憶體為 8GB（避免 heap out of memory 錯誤）
$env:NODE_OPTIONS="--max-old-space-size=8192"

# 安裝依賴
yarn install
```

> **注意**：
> - 首次安裝可能需要 10-15 分鐘，之後會更快
> - 如果出現 `JavaScript heap out of memory` 錯誤，請確認已設定 `NODE_OPTIONS`
> - 建議系統至少有 16GB RAM

### 步驟 4：啟動開發環境

**推薦方式：分開啟動前後端**（更穩定，方便看錯誤）

**PowerShell 視窗 1（後端）：**
```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM
$env:NODE_OPTIONS="--max-old-space-size=8192"
npx nx run twenty-server:start:prod
```

等待看到 `Nest application successfully started` 後，再開視窗 2。

**PowerShell 視窗 2（前端）：**
```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM
npx nx start twenty-front
```

> **注意**：
> - 如果 Port 3001 被佔用，前端會自動切換到 3002
> - 後端訪問 `http://localhost:3000/` 會顯示 404，這是正常的（API 在 `/graphql`）

---

## 訪問位置

| 服務 | URL |
|------|-----|
| Frontend | http://localhost:3001 (或 3002) |
| Backend API | http://localhost:3000 |
| GraphQL Playground | http://localhost:3000/graphql |

---

## 日常開發流程

### 每天開始工作

```powershell
# 1. 確保資料庫服務運行中
docker-compose up -d postgres redis

# 2. Pull 最新程式碼
git pull

# 3. 如果 package.json 有變更，重新安裝依賴
yarn install

# 4. 啟動開發環境
yarn start
```

### Pull code 後

```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM

# 如果只是程式碼變更，不需要任何動作，熱更新會自動生效

# 如果 package.json 有變更
yarn install

# 如果資料庫 migration 有變更
npx nx run twenty-server:database:migrate:prod
```

### 還原資料庫備份後

還原 DB 後**必須**執行 Migration，確保資料庫結構與程式碼一致：

```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM
npx nx run twenty-server:database:migrate:prod

# 然後重啟後端
```

> 詳細還原步驟請參考 `DB_還原指南.md`

---

## 常用指令

### 開發相關

```powershell
# 啟動完整開發環境（前端 + 後端 + worker）
yarn start

# 只啟動後端
npx nx start twenty-server

# 只啟動前端
npx nx start twenty-front

# 只啟動 worker
npx nx run twenty-server:worker
```

### 測試相關

```powershell
# 前端單元測試
npx nx test twenty-front

# 後端單元測試
npx nx test twenty-server

# 整合測試（需要資料庫）
npx nx run twenty-server:test:integration:with-db-reset
```

### 程式碼品質

```powershell
# Linting
npx nx lint twenty-front
npx nx lint twenty-server

# 型別檢查
npx nx typecheck twenty-front
npx nx typecheck twenty-server
```

### 資料庫相關

```powershell
# 重置資料庫
npx nx database:reset twenty-server

# 執行 migration
npx nx run twenty-server:database:migrate:prod

# 同步 metadata
npx nx run twenty-server:command workspace:sync-metadata
```

---

## 切換回 Docker 開發

如果需要使用完整的 Docker 環境：

```powershell
# 停止本地開發伺服器（Ctrl+C）

# 啟動所有 Docker 服務
cd D:\Project\YCRM_PROJECT\Y-CRM\docker
docker-compose up -d
```

訪問位置會變成：
- Frontend: http://localhost:8866
- Backend: http://localhost:8867

---

## 常見問題

### Q1: yarn install 出現 "JavaScript heap out of memory"？

專案較大，需要增加 Node.js 記憶體限制：

```powershell
$env:NODE_OPTIONS="--max-old-space-size=8192"
yarn install
```

### Q2: yarn install 很慢？

首次安裝需要下載大量依賴，可能需要 10-15 分鐘。之後會使用快取，速度會快很多。

### Q3: 端口被佔用？

確保 Docker 中的 backend/frontend 已停止：

```powershell
docker stop Y-CRM-backend Y-CRM-frontend Y-CRM-worker
```

### Q4: 資料庫連線失敗？

確認 PostgreSQL 和 Redis 正在運行：

```powershell
docker ps
```

確認 `.env` 中的密碼與 `docker/.env` 中的 `POSTGRES_PASSWORD` 一致。

另外確認 `packages/twenty-front/.env` 存在：
```ini
VITE_API_URL=http://localhost:3000
VITE_WORKSPACE_SUBDOMAIN=default
```

### Q5: 登入失敗？

重設用戶密碼（參考 `DB_還原指南.md`）。

### Q6: 如何查看後端日誌？

本地開發時，日誌會直接輸出到終端機。

### Q7: yarn install 出現 "Node version doesn't match the required version"？

專案預設要求 Node.js 24.x，但你可以使用 Node 22.x：

修改 `package.json`：
```json
"engines": {
    "node": ">=22.0.0",
    ...
}
```

然後重新執行 `yarn install`。

> **注意**：此修改只影響本地開發，Docker/生產環境仍使用 Node 24。
> `git pull` 後可能會被覆蓋，需要再改一次。

### Q8: yarn start 卡住沒反應？

改用分開啟動前後端的方式：

**視窗 1（後端）：**
```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM
$env:NODE_OPTIONS="--max-old-space-size=8192"
npx nx run twenty-server:start:prod
```

**視窗 2（前端）：**
```powershell
cd D:\Project\YCRM_PROJECT\Y-CRM
npx nx start twenty-front
```

### Q9: 後端訪問 localhost:3000 顯示 404？

這是正常的！後端沒有定義根路由。

- API 端點在：`http://localhost:3000/graphql`
- 健康檢查：`http://localhost:3000/healthz`

### Q10: 前端顯示 "Port 3001 is in use"？

前端會自動切換到其他 port（如 3002），直接訪問終端機顯示的 URL 即可。

如果想釋放 port：
```powershell
# 殺掉所有 Node 進程
taskkill /F /IM node.exe
```

---

## 問題排查總結

| 問題 | 解決方式 |
|------|----------|
| `yarn` 未安裝 | `npm install -g yarn` |
| `yarn install` 記憶體不足 | `$env:NODE_OPTIONS="--max-old-space-size=8192"` |
| Node.js 版本不符 | 修改 `package.json` 的 `engines.node` 為 `>=22.0.0` |
| `yarn start` 卡住 | 分開啟動前後端（見 Q8） |
| 缺少 `.env` 檔案 | 建立 `packages/twenty-server/.env`（見步驟 2） |
| Port 被佔用 | 前端自動切換 port，或用 `taskkill /F /IM node.exe` 清理 |

---

## 更新日誌

| 日期 | 更新內容 |
|------|----------|
| 2025-12-31 | 新增「還原資料庫備份後」章節 |
| 2025-12-30 | 初版建立 |
