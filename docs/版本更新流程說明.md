# Y-CRM 版本更新流程說明

## 概述

本文件說明 Y-CRM（基於 Twenty 開源專案）的版本管理機制和更新流程。

---

## 版本相關環境變數

| 環境變數 | 說明 | 範例 |
|---------|------|------|
| `APP_VERSION` | 應用程式版本號（semver 格式） | `1.0.0` |
| `FRONTEND_IMAGE_VERSION` | 前端 Docker image 版本 | `f_20251228_v3_aws_image` |
| `BACKEND_IMAGE_VERSION` | 後端 Docker image 版本 | `b_20251228_v3_aws_image` |

---

## 版本檢查機制

### 觸發時機

每次前端發送 GraphQL 請求時，會在 header 帶上 `X-App-Version`，後端會比較版本。

### 檢查邏輯

**只比較 major version**：

```typescript
if (frontEndMajor < backendMajor) {
  // 觸發 APP_VERSION_MISMATCH 錯誤
}
```

### 版本比較範例

| 前端版本 | 後端版本 | 會報錯嗎？ |
|---------|---------|-----------|
| 0.9.0 | 0.10.0 | ❌ 不會（major 都是 0） |
| 0.9.0 | 1.0.0 | ✅ 會（0 < 1） |
| 1.0.0 | 1.5.0 | ❌ 不會（major 都是 1） |
| 1.0.0 | 2.0.0 | ✅ 會（1 < 2） |

### 用戶看到的提示

當版本不匹配時，用戶會在右下角看到 **SnackBar 提示**（不是彈窗）：

> 「您的應用程式版本已過期，請重新整理頁面以繼續。」

---

## 更新流程

### 對開發者（你）

1. 修改程式碼
2. Build 新的 Docker images
3. Push 到 Docker Hub
4. 執行 `deploy-to-aws.sh` 部署到 AWS

```bash
./docker/dev-flow/aws/deploy-to-aws.sh
```

### 對用戶

**用戶只需要刷新頁面即可獲得新版本！**

原因：
- 前端是靜態檔案，由 Nginx 提供
- 當 frontend container 更新後，用戶刷新頁面就會載入新的 JS/CSS

---

## 前端設定頁面的版本資訊

### 1. 變更日誌（Changelog）

- **位置**：設定 → 版本 → Changelog tab
- **來源**：`https://twenty.com/api/releases`（Twenty 官方 API）
- **顯示內容**：Twenty 官方的 release notes（如 1.11.0）
- **注意**：這是 Twenty 官方版本，不是 Y-CRM 版本

### 2. 版本資訊（Version Info）

- **位置**：設定 → 版本 → Version Info tab
- **顯示內容**：
  - Frontend image version：來自 `FRONTEND_IMAGE_VERSION`
  - Backend image version：來自 `BACKEND_IMAGE_VERSION`

### 3. Admin Panel 版本資訊

- **位置**：設定 → Admin Panel → General
- **顯示內容**：
  - Current version：來自 `APP_VERSION` 環境變數
  - Latest version：從 Docker Hub `twentycrm/twenty` 查詢

---

## 相關程式碼位置

| 功能 | 檔案路徑 |
|------|---------|
| 版本檢查（後端） | `packages/twenty-server/src/engine/core-modules/graphql/hooks/use-graphql-error-handler.hook.ts` |
| 版本不匹配處理（前端） | `packages/twenty-front/src/modules/apollo/services/apollo.factory.ts` |
| Admin Panel 版本 API | `packages/twenty-server/src/engine/core-modules/admin-panel/admin-panel.service.ts` |
| Changelog 頁面 | `packages/twenty-front/src/pages/settings/releases/components/SettingsReleasesChangelogContent.tsx` |
| Version Info 頁面 | `packages/twenty-front/src/pages/settings/releases/components/SettingsReleasesVersionInfoContent.tsx` |

---

## 重要提醒

### ❌ 沒有自動更新

Twenty 沒有自動更新機制，不會自動下載新版本。

### ❌ 沒有強制更新

版本不匹配時只會提示用戶刷新頁面，不會強制更新。

### ✅ 部署後用戶刷新即可

你 deploy 新版本後，用戶只需要刷新頁面就能使用新版本。

---

## 未來可優化項目

1. **Changelog 改為 superAdmin 專屬**：一般用戶不需要看到 Twenty 官方的更新日誌
2. **自訂版本查詢**：修改 `admin-panel.service.ts` 查詢 `ycrm/y-crm` 而非 `twentycrm/twenty`
3. **自訂 Changelog API**：建立自己的 release notes API

---

## 版本號建議

建議使用 [Semantic Versioning](https://semver.org/)：

- **MAJOR**：不相容的 API 變更
- **MINOR**：向下相容的功能新增
- **PATCH**：向下相容的問題修正

範例：`1.0.0` → `1.1.0` → `1.1.1` → `2.0.0`
