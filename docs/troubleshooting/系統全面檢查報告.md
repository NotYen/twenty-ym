# Twenty CRM ç³»çµ±å…¨é¢æª¢æŸ¥å ±å‘Š

ç”Ÿæˆæ™‚é–“: 2025-10-22 10:23 AM

---

## âœ… æœå‹™é‹è¡Œç‹€æ…‹

| æœå‹™ | ç‹€æ…‹ | ç«¯å£ | é€²ç¨‹æ•¸ |
|------|------|------|--------|
| PostgreSQL | âœ… é‹è¡Œä¸­ | 5432 | 1 |
| Redis | âœ… é‹è¡Œä¸­ | 6379 | 1 |
| å¾Œç«¯ API | âœ… é‹è¡Œä¸­ | 8867 | 1 |
| å‰ç«¯ | âœ… é‹è¡Œä¸­ | 8866 | 1 |
| Worker | âœ… é‹è¡Œä¸­ | - | 2 |

**âœ… æ‰€æœ‰æ ¸å¿ƒæœå‹™éƒ½åœ¨æ­£å¸¸é‹è¡Œï¼**

---

## ğŸ”§ Worker é€²ç¨‹è©³æƒ…

| é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| **PID** | 6131 | Worker ä¸»é€²ç¨‹ |
| **é‹è¡Œæ™‚é–“** | 1åˆ†32ç§’ | å¾ 10:21 AM å•Ÿå‹• |
| **ç‹€æ…‹** | âœ… å¥åº· | ç„¡å´©æ½°æˆ–éŒ¯èª¤ |
| **å‘½ä»¤** | `node dist/src/queue-worker/queue-worker.js` | ä½¿ç”¨ç·¨è­¯å¾Œçš„ä»£ç¢¼ |

---

## ğŸ“… Cron Jobs åŸ·è¡Œç‹€æ…‹

### WorkflowCronTriggerCronJobï¼ˆWorkflow èª¿åº¦å™¨ï¼‰
- âœ… **æ¯åˆ†é˜åŸ·è¡Œä¸€æ¬¡** (`* * * * *`)
- âœ… **æœ€è¿‘åŸ·è¡Œæ™‚é–“**: 10:22 AM, 10:23 AM
- âœ… **åŸ·è¡Œé€Ÿåº¦**: 8-16msï¼ˆéå¸¸å¿«ï¼‰
- âœ… **ç„¡éŒ¯èª¤**

### å…¶ä»–ç³»çµ± Cron Jobs
- âœ… MessagingMessageListFetchCronJob
- âœ… MessagingMessagesImportCronJob
- âœ… CalendarEventsImportCronJob
- âœ… CalendarEventListFetchCronJob
- âœ… CronTriggerCronJob
- âœ… WorkflowRunEnqueueJob
- âœ… WorkflowHandleStaledRunsJob
- âœ… WorkflowCleanWorkflowRunsJob
- âœ… CleanOnboardingWorkspacesJob
- âœ… CleanSuspendedWorkspacesJob
- âœ… CheckPublicDomainsValidRecordsCronJob
- âœ… MessagingOngoingStaleCronJob
- âœ… CalendarOngoingStaleCronJob

**âœ… æ‰€æœ‰ Cron Jobs éƒ½å·²æ­£ç¢ºè¨»å†Šä¸¦åœ¨ Redis ä¸­ï¼**

---

## ğŸ¯ æ‚¨çš„ Workflow Schedule ç‹€æ…‹

### Workflow Cron è§¸ç™¼å™¨
- âœ… **è¨»å†Šç‹€æ…‹**: å·²è¨»å†Šåˆ° Redis
- âœ… **åŸ·è¡Œé »ç‡**: æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
- âœ… **æœ€è¿‘åŸ·è¡Œ**: 
  - 10:22:00 AM (è€—æ™‚ 16.02ms)
  - 10:23:00 AM (è€—æ™‚ 8.62ms)
- âœ… **æŸ¥è©¢çš„ Workspace**: 2 å€‹
  - `workspace_3vglbabhzpqb7liexnitusr4m`
  - `workspace_1wgvd1injqtife6y4rvfbu3h5`

### åŸ·è¡Œé‚è¼¯
Worker æ¯åˆ†é˜éƒ½æœƒæŸ¥è©¢æ‚¨çš„å…©å€‹ Workspace ä¸­çš„ Cron é¡å‹ Workflowï¼š
```sql
SELECT * FROM workspace_{id}."workflowAutomatedTrigger" WHERE type = 'CRON'
```

**âœ… Workflow èª¿åº¦å™¨æ­£å¸¸åŸ·è¡Œï¼Œæ²’æœ‰ä»»ä½•å•é¡Œï¼**

---

## ğŸš¨ ç™¼ç¾çš„å•é¡Œ

### âš ï¸ å•é¡Œ 1: 2FA ä¿®æ”¹ä¸å®Œæ•´

**å•é¡Œæè¿°**:
æ‚¨åªä¿®æ”¹äº†ç¬¬ 123 è¡Œï¼Œä½†ç¬¬ 133 è¡Œé‚„æ²’æœ‰ä¿®æ”¹ï¼

**æºä»£ç¢¼ç‹€æ…‹**:
```typescript
// âœ… ç¬¬ 123 è¡Œ - å·²ä¿®æ”¹
const issuer = `YMCRM${workspaceDisplayName ? ` - ${workspaceDisplayName}` : ''}`;

// âŒ ç¬¬ 133 è¡Œ - æœªä¿®æ”¹ï¼ˆé‚„æ˜¯ Twentyï¼‰
`Twenty${workspaceDisplayName ? ` - ${workspaceDisplayName}` : ''}`,
```

**å½±éŸ¿**:
- é‡ç”¨ç¾æœ‰ pending method æ™‚æœƒä½¿ç”¨ "YMCRM"
- ä½†å‰µå»ºæ–° method æ™‚é‚„æ˜¯æœƒä½¿ç”¨ "Twenty"
- Google Authenticator é¡¯ç¤ºçš„åç¨±å¯èƒ½ä¸ä¸€è‡´

**è§£æ±ºæ–¹æ¡ˆ**:
éœ€è¦åŒæ™‚ä¿®æ”¹ç¬¬ 133 è¡Œï¼š
```typescript
// ä¿®æ”¹å‰
`Twenty${workspaceDisplayName ? ` - ${workspaceDisplayName}` : ''}`,

// ä¿®æ”¹å¾Œ
`YMCRM${workspaceDisplayName ? ` - ${workspaceDisplayName}` : ''}`,
```

---

## âœ… æ­£å¸¸çš„éƒ¨åˆ†

### 1. Worker æ—¥èªŒåˆ†æ
- âœ… ç„¡éŒ¯èª¤æ—¥èªŒ
- âœ… ç„¡ç•°å¸¸æ—¥èªŒ
- âœ… æ‰€æœ‰ Cron Job éƒ½æˆåŠŸè™•ç†
- âœ… æ•¸æ“šåº«æŸ¥è©¢æ­£å¸¸åŸ·è¡Œ

### 2. Redis é€£æ¥
- âœ… BullMQ æ­£å¸¸é€£æ¥
- âœ… Cron èª¿åº¦æ­£å¸¸
- âœ… éšŠåˆ—è™•ç†æ­£å¸¸

### 3. æ•¸æ“šåº«é€£æ¥
- âœ… PostgreSQL é€£æ¥æ­£å¸¸
- âœ… æŸ¥è©¢åŸ·è¡ŒæˆåŠŸ
- âœ… å¤š Workspace æŸ¥è©¢æ­£å¸¸

### 4. å‰ç«¯è¨ªå•
- âœ… HTTP 200 ç‹€æ…‹ç¢¼
- âœ… å¯ä»¥æ­£å¸¸è¨ªå•

---

## ğŸ“Š ç³»çµ±æ€§èƒ½æŒ‡æ¨™

### Worker è™•ç†é€Ÿåº¦
| Cron Job | å¹³å‡è€—æ™‚ |
|----------|----------|
| WorkflowCronTriggerCronJob | 8-16ms |
| MessagingMessagesImportCronJob | 8-29ms |
| CalendarEventsImportCronJob | 6-18ms |
| CronTriggerCronJob | 6-15ms |

**âœ… æ‰€æœ‰ Job è™•ç†é€Ÿåº¦éƒ½éå¸¸å¿«ï¼**

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

### 1. ä¿®å¾© 2FA ä»£ç¢¼ï¼ˆé‡è¦ï¼‰
```bash
# ç·¨è¼¯æ–‡ä»¶ï¼Œä¿®æ”¹ç¬¬ 133 è¡Œ
code packages/twenty-server/src/engine/core-modules/two-factor-authentication/two-factor-authentication.service.ts

# é‡æ–° Build
npx nx run twenty-server:build --skip-nx-cache

# é‡å•Ÿå¾Œç«¯å’Œ Worker
bash stop-twenty-local.sh
bash start_all_service_start.sh
```

### 2. é©—è­‰ Workflow Schedule
å¦‚æœæ‚¨çš„ Workflow è¨­ç½®æ˜¯ï¼š
- **Schedule for workflow**: `0 */1 * * *` â†’ æ¯å°æ™‚çš„ 0 åˆ†åŸ·è¡Œï¼ˆ11:00, 12:00, 13:00...ï¼‰
- **Schedule for n8n**: `0 */2 * * *` â†’ æ¯ 2 å°æ™‚çš„ 0 åˆ†åŸ·è¡Œï¼ˆ12:00, 14:00, 16:00...ï¼‰

é‚£éº¼ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“æ˜¯ï¼š
- **Schedule for workflow**: **11:00 AM**
- **Schedule for n8n**: **12:00 PM**ï¼ˆå¦‚æœä¸Šæ¬¡æ˜¯ 10:00 AMï¼‰

### 3. ç›£æ§å»ºè­°
```bash
# å¯¦æ™‚ç›£æ§ Worker æ—¥èªŒ
tail -f twenty_worker.log

# æª¢æŸ¥ Workflow æ˜¯å¦è§¸ç™¼
grep "WorkflowTriggerJob" twenty_worker.log

# æª¢æŸ¥æ˜¯å¦æœ‰éƒµä»¶ç™¼é€
grep -i "email\|send" twenty_worker.log
```

---

## âœ… ç¸½çµ

| é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| **æ‰€æœ‰æœå‹™** | âœ… æ­£å¸¸ | PostgreSQL, Redis, å¾Œç«¯, å‰ç«¯, Worker |
| **Worker å¥åº·** | âœ… æ­£å¸¸ | é‹è¡Œä¸­ï¼Œç„¡éŒ¯èª¤ |
| **Cron Jobs** | âœ… æ­£å¸¸ | å·²è¨»å†Šï¼Œæ¯åˆ†é˜åŸ·è¡Œ |
| **Workflow èª¿åº¦** | âœ… æ­£å¸¸ | æ¯åˆ†é˜æª¢æŸ¥ Workflow è§¸ç™¼æ¢ä»¶ |
| **æ•¸æ“šåº«é€£æ¥** | âœ… æ­£å¸¸ | æŸ¥è©¢æ­£å¸¸åŸ·è¡Œ |
| **Redis é€£æ¥** | âœ… æ­£å¸¸ | BullMQ æ­£å¸¸å·¥ä½œ |
| **2FA ä¿®æ”¹** | âš ï¸ ä¸å®Œæ•´ | ç¬¬ 133 è¡Œéœ€è¦ä¿®æ”¹ |

**ç³»çµ±æ•´é«”é‹è¡Œæ­£å¸¸ï¼Œåªéœ€è¦å®Œæˆ 2FA ä¿®æ”¹ï¼** ğŸ‰

---

## ğŸ’¡ ç‚ºä»€éº¼æ‚¨å¯èƒ½é‚„æ²’æ”¶åˆ°éƒµä»¶

### åŸå› åˆ†æ
1. **Cron æ™‚é–“æ ¼å¼**: `0 */1 * * *` è¡¨ç¤ºæ¯å°æ™‚çš„ç¬¬ 0 åˆ†é˜åŸ·è¡Œ
   - **ä¸æ˜¯**æ¯éš” 1 å°æ™‚åŸ·è¡Œ
   - **è€Œæ˜¯**åœ¨ 11:00, 12:00, 13:00... é€™äº›æ•´é»åŸ·è¡Œ

2. **ç•¶å‰æ™‚é–“**: 10:23 AM
   - ä¸Šæ¬¡åŸ·è¡Œ: 10:00 AM
   - ä¸‹æ¬¡åŸ·è¡Œ: **11:00 AM**

3. **Worker å‰›é‡å•Ÿ**: 10:21 AM æ‰å•Ÿå‹•
   - å¦‚æœä¸Šæ¬¡ 10:00 AM çš„ Workflow é‚„æ²’å®Œæˆï¼Œå¯èƒ½æœƒè¢«è·³é

### é©—è­‰æ–¹å¼
ç­‰åˆ° **11:00 AM**ï¼Œç„¶å¾Œæª¢æŸ¥ï¼š
```bash
# æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„ WorkflowRun è¢«å‰µå»º
grep "WorkflowTriggerJob" twenty_worker.log | tail -20

# æª¢æŸ¥æ˜¯å¦æœ‰éƒµä»¶ç™¼é€
grep -i "send.*email" twenty_worker.log | tail -10
```

å¦‚æœ 11:00 é‚„æ˜¯æ²’æœ‰æ”¶åˆ°ï¼Œè«‹å‘Šè¨´æˆ‘ï¼Œæˆ‘æœƒé€²ä¸€æ­¥è¨ºæ–·ï¼
