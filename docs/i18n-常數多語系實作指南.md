# 常數多語系實作指南：工廠函數模式

本文件說明如何在 Twenty CRM 專案中，對常數檔案中的顯示文字實作多語系支援。

---

## 問題背景

在 React 專案中使用 Lingui 進行多語系翻譯時，`t` 函數必須在 React 元件或 Hook 內部使用，因為它依賴 React Context。

然而，許多常數檔案（如下拉選單選項）在模組載入時就被執行，此時 React 尚未渲染，無法存取翻譯 Context。

### 錯誤示範

```ts
// ❌ 這樣不行 - 常數在模組載入時就被評估
import { useLingui } from '@lingui/react/macro';

const { t } = useLingui(); // 錯誤！Hook 不能在元件外使用

export const OPTIONS = [
  { value: 'A', label: t`Option A` },  // t 函數不存在
];
```

---

## 解決方案：工廠函數模式

將常數改為**工廠函數**，在元件內呼叫時傳入翻譯後的字串。

### 實作步驟

#### 步驟 1：將常數改為工廠函數

**修改前：**

```ts
// constants/MyOptions.ts
export const MY_OPTIONS = [
  { value: 'AND', label: 'And' },
  { value: 'OR', label: 'Or' },
];
```

**修改後：**

```ts
// constants/MyOptions.ts
export const getMyOptions = (andLabel: string, orLabel: string) => [
  { value: 'AND', label: andLabel },
  { value: 'OR', label: orLabel },
];
```

#### 步驟 2：在元件中使用翻譯函數呼叫

**修改前：**

```tsx
// components/MyComponent.tsx
import { MY_OPTIONS } from '../constants/MyOptions';

export const MyComponent = () => {
  return <Select options={MY_OPTIONS} />;
};
```

**修改後：**

```tsx
// components/MyComponent.tsx
import { getMyOptions } from '../constants/MyOptions';
import { useLingui } from '@lingui/react/macro';

export const MyComponent = () => {
  const { t } = useLingui();

  return <Select options={getMyOptions(t`And`, t`Or`)} />;
};
```

---

## 實際案例：進階篩選邏輯運算子

### 檔案結構

```
packages/twenty-front/src/modules/object-record/advanced-filter/
├── constants/
│   └── AdvancedFilterLogicalOperatorOptions.ts  ← 工廠函數
├── components/
│   ├── AdvancedFilterLogicalOperatorDropdown.tsx  ← 使用工廠函數
│   └── AdvancedFilterLogicalOperatorCell.tsx      ← 使用工廠函數
└── command-menu/components/
    └── AdvancedFilterCommandMenuLogicalOperatorCell.tsx  ← 使用工廠函數
```

### 常數檔案

```ts
// AdvancedFilterLogicalOperatorOptions.ts
import { RecordFilterGroupLogicalOperator } from 'twenty-shared/types';

export const getAdvancedFilterLogicalOperatorOptions = (
  andLabel: string,
  orLabel: string,
) => [
  {
    value: RecordFilterGroupLogicalOperator.AND,
    label: andLabel,
  },
  {
    value: RecordFilterGroupLogicalOperator.OR,
    label: orLabel,
  },
];
```

### 元件使用

```tsx
// AdvancedFilterLogicalOperatorDropdown.tsx
import { getAdvancedFilterLogicalOperatorOptions } from '../constants/AdvancedFilterLogicalOperatorOptions';
import { useLingui } from '@lingui/react/macro';

export const AdvancedFilterLogicalOperatorDropdown = () => {
  const { t } = useLingui();

  return (
    <Select
      options={getAdvancedFilterLogicalOperatorOptions(t`And`, t`Or`)}
      // ...其他 props
    />
  );
};
```

---

## 為什麼不直接修改 Enum？

`RecordFilterGroupLogicalOperator` 等 Enum 定義在 `twenty-shared` 套件中，被前後端共用。

| 層級 | 內容 | 是否翻譯 |
|-----|------|---------|
| **Enum 值** | `'AND'`, `'OR'` | ❌ 不翻譯（程式邏輯用） |
| **顯示 Label** | `'And'`, `'Or'` | ✅ 翻譯（使用者看到） |

Enum 值用於：
- 資料庫儲存
- GraphQL API 請求/回應
- 程式邏輯判斷

如果翻譯 Enum 值，會導致資料不一致。

---

## 其他解決方案比較

| 方案 | 優點 | 缺點 |
|-----|-----|-----|
| **工廠函數** | 簡單、型別安全、易讀 | 每次呼叫建立新陣列 |
| **`msg` + `i18n._`** | 常數只定義一次 | 語法較複雜 |
| **元件內定義** | 最直接 | 無法跨元件重用 |

### 使用 `msg` 的替代寫法

```ts
// constants 檔案
import { msg } from '@lingui/core/macro';

export const OPTIONS = [
  {
    value: 'AND',
    labelMsg: msg`And`,  // 只標記，不翻譯
  },
];

// 元件內
import { useLingui } from '@lingui/react';

const MyComponent = () => {
  const { i18n } = useLingui();

  const translatedOptions = OPTIONS.map(opt => ({
    ...opt,
    label: i18n._(opt.labelMsg),  // 在這裡翻譯
  }));
};
```

---

## 命名慣例

| 原本命名 | 工廠函數命名 |
|---------|------------|
| `MY_OPTIONS` | `getMyOptions()` |
| `FILTER_OPTIONS` | `getFilterOptions()` |
| `ADVANCED_FILTER_LOGICAL_OPERATOR_OPTIONS` | `getAdvancedFilterLogicalOperatorOptions()` |

---

## 注意事項

1. **效能考量**：工廠函數每次呼叫都會建立新陣列，對於大多數 UI 場景影響不大。如有效能疑慮，可使用 `useMemo`：

   ```tsx
   const options = useMemo(
     () => getMyOptions(t`And`, t`Or`),
     [t]
   );
   ```

2. **型別定義**：如果需要匯出型別，可以這樣寫：

   ```ts
   export type MyOption = ReturnType<typeof getMyOptions>[number];
   ```

3. **提取翻譯字串**：修改完成後，執行以下命令提取翻譯字串：

   ```bash
   npx nx run twenty-front:lingui:extract
   ```

---

## 相關檔案

- 常數定義：`packages/twenty-front/src/modules/object-record/advanced-filter/constants/`
- Lingui 設定：`packages/twenty-front/lingui.config.ts`
- 翻譯檔案：`packages/twenty-front/src/locales/`

---

## 參考資源

- [Lingui 官方文件](https://lingui.dev/)
- [Twenty CRM 前端元件文件](./前端元件文件.md)
