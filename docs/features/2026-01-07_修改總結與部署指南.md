# 2026-01-07 修改總結與部署指南

## 一、本次修改內容

### 修改 1：報價單計算邏輯修正

**問題**：計算邏輯錯誤，原本監聽「總計」計算「稅額」

**修正後**：監聽「小計」和「稅率」→ 計算「稅額」和「總計」

**公式**：
```
稅額 = 小計 × 稅率
總計 = 小計 + 稅額
```

**修改檔案**：
| 檔案 | 說明 |
|------|------|
| `SalesQuoteTaxCalculationEffect.tsx` | 報價單詳情頁計算 |
| `SalesQuoteTaxCalculationRowEffect.tsx` | 報價單列表頁計算 |
| `usePersistField.ts` | 欄位儲存時計算 |

---

### 修改 2：isLabelSyncedWithName 驗證錯誤

**問題**：在「設定 > 數據模型」修改報價單欄位設定時出現「更新後的欄位名稱與標籤不同步」錯誤

**根本原因**：
- 報價單欄位使用中文拼音命名（如 `zongJi`），但 label 是英文（如 `Total`）
- 資料庫中 `isLabelSyncedWithName = true`，但實際上應該是 `false`

**解決方案**：用 SQL 修正現有資料庫中的 `isLabelSyncedWithName = false`

**影響範圍**：
- ✅ 新建 workspace 會自動正確（程式碼會計算 `isLabelSyncedWithName = false`）
- ⚠️ 現有 workspace 需要 SQL 修正

---

### 修改 3：刪除確認彈窗顯示不完全

**問題**：Side Panel 內的「選項 → 刪除」彈窗被裁切，顯示不完全

**解決方案**：
1. 根據 `actionMenuType` 動態設定 `ignoreContainer`
2. 修改 `Modal` 組件，當 `ignoreContainer = true` 時 portal 到 `document.body`
3. 修改 `ConfirmationModal` 組件，接收並傳遞 `ignoreContainer` 屬性

**修改檔案**：
| 檔案 | 說明 |
|------|------|
| `ActionModal.tsx` | 根據 actionMenuType 設定 ignoreContainer |
| `ConfirmationModal.tsx` | 新增 ignoreContainer 屬性 |
| `Modal.tsx` | ignoreContainer=true 時 portal 到 document.body |

**邏輯**：
| 位置 | actionMenuType | ignoreContainer | 效果 |
|------|---------------|-----------------|------|
| 右上角刪除按鈕 | `show-page-action-menu` | `false` | 維持原樣 |
| 右下角選項→刪除 | `command-menu-show-page-action-menu-dropdown` | `true` | portal 到 body，完整顯示 |

---

## 二、部署到 AWS 後需要手動執行的操作

### 2.1 SQL 修正（必須執行）

**原因**：AWS 現有 workspace 的 `isLabelSyncedWithName` 需要修正

```bash
# 1. SSH 連線到 AWS
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@52.195.151.185

# 2. 進入 postgres 容器
docker exec -it Y-CRM-postgres psql -U postgres -d default
```

```sql
-- 執行 SQL 修正
UPDATE core."fieldMetadata"
SET "isLabelSyncedWithName" = false
WHERE "objectMetadataId" IN (
  SELECT id FROM core."objectMetadata"
  WHERE "nameSingular" IN ('salesQuote', 'salesQuoteLineItem')
)
AND name IN (
  'zongJi', 'xiaoJi', 'shuiLu', 'shuiJin',
  'baoJiaDanHao', 'baoJiaDanZhuangTai', 'baoJiaRiQi', 'beiZhu',
  'jiaoYiTiaoJian', 'jieZhiRiQi', 'mingCheng', 'fuZeYeWu',
  'baoJiaDanXiXiangMiaoShu', 'chanPinMingCheng', 'danJia', 'jinE', 'shuLiang', 'zheKou',
  'baoJiaDanGuanLian'
)
AND "isLabelSyncedWithName" = true;

-- 確認修正結果
SELECT COUNT(*) FROM core."fieldMetadata" fm
JOIN core."objectMetadata" om ON fm."objectMetadataId" = om.id
WHERE om."nameSingular" IN ('salesQuote', 'salesQuoteLineItem')
AND fm."isLabelSyncedWithName" = true
AND fm.name IN (
  'zongJi', 'xiaoJi', 'shuiLu', 'shuiJin',
  'baoJiaDanHao', 'baoJiaDanZhuangTai', 'baoJiaRiQi', 'beiZhu',
  'jiaoYiTiaoJian', 'jieZhiRiQi', 'mingCheng', 'fuZeYeWu',
  'baoJiaDanXiXiangMiaoShu', 'chanPinMingCheng', 'danJia', 'jinE', 'shuLiang', 'zheKou',
  'baoJiaDanGuanLian'
);
-- 應該返回 0
```

### 2.2 清除 Redis Cache + 重新註冊 CRON Jobs

**原因**：SQL 修正後需要清除 cache 讓新資料生效

```bash
# 清除 Redis cache
docker exec Y-CRM-redis redis-cli FLUSHALL

# 重啟服務
docker compose -f docker-compose.aws.yml restart backend worker

# 等待服務啟動
sleep 10

# 重新註冊 CRON jobs
docker compose -f docker-compose.aws.yml exec backend yarn command:prod cron:register:all

# 驗證 CRON jobs 註冊成功
docker exec Y-CRM-redis redis-cli KEYS 'bull:cron-queue:repeat:*' | wc -l
# 應該要有數字（不是 0）
```

---

## 三、部署檢查清單

### 部署前
- [ ] 本地 build 成功
- [ ] 本地測試報價單計算邏輯正確
- [ ] 本地測試數據模型欄位設定不再報錯
- [ ] 本地測試刪除確認彈窗完整顯示

### 部署後
- [ ] 執行 SQL 修正 `isLabelSyncedWithName`
- [ ] 清除 Redis cache
- [ ] 重啟 backend 和 worker
- [ ] 重新註冊 CRON jobs
- [ ] 驗證 CRON jobs 數量正確

### 功能驗證
- [ ] 報價單計算邏輯正確（修改小計/稅率 → 自動計算稅額和總計）
- [ ] 數據模型欄位設定正常（不再出現驗證錯誤）
- [ ] Side Panel 刪除確認彈窗完整顯示
- [ ] 右上角刪除按鈕彈窗維持原樣

---

## 四、總結

| 修改項目 | 類型 | 部署後需手動操作 |
|---------|------|-----------------|
| 報價單計算邏輯 | 前端程式碼 | ❌ 不需要 |
| isLabelSyncedWithName | 資料庫資料 | ✅ 需要 SQL 修正 |
| 刪除確認彈窗 | 前端程式碼 | ❌ 不需要 |

**結論**：部署後只需要執行一次 SQL 修正 + 清除 cache + 重新註冊 CRON jobs，之後新建的 workspace 都會自動正確。
