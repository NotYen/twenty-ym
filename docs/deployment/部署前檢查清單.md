# 部署到 AWS 前的檢查清單

**日期**: 2026-01-27
**目的**: 確保本地修改不會破壞 AWS 環境

## 重要說明

### ✅ 不會影響 AWS 的修改
- 資料庫 schema 變更（ALTER TABLE, ADD COLUMN 等）
- 資料更新（UPDATE, INSERT 等）
- 本地設定檔修改

### ⚠️ 會影響 AWS 的修改
- 程式碼邏輯變更
- API 端點變更
- 環境變數變更

## 本次修改內容

### 1. 程式碼修改（會被部署）

| 檔案 | 修改內容 | 影響範圍 | 風險等級 |
|------|---------|---------|---------|
| useObjectMetadataItem.ts | 外部分享連結錯誤處理 | 只影響外部分享 | 🟢 低 |
| 其他前端檔案 | 效能優化和錯誤處理 | 一般使用 | 🟢 低 |

### 2. 資料庫修改（不會被部署）

| 資料表 | 修改內容 | 影響 |
|--------|---------|------|
| person | 新增 LINE 整合欄位 | ❌ 不會影響 AWS |
| opportunity | 新增欄位 | ❌ 不會影響 AWS |
| company | 新增 searchVector | ❌ 不會影響 AWS |
| 其他 | 欄位屬性修正 | ❌ 不會影響 AWS |

## 部署前檢查步驟

### Step 1: 本地測試

- [ ] 測試公司列表頁面
- [ ] 測試人員列表頁面
- [ ] 測試商機列表頁面
- [ ] 測試任務列表頁面
- [ ] 測試外部分享連結
- [ ] 測試登入功能
- [ ] 測試切換工作區

### Step 2: 檢查修改的檔案

```bash
# 查看所有修改的檔案
git status

# 查看具體修改內容
git diff
```

### Step 3: 確認不會影響 AWS 資料庫

**重要**：Docker image 不包含資料庫資料！

```
Docker Image 包含：
✅ 程式碼
✅ 設定檔
✅ 編譯後的檔案

Docker Image 不包含：
❌ 資料庫資料
❌ 資料庫 schema
❌ Redis 資料
```

### Step 4: 部署流程

```bash
# 1. 在本地 build image
cd docker/dev-flow/aws
./build-amd64-images.sh

# 2. 推送到 Docker Hub（或 AWS ECR）
docker push your-registry/y-crm-backend:latest
docker push your-registry/y-crm-frontend:latest

# 3. 在 AWS 上拉取新 image
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@52.195.151.185
docker compose -f docker-compose.aws.yml pull
docker compose -f docker-compose.aws.yml up -d

# 4. 檢查服務狀態
docker compose -f docker-compose.aws.yml ps
docker compose -f docker-compose.aws.yml logs -f backend
```

### Step 5: 部署後驗證

- [ ] 檢查 AWS 服務是否正常運行
- [ ] 測試 AWS 環境的登入功能
- [ ] 檢查 AWS 資料庫是否完整
- [ ] 驗證 CRON jobs 是否正常

## 回滾計畫

如果部署後發現問題：

```bash
# 1. 回滾到舊版本 image
docker compose -f docker-compose.aws.yml down
docker compose -f docker-compose.aws.yml up -d --force-recreate

# 2. 或使用之前的 image tag
docker compose -f docker-compose.aws.yml pull backend:previous-tag
docker compose -f docker-compose.aws.yml up -d
```

## 常見問題

### Q1: 本地新增的資料庫欄位會影響 AWS 嗎？
**A**: 不會。資料庫 schema 是獨立的，不會被 Docker image 包含。

### Q2: 如果 AWS 缺少某些欄位會怎樣？
**A**: 如果程式碼查詢了不存在的欄位，會報錯。但我們的修改都是新增欄位，不會刪除欄位，所以不會影響 AWS。

### Q3: 程式碼修改會影響 AWS 嗎？
**A**: 會。但我們的修改都是錯誤處理和效能優化，不會破壞現有功能。

### Q4: 如何確保 AWS 環境安全？
**A**:
1. 先在本地完整測試
2. 部署前備份 AWS 資料庫
3. 部署時先在測試環境驗證
4. 準備好回滾計畫

## 本次部署的安全性評估

### 🟢 低風險修改
- 外部分享連結錯誤處理
- 前端效能優化
- 錯誤訊息改善

### 🟡 中風險修改
- 無

### 🔴 高風險修改
- 無

## 結論

✅ **本次修改可以安全部署到 AWS**

原因：
1. 主要是錯誤處理和效能優化
2. 沒有破壞性的變更
3. 資料庫修改不會被部署
4. 有完整的測試和回滾計畫
