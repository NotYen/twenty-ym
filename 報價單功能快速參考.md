# 報價單功能快速參考

## 📊 對象結構一覽表

### Quote（報價單）對象

| 字段名稱 | 類型 | 中文標籤 | 必填 | 說明 |
|---------|------|---------|------|------|
| `quoteNumber` | TEXT | 報價單編號 | ✅ | Q-2025-001 |
| `title` | TEXT | 標題 | ✅ | 專案或報價名稱 |
| `company` | RELATION | 客戶公司 | ✅ | → Company |
| `contact` | RELATION | 聯絡人 | ❌ | → Person |
| `opportunity` | RELATION | 關聯商機 | ❌ | → Opportunity |
| `issueDate` | DATE | 開立日期 | ✅ | 報價日期 |
| `validUntil` | DATE | 有效期限 | ✅ | 過期日期 |
| `subtotal` | CURRENCY | 小計 | ✅ | 未稅金額 |
| `taxRate` | NUMBER | 稅率(%) | ❌ | 例如：5 |
| `taxAmount` | CURRENCY | 稅金 | ❌ | 計算值 |
| `total` | CURRENCY | 總計 | ✅ | 含稅總額 |
| `status` | SELECT | 狀態 | ✅ | 見下方選項 |
| `terms` | TEXT | 條款說明 | ❌ | 付款條件等 |
| `notes` | TEXT | 備註 | ❌ | 其他說明 |
| `lineItems` | RELATION | 報價項目 | 自動 | ← QuoteLineItem |

**Status 選項：**
- `DRAFT` (草稿) - 灰色
- `SENT` (已發送) - 藍色
- `ACCEPTED` (已接受) - 綠色
- `REJECTED` (已拒絕) - 紅色
- `EXPIRED` (已過期) - 橙色

---

### QuoteLineItem（報價項目）對象

| 字段名稱 | 類型 | 中文標籤 | 必填 | 說明 |
|---------|------|---------|------|------|
| `quote` | RELATION | 所屬報價單 | ✅ | → Quote |
| `productName` | TEXT | 產品名稱 | ✅ | 產品或服務 |
| `description` | TEXT | 描述 | ❌ | 詳細說明 |
| `quantity` | NUMBER | 數量 | ✅ | 默認：1 |
| `unitPrice` | CURRENCY | 單價 | ✅ | 單位價格 |
| `discount` | NUMBER | 折扣(%) | ❌ | 0-100 |
| `amount` | CURRENCY | 金額 | ✅ | 計算結果 |
| `position` | POSITION | 排序 | ✅ | 自動管理 |

**金額計算公式：**
```
amount = quantity × unitPrice × (1 - discount/100)
```

---

## 🗂️ 已創建的代碼文件

### 文件結構
```
packages/twenty-front/src/modules/action-menu/actions/record-actions/single-record/quote-actions/
├── components/
│   └── ExportQuoteToPdfAction.tsx      # 導出按鈕組件
├── templates/
│   └── QuotePDFTemplate.tsx            # PDF 模板
└── utils/
    └── exportQuoteToPdf.ts             # 導出邏輯

packages/twenty-front/src/modules/action-menu/actions/record-actions/constants/
└── QuoteActionsConfig.tsx              # Action 配置

packages/twenty-front/src/modules/action-menu/actions/utils/
└── getActionConfig.ts                  # 系統整合（已修改）
```

### 文件說明

#### 1. QuotePDFTemplate.tsx
**作用**：定義 PDF 的視覺外觀和佈局
**包含**：
- 報價單頭部（標題、編號）
- 客戶信息區域
- 明細表格（產品、數量、單價、金額）
- 總計區域（小計、稅金、總計）
- 條款說明和備註
- 頁尾信息

**可自定義**：
- 顏色方案
- 字體大小
- 佈局間距
- 添加公司 Logo
- 多語言支持

#### 2. exportQuoteToPdf.ts
**作用**：處理 PDF 生成和下載
**功能**：
- 接收 Quote 和 LineItems 數據
- 調用 PDF 模板渲染
- 生成 PDF Blob
- 觸發瀏覽器下載

#### 3. ExportQuoteToPdfAction.tsx
**作用**：UI 按鈕組件
**功能**：
- 從 Recoil state 獲取當前 Quote 記錄
- 查詢關聯的 QuoteLineItem 記錄
- 點擊時觸發 PDF 導出
- 錯誤處理

#### 4. QuoteActionsConfig.tsx
**作用**：按鈕配置
**定義**：
- 按鈕標籤：「Export as PDF」
- 按鈕圖標：IconFileTypePdf
- 顯示位置：詳情頁和列表頁
- 權限要求：無特殊要求

#### 5. getActionConfig.ts（已修改）
**作用**：將 Quote 的 Action 整合到系統
**修改內容**：
- 導入 QUOTE_ACTIONS_CONFIG
- 在 switch 中添加 quote case
- 合併默認 Action 和 Quote 專屬 Action

---

## 🚀 快速啟動步驟

### **最簡化流程（15分鐘完成）**

**1. UI 操作（10分鐘）**
```bash
□ Settings → Objects → + New Object
  └─ 創建 Quote 對象
  └─ 添加 14 個字段

□ Settings → Objects → + New Object
  └─ 創建 QuoteLineItem 對象
  └─ 添加 7 個字段
```

**2. 編譯代碼（3分鐘）**
```bash
cd /Users/ym/twenty-ym
npx nx build twenty-front
# 或
npx nx start twenty-front
```

**3. 測試功能（2分鐘）**
```bash
□ 創建一個測試報價單
□ 添加 2-3 個項目
□ 點擊「Export as PDF」
□ 檢查下載的 PDF
```

---

## 📋 字段創建速查表

### Quote 對象字段（按順序）

| # | Field Name | Type | Label | Required | Icon |
|---|-----------|------|-------|----------|------|
| 1 | quoteNumber | Text | 報價單編號 | ✅ | IconHash |
| 2 | title | Text | 標題 | ✅ | IconFileText |
| 3 | company | Relation | 客戶公司 | ✅ | IconBuildingSkyscraper |
| 4 | contact | Relation | 聯絡人 | ❌ | IconUser |
| 5 | opportunity | Relation | 關聯商機 | ❌ | IconTargetArrow |
| 6 | issueDate | Date | 開立日期 | ✅ | IconCalendar |
| 7 | validUntil | Date | 有效期限 | ✅ | IconCalendarEvent |
| 8 | subtotal | Currency | 小計 | ✅ | IconCurrencyDollar |
| 9 | taxRate | Number | 稅率(%) | ❌ | IconPercentage |
| 10 | taxAmount | Currency | 稅金 | ❌ | IconCurrencyDollar |
| 11 | total | Currency | 總計 | ✅ | IconCurrencyDollar |
| 12 | status | Select | 狀態 | ✅ | IconProgressCheck |
| 13 | terms | Text | 條款說明 | ❌ | IconFileText |
| 14 | notes | Text | 備註 | ❌ | IconNotes |

### QuoteLineItem 對象字段（按順序）

| # | Field Name | Type | Label | Required | Icon |
|---|-----------|------|-------|----------|------|
| 1 | quote | Relation | 所屬報價單 | ✅ | IconFileInvoice |
| 2 | productName | Text | 產品名稱 | ✅ | IconBox |
| 3 | description | Text | 描述 | ❌ | IconFileText |
| 4 | quantity | Number | 數量 | ✅ | IconNumbers |
| 5 | unitPrice | Currency | 單價 | ✅ | IconCurrencyDollar |
| 6 | discount | Number | 折扣(%) | ❌ | IconPercentage |
| 7 | amount | Currency | 金額 | ✅ | IconCurrencyDollar |

---

## 🎨 PDF 樣式預覽

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│  報價單 QUOTATION                                   │
│  編號 No.：Q-2025-001                              │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  客戶信息 Customer Information                      │
│  公司名稱：ABC Technology Co., Ltd.                │
│  聯絡人：張小明                                     │
│  開立日期：2025-10-22                              │
│  有效期限：2025-11-22                              │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  報價項目 Quote Items                               │
│  網站開發專案                                       │
│                                                     │
│  ┌────────────┬──────┬──────────┬──────────┐     │
│  │ 產品/服務  │ 數量 │   單價   │   金額   │     │
│  ├────────────┼──────┼──────────┼──────────┤     │
│  │ 首頁設計   │  1   │ $5,000   │ $5,000   │     │
│  │ 內頁開發   │  10  │   $800   │ $8,000   │     │
│  │ 後台系統   │  1   │ $3,000   │ $3,000   │     │
│  └────────────┴──────┴──────────┴──────────┘     │
│                                                     │
│                          小計 Subtotal： $16,000   │
│                         稅金 Tax (5%)：    $800   │
│                         ─────────────────────────  │
│                          總計 Total：   $16,800   │
│                                                     │
├─────────────────────────────────────────────────────┤
│  條款說明 Terms & Conditions                        │
│  付款條件：簽約時30%，完成時70%                     │
│  交付時間：8-10週                                   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## ⚡ 命令速查

```bash
# 重新編譯前端
npx nx build twenty-front

# 啟動開發服務器
npx nx start twenty-front

# 檢查 linter 錯誤
npx nx lint twenty-front

# 清除緩存
rm -rf packages/twenty-front/node_modules/.vite
rm -rf packages/twenty-front/dist

# 查看服務器日誌
tail -f twenty.log
```

---

## 🔗 關聯對象關係圖

```
Company (公司)
    │
    ├─── Person (聯絡人)
    │       │
    │       └─── Opportunity (商機)
    │               │
    │               └─── Quote (報價單) ◄── 您創建的對象
    │                       │
    │                       └─── QuoteLineItem (報價項目) ◄── 您創建的對象
    │
    └─── Quote (直接關聯)
```

---

## ✅ 完成檢查清單

### 階段一：UI 創建（必須手動完成）
- [ ] 1. 創建 Quote 對象
- [ ] 2. 添加 Quote 的 14 個字段
- [ ] 3. 創建 QuoteLineItem 對象
- [ ] 4. 添加 QuoteLineItem 的 7 個字段
- [ ] 5. 確認反向關聯字段存在

### 階段二：代碼部署（已自動完成）
- [✅] 1. PDF 模板組件
- [✅] 2. PDF 導出工具
- [✅] 3. 導出 Action 組件
- [✅] 4. Action 配置文件
- [✅] 5. 系統整合

### 階段三：編譯測試（需執行）
- [ ] 1. 重新編譯前端
- [ ] 2. 刷新瀏覽器
- [ ] 3. 創建測試報價單
- [ ] 4. 測試 PDF 導出

---

## 🎯 預期結果

完成後，您將擁有：

1. **左側菜單新增項目**
   ```
   Objects
   ├── Companies
   ├── People
   ├── Opportunities
   ├── Tasks
   ├── Notes
   └── Quotes ◄── 新增
   ```

2. **報價單詳情頁操作菜單**
   ```
   ⋮ (操作菜單)
   ├── Add to favorites
   ├── Export as PDF ◄── 新增
   ├── Export (CSV)
   └── Delete
   ```

3. **PDF 導出效果**
   - 專業格式的報價單 PDF
   - 包含公司信息、項目明細、金額計算
   - 可直接發送給客戶

---

## 💼 使用場景示例

### **場景 1：銷售人員制作報價**
```
1. 在 Opportunity 中找到商機
2. 點擊「Create Quote」
3. 自動帶入公司和聯絡人
4. 添加產品項目
5. 導出 PDF 發送給客戶
6. 追蹤狀態變化
```

### **場景 2：產品經理審查報價**
```
1. 進入 Quotes 列表
2. 篩選「草稿」狀態
3. 檢查每個報價單內容
4. 批准或要求修改
```

### **場景 3：財務統計分析**
```
1. 創建 Dashboard
2. 添加圖表 Widget
3. 數據源：Quotes
4. 統計：
   - 本月報價總額
   - 接受率
   - 平均成交金額
```

---

## 🔧 常見自定義需求

### **1. 添加審批流程**
```yaml
添加字段：
- approver: RELATION → WorkspaceMember (審批人)
- approvedAt: DateTime (審批時間)
- approvalNotes: Text (審批意見)

添加 Workflow：
- 觸發：status 變更為 SENT
- 條件：total > $10,000
- 動作：通知審批人
```

### **2. 自動編號生成**
```typescript
// 使用 Workflow + Code Action
const generateQuoteNumber = async () => {
  const year = new Date().getFullYear();
  const month = String(new Date().getMonth() + 1).padStart(2, '0');
  const count = await getQuoteCountThisMonth();
  return `Q-${year}-${month}-${String(count + 1).padStart(3, '0')}`;
};
```

### **3. 多貨幣支持**
```yaml
添加字段到 Quote：
- currency: Select (USD, TWD, EUR, JPY, CNY...)
- exchangeRate: Number (匯率)
```

### **4. 報價單版本控制**
```yaml
添加字段：
- version: Number (版本號)
- baseQuote: Relation → Quote (基礎版本)
- isLatestVersion: Boolean
```

---

## 📞 技術支持

### **如果遇到問題：**

1. **對象創建失敗**
   - 檢查對象名稱是否符合規範（小寫、無空格）
   - 確認必填字段都有默認值

2. **關聯字段配置錯誤**
   - 確認關聯類型選擇正確（Many to One / One to Many）
   - 檢查目標對象是否存在

3. **PDF 導出按鈕不顯示**
   - 確認對象名稱是 'quote'（API Name Singular）
   - 重新編譯前端
   - 清除瀏覽器緩存

4. **PDF 內容不正確**
   - 檢查字段名稱是否匹配代碼
   - 查看瀏覽器控制台錯誤
   - 確認數據已正確保存

---

## 📈 後續優化建議

### **短期（1-2週）**
- [ ] 添加報價單編號自動生成
- [ ] 實現金額自動計算
- [ ] 添加公司 Logo 到 PDF
- [ ] 支持多種 PDF 模板

### **中期（1個月）**
- [ ] 整合審批流程
- [ ] 添加電子簽名
- [ ] 實現報價轉訂單
- [ ] 郵件自動發送

### **長期（3個月）**
- [ ] 客戶自助門戶（查看報價單）
- [ ] 線上接受/拒絕報價
- [ ] 報價歷史版本比對
- [ ] AI 輔助報價建議

---

**祝您實作順利！有任何問題歡迎隨時詢問。** 🎉

