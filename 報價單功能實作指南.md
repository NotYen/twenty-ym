# Twenty CRM 報價單功能實作指南

## 📋 目錄
1. [功能概述](#功能概述)
2. [第一階段：UI 操作創建對象](#第一階段ui-操作創建對象)
3. [第二階段：代碼開發](#第二階段代碼開發)
4. [第三階段：測試與使用](#第三階段測試與使用)
5. [進階功能擴展](#進階功能擴展)

---

## 🎯 功能概述

本指南將教您如何在 Twenty CRM 中實作完整的報價單功能，包括：
- ✅ 報價單主記錄管理
- ✅ 報價單明細項目管理
- ✅ 自動計算金額
- ✅ PDF 格式報價單導出
- ✅ 完整的工作流程支持

**完成後的效果：**
- 在左側菜單會出現「Quotes」（報價單）選項
- 可以創建和管理報價單
- 每個報價單可以添加多個項目（產品/服務）
- 點擊報價單詳情頁的「Export as PDF」按鈕即可下載專業的 PDF 報價單

---

## 🖱️ 第一階段：UI 操作創建對象

### **步驟 1：創建 Quote（報價單）對象**

#### 1.1 進入對象管理介面
```
1. 登入 Twenty CRM
2. 點擊右上角 Settings（齒輪圖標）
3. 左側菜單選擇「Objects」
4. 點擊右上角「+ New Object」按鈕
```

#### 1.2 填寫對象基本信息
```yaml
Label (Singular): 報價單
Label (Plural): 報價單
API Name (Singular): quote          # 自動生成，可自定義
API Name (Plural): quotes            # 自動生成，可自定義
Icon: 選擇 IconFileInvoice 或 IconFileText
Description: 管理客戶報價單和提案
```

點擊「Create」創建對象。

---

### **步驟 2：為 Quote 添加字段**

創建完成後，會自動進入對象詳情頁。點擊「Fields」標籤，然後點擊「+ Add Field」添加以下字段：

#### 2.1 基本信息字段

**字段 1：報價單編號**
```yaml
點擊「+ Add Field」
選擇類型: Text
Field name: quoteNumber
Label: 報價單編號
Description: 唯一識別編號，例如：Q-2025-001
Icon: IconHash
Required: ✅ 勾選
```

**字段 2：報價單標題**
```yaml
點擊「+ Add Field」
選擇類型: Text
Field name: title
Label: 標題
Description: 報價單主題或專案名稱
Icon: IconFileText
Required: ✅ 勾選
```

#### 2.2 日期字段

**字段 3：開立日期**
```yaml
選擇類型: Date
Field name: issueDate
Label: 開立日期
Icon: IconCalendar
Required: ✅ 勾選
Default value: Today
```

**字段 4：有效期限**
```yaml
選擇類型: Date
Field name: validUntil
Label: 有效期限
Icon: IconCalendarEvent
Required: ✅ 勾選
```

#### 2.3 關聯字段

**字段 5：客戶公司**
```yaml
選擇類型: Relation
Field name: company
Label: 客戶公司
Icon: IconBuildingSkyscraper
Relation type: Many to One
Related object: Company (公司)
Required: ✅ 勾選
```

**字段 6：聯絡人**
```yaml
選擇類型: Relation
Field name: contact
Label: 聯絡人
Icon: IconUser
Relation type: Many to One
Related object: Person (人員)
Required: ❌ 不勾選
```

**字段 7：關聯商機**
```yaml
選擇類型: Relation
Field name: opportunity
Label: 關聯商機
Icon: IconTargetArrow
Relation type: Many to One
Related object: Opportunity (商機)
Required: ❌ 不勾選
```

#### 2.4 金額字段

**字段 8：小計**
```yaml
選擇類型: Currency
Field name: subtotal
Label: 小計
Icon: IconCurrencyDollar
Required: ✅ 勾選
Default currency: USD 或 TWD
```

**字段 9：稅率**
```yaml
選擇類型: Number
Field name: taxRate
Label: 稅率(%)
Icon: IconPercentage
Required: ❌ 不勾選
```

**字段 10：稅金**
```yaml
選擇類型: Currency
Field name: taxAmount
Label: 稅金
Icon: IconCurrencyDollar
Required: ❌ 不勾選
```

**字段 11：總計**
```yaml
選擇類型: Currency
Field name: total
Label: 總計
Icon: IconCurrencyDollar
Required: ✅ 勾選
```

#### 2.5 狀態和備註字段

**字段 12：狀態**
```yaml
選擇類型: Select
Field name: status
Label: 狀態
Icon: IconProgressCheck
Required: ✅ 勾選

選項配置：
1. Value: DRAFT    | Label: 草稿      | Color: 灰色
2. Value: SENT     | Label: 已發送    | Color: 藍色
3. Value: ACCEPTED | Label: 已接受    | Color: 綠色
4. Value: REJECTED | Label: 已拒絕    | Color: 紅色
5. Value: EXPIRED  | Label: 已過期    | Color: 橙色

Default value: DRAFT
```

**字段 13：條款說明**
```yaml
選擇類型: Text
Field name: terms
Label: 條款說明
Icon: IconFileText
Required: ❌ 不勾選
```

**字段 14：備註**
```yaml
選擇類型: Text
Field name: notes
Label: 備註
Icon: IconNotes
Required: ❌ 不勾選
```

---

### **步驟 3：創建 QuoteLineItem（報價項目）對象**

#### 3.1 創建對象
```
返回 Settings → Objects → 點擊「+ New Object」

Label (Singular): 報價項目
Label (Plural): 報價項目
API Name (Singular): quoteLineItem
API Name (Plural): quoteLineItems
Icon: IconList
Description: 報價單的明細項目
```

#### 3.2 添加字段

**字段 1：所屬報價單（關聯）**
```yaml
選擇類型: Relation
Field name: quote
Label: 所屬報價單
Icon: IconFileInvoice
Relation type: Many to One
Related object: Quote (報價單)
Required: ✅ 勾選
```

**字段 2：產品名稱**
```yaml
選擇類型: Text
Field name: productName
Label: 產品名稱
Icon: IconBox
Required: ✅ 勾選
```

**字段 3：描述**
```yaml
選擇類型: Text
Field name: description
Label: 描述
Icon: IconFileText
Required: ❌ 不勾選
```

**字段 4：數量**
```yaml
選擇類型: Number
Field name: quantity
Label: 數量
Icon: IconNumbers
Required: ✅ 勾選
Default value: 1
```

**字段 5：單價**
```yaml
選擇類型: Currency
Field name: unitPrice
Label: 單價
Icon: IconCurrencyDollar
Required: ✅ 勾選
```

**字段 6：折扣**
```yaml
選擇類型: Number
Field name: discount
Label: 折扣(%)
Icon: IconPercentage
Required: ❌ 不勾選
Default value: 0
```

**字段 7：金額**
```yaml
選擇類型: Currency
Field name: amount
Label: 金額
Icon: IconCurrencyDollar
Required: ✅ 勾選
```

---

## 💻 第二階段：代碼開發

### ✅ **已完成的代碼文件**

我已經為您創建了以下文件（無需手動操作）：

**1. PDF 模板組件**
```
packages/twenty-front/src/modules/action-menu/actions/record-actions/single-record/quote-actions/templates/QuotePDFTemplate.tsx
```
- 定義 PDF 的視覺樣式和佈局
- 支持完整的報價單格式（頭部、客戶信息、明細表格、總計）
- 包含中文和英文標籤

**2. PDF 導出工具函數**
```
packages/twenty-front/src/modules/action-menu/actions/record-actions/single-record/quote-actions/utils/exportQuoteToPdf.ts
```
- 處理 PDF 生成和下載邏輯
- 自動處理文件命名

**3. 導出 Action 組件**
```
packages/twenty-front/src/modules/action-menu/actions/record-actions/single-record/quote-actions/components/ExportQuoteToPdfAction.tsx
```
- 從數據庫獲取 Quote 和 LineItems 數據
- 觸發 PDF 導出

**4. Action 配置文件**
```
packages/twenty-front/src/modules/action-menu/actions/record-actions/constants/QuoteActionsConfig.tsx
```
- 定義「Export as PDF」按鈕的配置
- 設置按鈕圖標、標籤、位置等

**5. 系統整合**
```
packages/twenty-front/src/modules/action-menu/actions/utils/getActionConfig.ts (已修改)
```
- 將 Quote 對象的 Action 配置整合到系統中

### **代碼狀態：✅ 無錯誤，可直接使用**

---

## 🚀 第三階段：編譯和測試

### **步驟 7：重新編譯前端**

在終端執行以下命令：

```bash
# 進入項目根目錄
cd /Users/ym/twenty-ym

# 重新編譯前端
npx nx build twenty-front

# 或者重啟開發服務器
npx nx start twenty-front
```

---

## 🧪 第四階段：測試與使用

### **步驟 8：創建第一個報價單**

#### 8.1 創建報價單主記錄
```
1. 左側菜單應該會出現「Quotes」（報價單）
2. 點擊進入報價單列表頁
3. 點擊「+ New」創建新報價單
4. 填寫必要信息：
   - 報價單編號：Q-2025-001
   - 標題：網站開發專案報價
   - 客戶公司：選擇一個現有公司
   - 開立日期：今天
   - 有效期限：30 天後
   - 狀態：草稿
   - 小計：0（稍後自動計算）
   - 總計：0（稍後自動計算）
```

#### 8.2 添加報價項目
```
1. 進入剛創建的報價單詳情頁
2. 找到「Quote Line Items」標籤或關聯區域
3. 點擊「+ Add」添加項目：

項目 1：
- 產品名稱：網站首頁設計
- 描述：響應式首頁設計，包含5個區塊
- 數量：1
- 單價：$5,000
- 金額：$5,000

項目 2：
- 產品名稱：內頁設計與開發
- 描述：10個內頁的設計和前端開發
- 數量：10
- 單價：$800
- 金額：$8,000

項目 3：
- 產品名稱：後台管理系統
- 描述：CMS內容管理後台
- 數量：1
- 單價：$3,000
- 金額：$3,000
```

#### 8.3 更新報價單總計
```
返回報價單主記錄，更新：
- 小計：$16,000
- 稅率：5%
- 稅金：$800
- 總計：$16,800
- 條款說明：付款條件：簽約時支付30%，完成時支付70%
```

#### 8.4 導出 PDF
```
1. 在報價單詳情頁
2. 點擊右上角的「⋮」（三個點）菜單
3. 應該會看到「Export as PDF」選項
4. 點擊後會自動下載 PDF 文件
```

---

## 🎨 第五階段：自定義和優化

### **可選優化 1：添加公司 Logo**

修改 PDF 模板，添加公司 Logo：

```typescript
// 在 QuotePDFTemplate.tsx 的 header 部分添加
<View style={styles.header}>
  <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>
    <View>
      <Text style={styles.title}>報價單 QUOTATION</Text>
      <Text style={styles.quoteNumber}>編號 No.：{quote.quoteNumber}</Text>
    </View>
    <Image 
      src="https://your-company-logo-url.com/logo.png" 
      style={{ width: 100, height: 40 }}
    />
  </View>
</View>
```

### **可選優化 2：自動生成報價單編號**

創建 Hook 來自動生成編號：

```typescript
// packages/twenty-front/src/modules/object-record/hooks/useGenerateQuoteNumber.ts

export const useGenerateQuoteNumber = () => {
  const generateQuoteNumber = async () => {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    
    // 查詢本月已有多少報價單
    // 生成格式：Q-2025-10-001
    const sequence = 1; // 需要從數據庫查詢
    
    return `Q-${year}-${month}-${String(sequence).padStart(3, '0')}`;
  };
  
  return { generateQuoteNumber };
};
```

### **可選優化 3：添加自動計算**

在創建/編輯報價項目時自動計算金額：

```typescript
// 在 QuoteLineItem 表單中添加
useEffect(() => {
  const calculatedAmount = quantity * unitPrice * (1 - (discount || 0) / 100);
  setFieldValue('amount', calculatedAmount);
}, [quantity, unitPrice, discount]);
```

### **可選優化 4：支持多語言 PDF**

修改模板以支持語言切換：

```typescript
const labels = {
  'zh-TW': {
    quotation: '報價單',
    customer: '客戶信息',
    // ...
  },
  'en': {
    quotation: 'QUOTATION',
    customer: 'Customer Information',
    // ...
  }
};

// 使用：labels[locale].quotation
```

---

## 🔧 常見問題解答

### Q1: 為什麼在操作菜單中看不到「Export as PDF」按鈕？

**可能原因：**
1. 前端沒有重新編譯 → 執行 `npx nx build twenty-front`
2. 對象名稱不是 'quote' → 檢查創建對象時的 API Name (Singular) 是否為 'quote'
3. 瀏覽器緩存 → 清除緩存或硬刷新（Ctrl+Shift+R）

### Q2: 導出 PDF 時出現錯誤？

**檢查項目：**
1. QuoteLineItem 的關聯字段名稱必須是 `quote`，且有對應的 `quoteId`
2. 確認 Quote 記錄中有必填字段的值
3. 檢查瀏覽器控制台的錯誤信息

### Q3: PDF 中的中文無法顯示？

**解決方案：**
需要註冊支持中文的字體，修改 `QuotePDFTemplate.tsx`：

```typescript
Font.register({
  family: 'Noto Sans TC',
  src: 'https://fonts.gstatic.com/s/notosanstc/v26/-nF7OG829Oofr2wohFbTp9i9kwMUKo_IzGy7RsNP.ttf',
});

// 然後在 styles 中使用
const styles = StyleSheet.create({
  page: {
    fontFamily: 'Noto Sans TC',
    // ...
  }
});
```

### Q4: 如何自定義 PDF 樣式？

直接修改 `QuotePDFTemplate.tsx` 中的 `styles` StyleSheet 對象：
- 調整顏色、字體大小、邊距等
- 添加更多欄位
- 調整表格布局

### Q5: 能否導出為 Excel 或 Word？

目前只實現了 PDF 導出。如需其他格式：
- **Excel**：使用 `xlsx` 庫
- **Word**：使用 `docx` 庫
- 可以參考現有的 CSV 導出功能實現

---

## 📊 功能架構圖

```
報價單系統架構
│
├── 數據層
│   ├── Quote (報價單主記錄)
│   │   ├── 基本信息 (編號、標題、日期)
│   │   ├── 關聯信息 (公司、聯絡人、商機)
│   │   ├── 金額信息 (小計、稅金、總計)
│   │   └── 狀態管理 (草稿/已發送/已接受等)
│   │
│   └── QuoteLineItem (報價項目)
│       ├── 產品信息 (名稱、描述)
│       ├── 數量定價 (數量、單價、折扣)
│       └── 計算金額
│
├── 展示層
│   ├── 列表頁面 (所有報價單)
│   ├── 詳情頁面 (單個報價單 + 項目列表)
│   └── 表單頁面 (創建/編輯)
│
└── 導出層
    ├── PDF 模板 (QuotePDFTemplate.tsx)
    ├── 導出邏輯 (exportQuoteToPdf.ts)
    └── UI 觸發器 (ExportQuoteToPdfAction.tsx)
```

---

## 🎓 進階功能擴展

### **擴展 1：報價單版本控制**

添加字段：
- `version`：版本號（Number）
- `previousVersion`：前一版本（Relation to Quote）

### **擴展 2：電子簽名**

添加字段：
- `customerSignature`：客戶簽名（Text 或 File）
- `signedAt`：簽署日期（DateTime）
- `signedBy`：簽署人（Relation to Person）

### **擴展 3：自動化工作流**

使用 Twenty 的 Workflow 功能：
1. **觸發器**：當 Quote.status 變更為 "SENT"
2. **動作**：自動發送郵件給客戶（附帶 PDF）
3. **觸發器**：當 validUntil 到期
4. **動作**：自動更新 status 為 "EXPIRED"

### **擴展 4：報價單模板**

創建 QuoteTemplate 對象：
- 預設的產品/服務項目
- 預設的條款說明
- 快速創建報價單

### **擴展 5：報價轉訂單**

添加功能：
- 當 Quote.status 變為 "ACCEPTED"
- 一鍵轉換為 Order 對象
- 自動帶入所有項目

---

## 📝 完整的使用流程示例

### **場景：為客戶製作網站開發報價**

**第 1 步：從商機創建報價單**
```
1. 進入 Opportunities（商機）
2. 找到「ABC 公司網站開發專案」
3. 進入商機詳情頁
4. 在 Related 區域找到 Quotes
5. 點擊「+ Add Quote」
```

**第 2 步：填寫報價單基本信息**
```
報價單編號：Q-2025-10-001
標題：ABC 公司網站開發專案報價
客戶公司：ABC Company（自動帶入）
聯絡人：張小明（選擇）
開立日期：2025-10-22
有效期限：2025-11-22（30天）
狀態：草稿
```

**第 3 步：添加報價項目**
```
項目 1：首頁設計     | 1  | $5,000  | $5,000
項目 2：內頁開發     | 10 | $800    | $8,000
項目 3：後台管理系統 | 1  | $3,000  | $3,000
項目 4：測試部署     | 1  | $1,000  | $1,000
────────────────────────────────────────────
                      小計：         $17,000
                      稅金 (5%)：    $850
                      ══════════════════════
                      總計：         $17,850
```

**第 4 步：添加條款說明**
```
付款條件：
- 簽約時支付 30% ($5,355)
- 完成設計稿時支付 30% ($5,355)  
- 專案完成時支付 40% ($7,140)

交付時間：簽約後 8-10 週
保固期限：上線後 3 個月免費維護
```

**第 5 步：導出並發送**
```
1. 點擊「⋮」操作菜單
2. 選擇「Export as PDF」
3. 下載生成的 PDF 文件
4. 將狀態更新為「已發送」
5. 發送 PDF 給客戶
```

**第 6 步：追蹤狀態**
```
- 客戶收到 → 狀態：已發送
- 客戶接受 → 狀態：已接受 → 創建訂單/專案
- 客戶拒絕 → 狀態：已拒絕 → 更新商機狀態
- 逾期未回 → 狀態：已過期 → 發送提醒
```

---

## 🎯 完整功能檢查清單

### **UI 創建部分**（需手動操作）
- [ ] 創建 Quote 對象
- [ ] 添加 Quote 的所有字段（14個字段）
- [ ] 創建 QuoteLineItem 對象
- [ ] 添加 QuoteLineItem 的所有字段（7個字段）
- [ ] 確認 Quote 有反向關聯 lineItems 字段

### **代碼部分**（已自動完成）
- [✅] PDF 模板組件已創建
- [✅] PDF 導出工具已創建
- [✅] 導出 Action 組件已創建
- [✅] Action 配置已創建
- [✅] 系統整合已完成
- [✅] 無 Linter 錯誤

### **測試部分**（需執行）
- [ ] 重新編譯前端
- [ ] 創建測試用報價單
- [ ] 添加測試用報價項目
- [ ] 測試 PDF 導出功能
- [ ] 檢查 PDF 格式和內容

---

## 💡 重要提示

### **1. 對象名稱必須匹配**
代碼中使用的對象名稱為 `quote` 和 `quoteLineItem`，請確保在 UI 創建時使用相同的名稱（API Name Singular）。

### **2. 字段名稱必須匹配**
代碼中使用的字段名稱必須與 UI 創建的字段名稱完全一致：
- `quoteNumber`（不是 quote_number）
- `lineItems`（不是 line_items）
- `productName`（不是 product_name）

### **3. 關聯字段配置**
- QuoteLineItem 的 `quote` 字段必須配置為 Many to One
- 這會自動在 Quote 對象生成 `lineItems` 的 One to Many 反向關聯

### **4. 貨幣字段格式**
Twenty 的 Currency 字段使用 `amountMicros`（微單位），即：
- $1.00 = 1,000,000 micros
- 代碼中已自動處理轉換

---

## 🔍 故障排除

### **問題：編譯錯誤**
```bash
# 清除緩存重新編譯
rm -rf packages/twenty-front/node_modules/.vite
npx nx build twenty-front --skip-nx-cache
```

### **問題：找不到 QuoteLineItem 記錄**
檢查：
1. QuoteLineItem 的 `quote` 關聯字段是否正確配置
2. 是否有 `quoteId` join column
3. filter 條件是否正確：`{ quoteId: { eq: recordId } }`

### **問題：PDF 導出但內容為空**
檢查：
1. Quote 記錄是否有數據
2. 瀏覽器控制台是否有錯誤
3. lineItems 是否正確載入

---

## 📚 相關資源

### **Twenty 官方文檔**
- [Creating Custom Objects](https://twenty.com/developers/section/objects)
- [Adding Fields](https://twenty.com/developers/section/fields)
- [Relations](https://twenty.com/developers/section/relations)

### **使用的技術庫**
- [@react-pdf/renderer](https://react-pdf.org/) - PDF 生成
- [file-saver](https://github.com/eligrey/FileSaver.js/) - 文件下載
- [@blocknote/xl-pdf-exporter](https://www.blocknotejs.org/) - 富文本 PDF 導出

### **相關代碼參考**
- Note PDF 導出：`exportBlockNoteEditorToPdf.ts`
- CSV 導出：`useRecordIndexExportRecords.ts`
- Email 模板：`packages/twenty-emails/src/`

---

## ✨ 下一步

完成基本功能後，您可以：

1. **創建更多報價單模板**：常用的產品/服務組合
2. **整合到銷售流程**：Opportunity → Quote → Order
3. **添加審批流程**：使用 Workflow 實現報價單審批
4. **客戶自助門戶**：讓客戶可以線上查看和接受報價單
5. **數據分析**：使用 Dashboard 分析報價轉換率

---

## 📞 需要協助？

如果在實作過程中遇到問題：
1. 檢查瀏覽器控制台的錯誤信息
2. 查看 Twenty Server 的日誌
3. 確認對象和字段名稱是否正確
4. 參考本文檔的「故障排除」章節

祝您實作順利！🎉
