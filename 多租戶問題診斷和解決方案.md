# Twenty CRM 多租戶問題診斷和解決方案

## 問題描述

訪問 `http://118.168.188.27.nip.io:8866` 時，會跳轉到錯誤的 URL：
```
http://.118.168.188.27.nip.io:8866/welcome
```
注意域名前面多了一個點，導致無法正常訪問。

## 多租戶工作原理

### 1. 後端配置（ClientConfigService）

後端通過 `/client-config` API 返回以下關鍵配置：

```typescript
{
  frontDomain: this.domainManagerService.getFrontUrl().hostname,
  defaultSubdomain: this.twentyConfigService.get('DEFAULT_SUBDOMAIN'),
  isMultiWorkspaceEnabled: true
}
```

- **frontDomain**: 從 `FRONTEND_URL` 環境變數解析 hostname
  - 例如：`FRONTEND_URL=http://118.168.188.27.nip.io:8866`
  - 解析後：`frontDomain = "118.168.188.27.nip.io"`

- **defaultSubdomain**: 從環境變數獲取，你設置為 `"apple"`

### 2. 前端配置接收（useClientConfig）

前端從後端獲取配置後，設置到 Recoil state：

```typescript
setDomainConfiguration({
  defaultSubdomain: 'apple',
  frontDomain: '118.168.188.27.nip.io'
});
```

### 3. 默認域名構建（useReadDefaultDomainFromConfiguration）

當多租戶啟用時，默認域名構建規則：

```typescript
const defaultDomain = isMultiWorkspaceEnabled
  ? `${domainConfiguration.defaultSubdomain}.${domainConfiguration.frontDomain}`
  : domainConfiguration.frontDomain;

// 結果應該是：apple.118.168.188.27.nip.io
```

### 4. URL 重定向邏輯（WorkspaceProviderEffect）

當用戶訪問基礎域名（無子域名）時：

```typescript
// 1. 檢測當前是否在默認域名
const isDefaultDomain = (window.location.hostname === 'apple.118.168.188.27.nip.io');

// 2. 如果有最後認證的 workspace，重定向過去
if (isDefaultDomain && lastAuthenticatedWorkspaceDomain) {
  redirectToWorkspaceDomain(lastAuthenticatedWorkspaceDomain.workspaceUrl);
}

// 3. 如果訪問的域名與 workspace 不匹配，重定向到正確的 workspace
if (!isWorkspaceHostnameMatch) {
  redirectToWorkspaceDomain(getWorkspaceUrl(workspaceUrls));
}
```

### 5. Workspace URL 生成（Domain Manager Service）

後端生成 workspace URL 的邏輯：

```typescript
getWorkspaceUrls(workspace) {
  return {
    customUrl: workspace.isCustomDomainEnabled ? customDomain : undefined,
    subdomainUrl: getTwentyWorkspaceUrl(workspace.subdomain)
  };
}

getTwentyWorkspaceUrl(subdomain: string) {
  const url = this.getFrontUrl();
  url.hostname = isMultiWorkspaceEnabled 
    ? `${subdomain}.${url.hostname}` 
    : url.hostname;
  return url.toString();
}
```

## 問題根源分析

### 可能原因 1：frontDomain 解析錯誤

如果 `FRONTEND_URL` 沒有正確設置，`frontDomain` 可能為空：

```bash
# 錯誤配置
FRONTEND_URL=""  # frontDomain = ""

# 構建的默認域名
defaultDomain = "apple." + "" = "apple."

# 重定向 URL 變成
url.hostname = "apple."  # 瀏覽器處理為 ".118.168.188.27.nip.io"
```

### 可能原因 2：Workspace Subdomain 為空

數據庫中的 workspace subdomain 可能為空或不正確：

```sql
-- 如果 subdomain 是空字符串
SELECT subdomain FROM core.workspace;
-- 結果：""

-- 生成的 URL
subdomainUrl = "" + "." + "118.168.188.27.nip.io"
            = ".118.168.188.27.nip.io"
```

### 可能原因 3：環境變數未正確傳遞

啟動腳本中導出的環境變數可能沒有傳遞給 Node.js 進程。

## 解決方案

### 檢查 1：驗證環境變數

```bash
# 檢查配置
source ./twenty-config.sh --show

# 檢查進程環境變數
ps aux | grep "twenty-server" | head -1
```

### 檢查 2：驗證數據庫 Workspace

```bash
# 連接到 PostgreSQL
docker exec -it twenty-db psql -U postgres -d default

# 查詢 workspace 配置
SELECT id, subdomain, "displayName", "customDomain", "isCustomDomainEnabled" 
FROM core.workspace;

# 應該看到類似：
# id | subdomain | displayName | customDomain | isCustomDomainEnabled
# ---|-----------|-------------|--------------|----------------------
# ... | apple     | My Workspace| null         | false
```

### 檢查 3：測試後端配置 API

```bash
# 測試配置 API
curl http://118.168.188.27.nip.io:8867/client-config

# 檢查返回的 frontDomain 和 defaultSubdomain
```

## 完整診斷腳本

見下一個文件：`診斷並修復.sh`

