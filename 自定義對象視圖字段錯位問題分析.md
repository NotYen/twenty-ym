# 自定義對象視圖字段錯位問題 - 完整分析報告

## 🚨 嚴重性評估
- **影響範圍**：所有自定義對象
- **問題類型**：系統性 Bug
- **影響**：字段顯示錯位，數據對應錯誤
- **狀態**：已修復當前所有自定義對象

---

## 📋 問題描述

### 症狀
1. **SalesQuote 列表顯示錯誤**
   - `contact` 字段顯示空值
   - `status` 字段顯示貨幣金額
   - 其他字段也有錯位現象

2. **其他自定義對象也有相同問題**
   - Pet 對象
   - Survey Result 對象

### 根本原因

**Twenty CRM 在創建自定義對象時存在 Bug：**

1. **標準對象（Company, Person 等）**
   ```
   position 0: name 字段（主要標識字段）
   position 1-N: 其他字段
   ```

2. **自定義對象（SalesQuote, Pet 等）**
   ```
   ❌ 缺少 position 0
   ❌ name 字段被放在錯誤的位置或完全缺失
   position 1-N: 自定義字段
   ```

3. **導致的問題**
   - 前端期望 position 0 是第一個字段
   - 但自定義對象從 position 1 開始
   - **字段索引錯位**
   - 顯示的數據和字段標籤不匹配

---

## 🔍 技術分析

### 預期行為（來自源代碼）

在 `object-metadata-v2.service.ts` 中：

```typescript
private async createDefaultFlatViewFields({
  objectFlatFieldMetadatas,
  viewId,
  workspaceId,
}: {
  objectFlatFieldMetadatas: FlatFieldMetadata[];
  viewId: string;
  workspaceId: string;
}) {
  const defaultViewFields = objectFlatFieldMetadatas
    .filter((field) => field.name !== 'id' && field.name !== 'deletedAt')
    .map((field, index) =>
      fromCreateViewFieldInputToFlatViewFieldToCreate({
        createViewFieldInput: {
          fieldMetadataId: field.id,
          position: index,  // 應該從 0 開始，包含 name 字段
          isVisible: true,
          size: DEFAULT_VIEW_FIELD_SIZE,
          viewId: viewId,
        },
        workspaceId: workspaceId,
      }),
    );

  return defaultViewFields;
}
```

**預期**：name 字段應該在 position 0

### 實際行為

**對象創建時間線（以 SalesQuote 為例）**：

```
22:56:23 - SalesQuote 對象創建
         - 系統自動創建 13 個標準字段（包括 name）
         - 系統創建默認視圖 "All {objectLabelPlural}"
         - ❌ 但默認視圖中沒有包含任何字段

23:01-23:28 - 用戶手動添加自定義字段
            - quotenumber, title, issuedate, etc.
            - 這些字段被添加到視圖，但 position 從 1 開始

00:05-00:19 - 視圖字段被創建（次日）
            - ❌ name 字段不在視圖中
            - 自定義字段 position 從 1 開始
```

### 字段添加邏輯問題

在 `field-metadata-related-records.service.ts` 中：

```typescript
async createViewAndViewFields(
  createdFieldMetadatas: FieldMetadataEntity[],
  workspaceId: string,
) {
  const views = await this.viewService.findByWorkspaceId(workspaceId);

  for (const createdFieldMetadata of createdFieldMetadatas) {
    const objectViews = views.filter(
      (view) => view.objectMetadataId === createdFieldMetadata.objectMetadataId,
    );

    if (objectViews.length === 0) {
      return;
    }

    const indexView = objectViews.find((view) => view.key === ViewKey.INDEX);

    if (!indexView) {
      return;
    }
    
    const lastPosition = indexView.viewFields
      .map((viewField) => viewField.position)
      .reduce((acc, position) => {
        if (position > acc) {
          return position;
        }
        return acc;
      }, -1);  // ❌ 如果視圖為空，lastPosition = -1

    await this.viewFieldService.create({
      fieldMetadataId: createdFieldMetadata.id,
      position: lastPosition + 1,  // ❌ -1 + 1 = 0，但這不應該給第一個自定義字段
      isVisible,
      size: DEFAULT_VIEW_FIELD_SIZE,
      viewId: indexView.id,
      workspaceId: createdFieldMetadata.workspaceId,
    });
  }
}
```

**問題**：
1. 對象創建時，默認視圖可能是空的（沒有字段）
2. 第一個自定義字段被添加到 position 0（應該給 name 字段）
3. name 字段永遠不會被自動添加到視圖

---

## 🔧 已執行的修復

### 1. SalesQuote 修復

```sql
-- 添加 name 字段到視圖，position 0
INSERT INTO core."viewField" 
  ("fieldMetadataId", "position", "isVisible", "size", "viewId", "workspaceId", "createdAt", "updatedAt", "deletedAt") 
SELECT 
  f."id", 0, true, 180, v."id", v."workspaceId", NOW(), NOW(), NULL 
FROM core."fieldMetadata" f, core."view" v 
WHERE f."name" = 'name' 
  AND f."objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'salesquote') 
  AND v."objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'salesquote') 
  AND v."key" = 'INDEX';
```

### 2. Pet 修復

```sql
-- 將 name 字段移到 position 0
UPDATE core."viewField" 
SET "position" = 0 
WHERE "viewId" = (SELECT "id" FROM core."view" WHERE "objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'pet') AND "key" = 'INDEX') 
  AND "fieldMetadataId" = (SELECT "id" FROM core."fieldMetadata" WHERE "objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'pet') AND "name" = 'name');
```

### 3. SurveyResult 修復

```sql
-- 添加 name 字段到視圖，position 0
INSERT INTO core."viewField" 
  ("fieldMetadataId", "position", "isVisible", "size", "viewId", "workspaceId", "createdAt", "updatedAt", "deletedAt") 
SELECT 
  f."id", 0, true, 180, v."id", v."workspaceId", NOW(), NOW(), NULL 
FROM core."fieldMetadata" f, core."view" v 
WHERE f."name" = 'name' 
  AND f."objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'surveyResult') 
  AND v."objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'surveyResult') 
  AND v."key" = 'INDEX';
```

### 修復後驗證

```sql
SELECT 
  o."nameSingular", 
  COUNT(vf."id") as field_count, 
  MIN(vf."position") as min_position, 
  STRING_AGG(f."name" || '(' || vf."position" || ')', ', ' ORDER BY vf."position") as fields 
FROM core."objectMetadata" o 
JOIN core."view" v ON o."id" = v."objectMetadataId" 
LEFT JOIN core."viewField" vf ON v."id" = vf."viewId" 
LEFT JOIN core."fieldMetadata" f ON vf."fieldMetadataId" = f."id" 
WHERE o."isCustom" = true AND v."key" = 'INDEX' 
GROUP BY o."id", o."nameSingular" 
ORDER BY o."nameSingular";
```

**結果**：
```
nameSingular        | field_count | min_position | fields
--------------------|-------------|--------------|--------
pet                 | 2           | 0            | name(0), age(1)
rocket              | 0           |              | 
salesquote          | 16          | 0            | name(0), title(1), issuedate(2), ...
salesquotelineitem  | 0           |              | 
surveyResult        | 2           | 0            | name(0), score(1)
```

✅ **所有自定義對象的 name 字段現在都在 position 0**

---

## ✅ 正確的創建流程

### 方案 A：使用標準流程（推薦）

1. **創建對象**
   - 在 UI 中創建自定義對象
   - 系統自動創建標準字段（id, name, createdAt, etc.）

2. **立即檢查視圖配置**
   ```sql
   -- 檢查 name 字段是否在視圖中
   SELECT f."name", vf."position" 
   FROM core."viewField" vf 
   JOIN core."fieldMetadata" f ON vf."fieldMetadataId" = f."id" 
   WHERE vf."viewId" = (
     SELECT "id" FROM core."view" 
     WHERE "objectMetadataId" = (
       SELECT "id" FROM core."objectMetadata" 
       WHERE "nameSingular" = 'YOUR_OBJECT_NAME'
     ) AND "key" = 'INDEX'
   ) 
   ORDER BY vf."position";
   ```

3. **如果 name 字段缺失或不在 position 0，立即修復**
   ```sql
   -- 如果缺失，添加
   INSERT INTO core."viewField" 
     ("fieldMetadataId", "position", "isVisible", "size", "viewId", "workspaceId", "createdAt", "updatedAt") 
   SELECT 
     f."id", 0, true, 180, v."id", v."workspaceId", NOW(), NOW() 
   FROM core."fieldMetadata" f, core."view" v 
   WHERE f."name" = 'name' 
     AND f."objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'YOUR_OBJECT_NAME') 
     AND v."objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'YOUR_OBJECT_NAME') 
     AND v."key" = 'INDEX';
   
   -- 如果位置錯誤，更新
   UPDATE core."viewField" 
   SET "position" = 0 
   WHERE "viewId" = (SELECT "id" FROM core."view" WHERE "objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'YOUR_OBJECT_NAME') AND "key" = 'INDEX') 
     AND "fieldMetadataId" = (SELECT "id" FROM core."fieldMetadata" WHERE "objectMetadataId" = (SELECT "id" FROM core."objectMetadata" WHERE "nameSingular" = 'YOUR_OBJECT_NAME') AND "name" = 'name');
   ```

4. **添加自定義字段**
   - 在 UI 中添加所有需要的字段
   - 字段會自動添加到視圖

5. **重啟服務**
   ```bash
   ./stop-twenty-local.sh
   ./start_all_service_start.sh
   ```

### 方案 B：創建時一次性添加所有字段

1. **創建對象**
2. **立即添加所有自定義字段**（不要中斷）
3. **檢查視圖配置**
4. **重啟服務**

---

## 🚨 檢查清單（新對象創建後）

```bash
# 1. 檢查視圖字段配置
psql postgres://postgres:postgres@localhost:5432/default -c "
SELECT vf.\"position\", f.\"name\", f.\"label\", f.\"type\", vf.\"isVisible\" 
FROM core.\"viewField\" vf 
JOIN core.\"fieldMetadata\" f ON vf.\"fieldMetadataId\" = f.\"id\" 
WHERE vf.\"viewId\" = (
  SELECT \"id\" FROM core.\"view\" 
  WHERE \"objectMetadataId\" = (
    SELECT \"id\" FROM core.\"objectMetadata\" 
    WHERE \"nameSingular\" = 'YOUR_OBJECT_NAME'
  ) AND \"key\" = 'INDEX'
) 
ORDER BY vf.\"position\";
"
```

**檢查項目**：
- [ ] position 從 0 開始
- [ ] position 0 是 `name` 字段
- [ ] name 字段 isVisible = true
- [ ] 所有需要顯示的字段都在視圖中
- [ ] 沒有重複的 position

```bash
# 2. 檢查所有自定義對象
psql postgres://postgres:postgres@localhost:5432/default -c "
SELECT 
  o.\"nameSingular\", 
  COUNT(vf.\"id\") as field_count, 
  MIN(vf.\"position\") as min_position 
FROM core.\"objectMetadata\" o 
JOIN core.\"view\" v ON o.\"id\" = v.\"objectMetadataId\" 
LEFT JOIN core.\"viewField\" vf ON v.\"id\" = vf.\"viewId\" 
WHERE o.\"isCustom\" = true AND v.\"key\" = 'INDEX' 
GROUP BY o.\"id\", o.\"nameSingular\" 
HAVING COUNT(vf.\"id\") > 0 AND MIN(vf.\"position\") != 0 
ORDER BY o.\"nameSingular\";
"
```

**如果有結果，表示有對象的視圖配置錯誤**

---

## 📝 給用戶的說明

### 當前狀態
✅ **已修復所有現有自定義對象的視圖配置問題**

### 安全使用建議

1. **創建新對象後務必檢查**
   - 使用上面的 SQL 檢查清單
   - 確認 name 字段在 position 0
   - 確認字段顯示正確

2. **測試後再開放給用戶**
   - 創建測試數據
   - 檢查列表顯示是否正確
   - 檢查字段值是否對應

3. **遇到顯示錯位立即報告**
   - 不要繼續使用
   - 保留錯誤截圖
   - 立即使用 SQL 檢查視圖配置

### 長期解決方案

**這是 Twenty CRM 的系統性 Bug，需要上報給開源項目**

建議提交 Issue：
1. **標題**：Custom object view fields missing position 0 (name field)
2. **描述**：
   - 自定義對象創建後，默認視圖缺少 name 字段
   - 導致視圖字段 position 從 1 開始而不是 0
   - 前端渲染時字段錯位
3. **重現步驟**：
   - 創建自定義對象
   - 添加自定義字段
   - 查看列表視圖
   - 字段顯示錯位
4. **預期行為**：name 字段應該在 position 0
5. **實際行為**：name 字段缺失或位置錯誤

---

## 🔍 對比：標準對象 vs 自定義對象

### Company（標準對象）✅
```
position 0: name (Name) - TEXT
position 1: domainName (Domain Name) - LINKS
position 2: createdBy (Created by) - ACTOR
...
```

### SalesQuote（修復前）❌
```
position 1: title (title) - TEXT
position 2: issuedate (issueDate) - DATE
...
缺少 position 0
缺少 name 字段
```

### SalesQuote（修復後）✅
```
position 0: name (Name) - TEXT
position 1: title (title) - TEXT
position 2: issuedate (issueDate) - DATE
...
```

---

## 總結

1. **問題根源**：Twenty CRM 在創建自定義對象時未正確初始化默認視圖字段
2. **影響範圍**：所有自定義對象
3. **已修復**：SalesQuote, Pet, SurveyResult
4. **預防措施**：每次創建新對象後使用 SQL 檢查清單驗證
5. **長期方案**：等待 Twenty CRM 官方修復此 Bug

---

**文檔創建時間**：2025-10-25
**最後更新**：2025-10-25
**狀態**：已修復並記錄

