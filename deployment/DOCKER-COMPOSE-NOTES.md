# Docker Compose é…ç½®èªªæ˜

## ğŸ¯ è¨­è¨ˆåŸå‰‡

### 1. AWS Linux é©é…
- âœ… ä½¿ç”¨å®˜æ–¹ `twentycrm/twenty` æ˜ åƒï¼ˆç„¡éœ€æœ¬åœ°ç·¨è­¯ï¼‰
- âœ… æ‰€æœ‰è·¯å¾‘ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼ˆ`./data/`, `./logs/`ï¼‰
- âœ… ç«¯å£ç¶å®šåˆ° `127.0.0.1`ï¼ˆå®‰å…¨è€ƒé‡ï¼Œé€šé Nginx å°å¤–ï¼‰

### 2. æœå‹™æ¶æ§‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Nginx (ç«¯å£ 80/443)             â”‚  â† å°å¤–è¨ªå•å…¥å£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
  â”‚ Server  â”‚     â”‚  Frontend â”‚  â† Server æ˜ åƒåŒ…å«å‰ç«¯
  â”‚ (3000)  â”‚     â”‚  (éœæ…‹)    â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
  â”‚ Worker  â”‚  â† èƒŒæ™¯ä»»å‹™
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   DB    â”‚  Redis  â”‚  â† åŸºç¤æœå‹™
  â”‚ (5432)  â”‚ (6379)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. èˆ‡ç¾æœ‰è…³æœ¬çš„å°æ‡‰é—œä¿‚

| ç¾æœ‰è…³æœ¬æ­¥é©Ÿ | Docker Compose å°æ‡‰ |
|-------------|-------------------|
| å•Ÿå‹• PostgreSQL (brew) | `db` æœå‹™ |
| å•Ÿå‹• Redis (brew) | `redis` æœå‹™ |
| å•Ÿå‹•å¾Œç«¯ (nx) | `server` æœå‹™ |
| å•Ÿå‹•å‰ç«¯ (nx/serve) | åŒ…å«åœ¨ `server` æ˜ åƒä¸­ |
| å•Ÿå‹• Worker | `worker` æœå‹™ |
| æ•¸æ“šåº«é·ç§» | Server å•Ÿå‹•æ™‚è‡ªå‹•åŸ·è¡Œ |
| è¨»å†Š Cron Jobs | Server å•Ÿå‹•æ™‚è‡ªå‹•åŸ·è¡Œ |
| åŒæ­¥ Metadata | éœ€æ‰‹å‹•åŸ·è¡Œï¼ˆä¸€æ¬¡æ€§ï¼‰ |

## ğŸ”§ é—œéµé…ç½®è§£é‡‹

### ç«¯å£æ˜ å°„
```yaml
# ç¾æœ‰é…ç½® â†’ Docker é…ç½®
localhost:8866 (å‰ç«¯) â†’ é€šé Server çš„ 3000 ç«¯å£æä¾›
localhost:8867 (å¾Œç«¯) â†’ Server å®¹å™¨çš„ 3000 ç«¯å£
localhost:5432 (PG)   â†’ 127.0.0.1:5432 (åƒ…å…§éƒ¨)
localhost:6379 (Redis) â†’ 127.0.0.1:6379 (åƒ…å…§éƒ¨)
```

### ç’°å¢ƒè®Šæ•¸è®Šæ›´
```bash
# æœ¬åœ°é…ç½® â†’ Docker é…ç½®
localhost â†’ å®¹å™¨åç¨± (db, redis)

# ä¾‹å¦‚ï¼š
æœ¬åœ°: postgres://postgres:password@localhost:5432/default
Docker: postgres://postgres:password@db:5432/default
         â†‘ å®¹å™¨åç¨±æœƒè‡ªå‹•è§£æ
```

### æ•¸æ“šæŒä¹…åŒ–ç­–ç•¥
```
deployment/
â””â”€â”€ data/
    â”œâ”€â”€ postgres/          â† PostgreSQL æ•¸æ“šç›®éŒ„
    â”‚   â””â”€â”€ (è‡ªå‹•ç”Ÿæˆ)
    â”œâ”€â”€ redis/             â† Redis AOF æ–‡ä»¶
    â”‚   â””â”€â”€ appendonly.aof
    â””â”€â”€ server-storage/    â† ä¸Šå‚³æ–‡ä»¶
        â””â”€â”€ workspace-*/
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### 1. é¦–æ¬¡å•Ÿå‹•é †åº
```bash
# Docker Compose æœƒè‡ªå‹•è™•ç†å•Ÿå‹•é †åºï¼š
1. db, redis å…ˆå•Ÿå‹•ï¼ˆhealthcheckï¼‰
2. server å•Ÿå‹•ï¼ˆåŸ·è¡Œ migrationï¼‰
3. worker æœ€å¾Œå•Ÿå‹•
```

### 2. å‰ç«¯è¨ªå•æ–¹å¼
```
åœ¨ Twenty å®˜æ–¹æ¶æ§‹ä¸­ï¼š
- å‰ç«¯éœæ…‹æ–‡ä»¶æ‰“åŒ…åœ¨ Server æ˜ åƒçš„ dist/front/ ç›®éŒ„
- Server åŒæ™‚æä¾›ï¼š
  * /api/* â†’ å¾Œç«¯ API
  * /* â†’ å‰ç«¯éœæ…‹æ–‡ä»¶

æ‰€ä»¥åªéœ€è¦æš´éœ² Server çš„ 3000 ç«¯å£å³å¯ï¼
```

### 3. èˆ‡æœ¬åœ°ç’°å¢ƒçš„å·®ç•°

| é …ç›® | æœ¬åœ°ç’°å¢ƒ | Docker ç’°å¢ƒ |
|-----|---------|-----------|
| æ•¸æ“šåº«ä¸»æ©Ÿ | localhost | db |
| Redis ä¸»æ©Ÿ | localhost | redis |
| å‰ç«¯æœå‹™ | ç¨ç«‹ç«¯å£ 8866 | åŒ…å«åœ¨ Server |
| å¾Œç«¯ç«¯å£ | 8867 | 3000 (å®¹å™¨å…§) |
| ä¾è³´å®‰è£ | brew | Docker æ˜ åƒå·²åŒ…å« |

## ğŸš€ å•Ÿå‹•æµç¨‹

### å®Œæ•´å•Ÿå‹•å‘½ä»¤
```bash
# 1. é€²å…¥ç›®éŒ„
cd /path/to/deployment

# 2. å•Ÿå‹•æ‰€æœ‰æœå‹™
docker compose up -d

# 3. æŸ¥çœ‹å•Ÿå‹•ç‹€æ…‹
docker compose ps

# 4. æŸ¥çœ‹æ—¥èªŒ
docker compose logs -f

# 5. å¥åº·æª¢æŸ¥
docker compose exec server curl http://localhost:3000/healthz
```

### é æœŸè¼¸å‡º
```
NAME              IMAGE                     STATUS
twenty-db         postgres:16               Up (healthy)
twenty-redis      redis:7-alpine            Up (healthy)
twenty-server     twentycrm/twenty:latest   Up (healthy)
twenty-worker     twentycrm/twenty:latest   Up
```

## ğŸ” å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼ä¸åˆ†é–‹å‰å¾Œç«¯å®¹å™¨ï¼Ÿ
A: Twenty å®˜æ–¹ä½¿ç”¨å–®ä¸€æ˜ åƒæ¶æ§‹ï¼Œå‰ç«¯å·²æ‰“åŒ…åœ¨ Server æ˜ åƒä¸­ï¼Œé€™æ¨£éƒ¨ç½²æ›´ç°¡å–®ã€‚

### Q2: å¦‚ä½•è¨ªå•å‰ç«¯ï¼Ÿ
A: è¨ªå• Server çš„ç«¯å£å³å¯ï¼Œä¾‹å¦‚ http://your-ip:3000

### Q3: æ•¸æ“šåº«åœ¨å“ªè£¡ï¼Ÿ
A: `deployment/data/postgres/` ç›®éŒ„ï¼Œå¯ä»¥ç›´æ¥å‚™ä»½é€™å€‹ç›®éŒ„ã€‚

### Q4: å¦‚ä½•æ›´æ–°ç‰ˆæœ¬ï¼Ÿ
```bash
# ä¿®æ”¹ .env ä¸­çš„ TWENTY_VERSION
TWENTY_VERSION=v0.x.x

# æ‹‰å–æ–°æ˜ åƒä¸¦é‡å•Ÿ
docker compose pull
docker compose up -d
```

## ğŸ“Š è³‡æºä½¿ç”¨å»ºè­°

### AWS EC2 å¯¦ä¾‹è¦æ ¼
```yaml
æœ€å°é…ç½®:
  - t3.medium (2 vCPU, 4GB RAM)
  - é©åˆæ¸¬è©¦å’Œå°å‹éƒ¨ç½²

æ¨è–¦é…ç½®:
  - t3.large (2 vCPU, 8GB RAM)
  - é©åˆç”Ÿç”¢ç’°å¢ƒ

è³‡æºåˆ†é…å»ºè­°:
  - PostgreSQL: 1-2 GB RAM
  - Redis: 512 MB RAM
  - Server: 2-4 GB RAM
  - Worker: 1-2 GB RAM
```

### ç£ç¢Ÿç©ºé–“è¦åŠƒ
```
æ ¹ç£ç¢Ÿ (/) : 30 GB
  â”œâ”€â”€ OS å’Œç³»çµ±: ~10 GB
  â”œâ”€â”€ Docker æ˜ åƒ: ~5 GB
  â””â”€â”€ å…¶ä»–: ~15 GB

æ•¸æ“šç£ç¢Ÿ: 50+ GB
  â”œâ”€â”€ PostgreSQL: é ä¼°å¢é•·
  â”œâ”€â”€ Redis: é€šå¸¸ < 1 GB
  â””â”€â”€ ä¸Šå‚³æ–‡ä»¶: å–æ±ºæ–¼ä½¿ç”¨é‡
```

