#!/bin/bash
# ==========================================
# Twenty CRM æ›´æ–°è…³æœ¬ï¼ˆåœ¨ AWS ä¸ŠåŸ·è¡Œï¼‰
# ==========================================
# ç”¨æ–¼å¾ Docker Hub æ‹‰å–æ–°æ˜ åƒä¸¦æ›´æ–°æœå‹™
# ==========================================

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

echo "ğŸ”„ Twenty CRM æ›´æ–°è…³æœ¬"
echo "=========================================="
echo ""

# é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd "$PROJECT_DIR"

# ==========================================
# æ­¥é©Ÿ 1: ç¢ºèªæ“ä½œ
# ==========================================
echo "âš ï¸  æ­¤æ“ä½œå°‡æ›´æ–°æœå‹™åˆ°æœ€æ–°ç‰ˆæœ¬"
echo ""
read -p "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ(yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "âŒ æ“ä½œå·²å–æ¶ˆ"
    exit 0
fi

echo ""

# ==========================================
# æ­¥é©Ÿ 2: å‚™ä»½ç•¶å‰æ•¸æ“š
# ==========================================
echo "1ï¸âƒ£  å‚™ä»½ç•¶å‰æ•¸æ“š..."

if bash scripts/backup.sh; then
    echo "   âœ… å‚™ä»½å®Œæˆ"
else
    echo "   âŒ å‚™ä»½å¤±æ•—ï¼åœæ­¢æ›´æ–°"
    exit 1
fi

echo ""

# ==========================================
# æ­¥é©Ÿ 3: æ‹‰å–æ–°æ˜ åƒ
# ==========================================
echo "2ï¸âƒ£  æ‹‰å–æ–°æ˜ åƒ..."

docker compose pull

echo "   âœ… æ˜ åƒå·²æ‹‰å–"
echo ""

# ==========================================
# æ­¥é©Ÿ 4: é‡å•Ÿæœå‹™
# ==========================================
echo "3ï¸âƒ£  é‡å•Ÿæœå‹™..."

# ä½¿ç”¨æ–°æ˜ åƒé‡æ–°å‰µå»ºå®¹å™¨
docker compose up -d --force-recreate

echo "   âœ… æœå‹™å·²é‡å•Ÿ"
echo ""

# ==========================================
# æ­¥é©Ÿ 5: ç­‰å¾…æœå‹™å°±ç·’
# ==========================================
echo "4ï¸âƒ£  ç­‰å¾…æœå‹™å°±ç·’..."

sleep 10

# æª¢æŸ¥æœå‹™ç‹€æ…‹
if docker compose ps | grep -q "Up"; then
    echo "   âœ… æœå‹™é‹è¡Œä¸­"
else
    echo "   âŒ æœå‹™å•Ÿå‹•å¤±æ•—"
    echo ""
    echo "ğŸ“‹ æŸ¥çœ‹æ—¥èªŒï¼š"
    docker compose logs --tail=50
    exit 1
fi

echo ""

# ==========================================
# æ­¥é©Ÿ 6: å¥åº·æª¢æŸ¥
# ==========================================
echo "5ï¸âƒ£  å¥åº·æª¢æŸ¥..."

sleep 5

if docker compose exec -T server curl -f http://localhost:3000/healthz > /dev/null 2>&1; then
    echo "   âœ… å¥åº·æª¢æŸ¥é€šé"
else
    echo "   âš ï¸  å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒ"
fi

echo ""

# ==========================================
# å®Œæˆ
# ==========================================
echo "=========================================="
echo "âœ… æ›´æ–°å®Œæˆï¼"
echo "=========================================="
echo ""
echo "ğŸ“Š ç•¶å‰ç‰ˆæœ¬ä¿¡æ¯ï¼š"
docker compose images
echo ""
echo "ğŸ“‹ æœå‹™ç‹€æ…‹ï¼š"
docker compose ps
echo ""
echo "ğŸ’¡ å¦‚æœç™¼ç¾å•é¡Œï¼š"
echo "   - æŸ¥çœ‹æ—¥èªŒ: bash scripts/logs.sh"
echo "   - å›æ»¾åˆ°å‚™ä»½: bash scripts/restore.sh backups/db_backup_*.sql.gz"
echo ""
