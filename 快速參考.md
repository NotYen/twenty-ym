# Twenty CRM 快速參考指南

## 🚀 一鍵命令

```bash
# 啟動所有服務
./一鍵啟動.sh

# 停止所有服務  
./stop-twenty-local.sh

# 診斷問題
./診斷並修復.sh

# 打包遷移
./一鍵遷移.sh
```

## 📁 文件說明

| 文件 | 用途 |
|------|------|
| `twenty-config.sh` | 統一配置文件（修改這個文件來調整所有配置） |
| `一鍵啟動.sh` | 完整啟動腳本（檢查環境、啟動服務、驗證配置） |
| `stop-twenty-local.sh` | 停止所有服務 |
| `start-twenty-local.sh` | 簡化版啟動（舊版，建議用一鍵啟動） |
| `診斷並修復.sh` | 自動診斷配置問題並提供修復 |
| `一鍵遷移.sh` | 打包所有配置和數據，方便遷移到新機器 |
| `使用指南.md` | 完整的使用文檔 |
| `DEFAULT_SUBDOMAIN_說明.md` | DEFAULT_SUBDOMAIN 配置詳解 |
| `多租戶問題診斷和解決方案.md` | 多租戶問題的診斷文檔 |

## 🔧 配置要點

### 必須配置的變數（在 `twenty-config.sh` 中）

```bash
# 外部訪問地址
export EXTERNAL_HOST="118.168.188.27.nip.io"

# 端口
export FRONTEND_PORT=8866
export BACKEND_PORT=8867

# 多租戶
export IS_MULTIWORKSPACE_ENABLED="true"
export DEFAULT_SUBDOMAIN="apple"  # 必須與數據庫中的 workspace subdomain 一致
```

## 🌐 訪問地址

### 開發環境（nip.io）

- **默認工作區**: `http://apple.118.168.188.27.nip.io:8866`
- **後端 API**: `http://118.168.188.27.nip.io:8867`
- **其他工作區**: `http://{subdomain}.118.168.188.27.nip.io:8866`

### 生產環境（真實域名）

修改 `EXTERNAL_HOST` 為你的域名：
```bash
export EXTERNAL_HOST="your-domain.com"
```

## 🐛 常見問題速查

### 問題：跳轉到 `.domain.com`

**原因**：DEFAULT_SUBDOMAIN 環境變數未傳遞

**解決**：
```bash
./stop-twenty-local.sh
./一鍵啟動.sh
```

### 問題：端口被佔用

**解決**：
```bash
# 方法 1
./stop-twenty-local.sh

# 方法 2：手動清理
lsof -ti:8866 | xargs kill -9
lsof -ti:8867 | xargs kill -9
```

### 問題：PostgreSQL 未啟動

**解決**：
```bash
brew services start postgresql@16
lsof -i :5432  # 驗證
```

### 問題：Redis 未啟動

**解決**：
```bash
brew services start redis
lsof -i :6379  # 驗證
```

## 📊 服務檢查

```bash
# 檢查所有服務狀態
lsof -i :5432   # PostgreSQL
lsof -i :6379   # Redis
lsof -i :8867   # 後端 API
lsof -i :8866   # 前端 Web
ps aux | grep queue-worker  # Worker

# 查看日誌
tail -f twenty.log
```

## 🔄 遷移到新機器

### 在舊機器上

```bash
# 打包配置和數據
./一鍵遷移.sh

# 會生成：twenty-migration-{timestamp}.tar.gz
```

### 在新機器上

```bash
# 1. 安裝依賴
brew install node yarn postgresql@16 redis

# 2. 克隆項目
git clone <repo> twenty-ym
cd twenty-ym

# 3. 解壓配置
tar -xzf twenty-migration-*.tar.gz
chmod +x *.sh

# 4. 修改 IP（如果需要）
vim twenty-config.sh

# 5. 安裝依賴
yarn install

# 6. 恢復數據庫（如果有備份）
createdb -U postgres default
psql -U postgres -d default < twenty_backup.sql

# 7. 啟動
./一鍵啟動.sh
```

## 🎯 最佳實踐

### 開發環境

✅ 使用 nip.io（無需 DNS）
✅ 啟用 SIGN_IN_PREFILLED
✅ 禁用計費（IS_BILLING_ENABLED=false）

### 生產環境  

✅ 使用真實域名
✅ 禁用 SIGN_IN_PREFILLED
✅ 配置 HTTPS
✅ 限制 workspace 創建權限

## 📞 故障排除

```
遇到問題？
    ↓
運行診斷
$ ./診斷並修復.sh
    ↓
檢查配置
$ ./twenty-config.sh --show
    ↓
查看日誌
$ tail -f twenty.log
    ↓
重啟服務
$ ./stop-twenty-local.sh
$ ./一鍵啟動.sh
```

## 📚 詳細文檔

- 完整使用指南：`使用指南.md`
- DEFAULT_SUBDOMAIN 說明：`DEFAULT_SUBDOMAIN_說明.md`
- 多租戶問題診斷：`多租戶問題診斷和解決方案.md`

