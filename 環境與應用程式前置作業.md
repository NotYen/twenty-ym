# Twenty CRM 本地 Docker 環境建置指南 (Windows)

本指南旨在協助開發人員在 Windows 11 作業系統上，使用 Docker 成功建立並運行 Twenty CRM 的本地開發測試環境。

---

## Part 1: 環境與應用程式準備

在開始之前，請確保您的系統已安裝以下必要的應用程式，並滿足最低要求。

| 應用程式 / 環境 | 最低要求 | 下載 / 解決方案 | 備註 |
| :--- | :--- | :--- | :--- |
| **Git** | 任意版本 | [https://git-scm.com/](https://git-scm.com/) | 用於從版本控制庫下載原始碼。 |
| **Docker Desktop** | 4.15.0 或更新 | [https://www.docker.com/products/docker-desktop/](https://www.docker.com/products/docker-desktop/) | **核心工具**。請務必在安裝時選擇 **WSL 2 backend**。 |
| **WSL 2** | Kernel 5.10.16 或更新 | [安裝 WSL 指令](https://learn.microsoft.com/zh-tw/windows/wsl/install) | 通常 Docker Desktop 會自動安裝。如果遇到問題，可手動執行 `wsl --install` 或 `wsl --update`。 |
| **Windows Terminal** | (建議使用) | [Microsoft Store](https://aka.ms/terminal) | 提供比傳統 CMD 或 PowerShell 更好的終端機體驗。 |
| **磁碟儲存空間** | **至少 30 GB** | - | **極度重要**。Docker 映像和資料庫會佔用大量空間。建議在 C 槽或 D 槽準備充足空間。 |

---

## Part 2: 系統與資源設定

這是確保建置過程順利的最關鍵步驟。

### 2.1. 設定 WSL 2 資源限制

為了避免 Docker 在建置時因記憶體不足而崩潰，我們需要手動建立一個設定檔來提高 WSL 2 的資源上限。

1.  開啟檔案總管，在路徑列輸入 `%USERPROFILE%` 並按下 Enter（這會帶您到 `C:\Users\<您的使用者名稱>`）。
2.  在此資料夾中，建立一個名為 `.wslconfig` 的新檔案。
3.  將以下內容完整複製並貼到 `.wslconfig` 檔案中：

    ```ini
    [wsl2]
    memory=12GB   # 分配 12GB 記憶體給 WSL
    processors=8  # 分配 8 個 CPU 核心給 WSL
    swap=2GB
    ```
    *備註：您可以根據您電腦的實際硬體規格（例如總記憶體大小）適度調整 `memory` 和 `processors` 的數值。*

4.  **套用設定**：開啟 Windows Terminal 或 PowerShell，執行 `wsl --shutdown` 來關閉 WSL，以便下次啟動時載入新設定。

### 2.2. (可選) 遷移 Docker 資料儲存位置

如果您的 C 槽空間不足，強烈建議將 Docker 的資料目錄遷移到空間更充裕的磁碟機（例如 D 槽）。

1.  **徹底關閉 Docker**：在系統匣中右鍵點擊 Docker 圖示，選擇 "Quit Docker Desktop"。
2.  **確認 WSL 已關閉**：在 PowerShell 中執行 `wsl --shutdown`。
3.  **移動資料夾**：
    *   開啟檔案總管，導航至 `C:\Users\<您的使用者名稱>\AppData\Local\Docker`。
    *   將 `wsl` 這個資料夾**剪下 (Cut)**。
    *   在 D 槽建立一個新資料夾，例如 `D:\Docker`。
    *   將 `wsl` 資料夾**貼上 (Paste)** 到 `D:\Docker` 中，最終路徑應為 `D:\Docker\wsl`。
4.  **更新 Docker 設定**：
    *   重新啟動 Docker Desktop。
    *   進入 **Settings > Resources > Advanced**。
    *   在 **"Disk image location"** 欄位，點擊 "Browse" 並選擇 `D:\Docker` 這個父資料夾。
    *   點擊 **"Apply & Restart"**。Docker 會重啟並開始使用 D 槽的儲存空間。

---

## Part 3: 專案建置與啟動

1.  **取得原始碼**
    在您選擇的工作目錄下，透過 Git 複製專案。
    ```bash
    git clone <專案的 Git Repo URL>
    cd twenty-ym
    ```

2.  **建置 Docker 映像**
    此步驟會根據 Dockerfile 建立本地映像，過程可能需要 20-40 分鐘。
    ```bash
    docker build -f packages/twenty-docker/twenty/Dockerfile -t twenty-zh-tw:latest .
    ```

3.  **修正 Docker Compose 檔案**
    在啟動服務前，需要修正設定檔中的兩個地方。
    *   開啟檔案：`deployment/docker-compose.local-test.yml`
    *   **修正 1 (映像標籤)**：找到 `server-test` 和 `worker-test` 服務，將 `image: twenty-zh-tw:port9999` 全部修改為 `image: twenty-zh-tw:latest`。
    *   **修正 2 (後端 URL)**：在 `server-test` 服務的 `environment` 區塊中，新增一行 `SERVER_URL: http://localhost:9999`。

4.  **啟動服務**
    進入 `deployment` 目錄並使用 Docker Compose 啟動所有服務。
    ```bash
    cd deployment
    docker compose -f docker-compose.local-test.yml up -d
    ```

5.  **驗證與存取**
    *   執行 `docker compose -f docker-compose.local-test.yml ps` 確認所有服務的 `STATUS` 均為 `Up` 或 `healthy`。
    *   開啟瀏覽器，訪問：[http://localhost:9999](http://localhost:9999)
    *   如果一切順利，您將會看到 Twenty CRM 的登入頁面。

---

## Part 4: 疑難排解

*   **問題**：`docker build` 或 `docker-compose up` 執行到一半崩潰或卡住。
    *   **原因**：最可能是資源不足。
    *   **解決方案**：請回到 **Part 2**，確認 `.wslconfig` 檔案已正確設定，並且 Docker 資料儲存位置的磁碟空間充足。

*   **問題**：`docker-compose up` 失敗，提示 `pull access denied`。
    *   **原因**：Compose 檔案中的映像標籤與本地建置的標籤不符。
    *   **解決方案**：請回到 **Part 3.3**，確認 `image` 標籤已修正為 `twenty-zh-tw:latest`。

*   **問題**：前端頁面顯示「無法連接後端」。
    *   **原因**：前端頁面拿到的後端 URL 不正確。
    *   **解決方案**：請回到 **Part 3.3**，確認 `SERVER_URL: http://localhost:9999` 已新增到 `server-test` 的環境變數中。
