# Twenty CRM 環境變數載入優先級完整說明

**文檔版本：** 1.0
**更新日期：** 2025-10-30
**適用範圍：** Twenty CRM Frontend (Vite) 環境變數配置

---

## 📚 **Vite 環境變數載入機制**

### **核心原理**

Vite 使用 `loadEnv()` 函數載入環境變數，會按照特定順序讀取多個來源，**高優先級會覆蓋低優先級**。

```typescript
// packages/twenty-front/vite.config.ts 第 21 行
const env = loadEnv(mode, __dirname, '');
```

---

## 🎯 **完整的環境變數優先級**

```
┌─────────────────────────────────────────────────────┐
│  優先級 1（最高）：命令行直接設定                      │
│  ─────────────────────────────────────────────────  │
│  範例：                                              │
│  NODE_ENV=production npx vite build                 │
│  REACT_APP_PORT=8866 npx nx build twenty-front      │
│                                                     │
│  特點：                                              │
│  ✅ 優先級最高，會覆蓋所有其他設定                    │
│  ✅ 適用於臨時測試或 CI/CD 流程                      │
│  ⚠️  不會被保存，重啟後失效                          │
└─────────────────────────────────────────────────────┘
                        ↓ 覆蓋
┌─────────────────────────────────────────────────────┐
│  優先級 2：Shell export（twenty-config.sh）         │
│  ─────────────────────────────────────────────────  │
│  檔案：twenty-config.sh                             │
│  使用方式：                                          │
│  source /path/to/twenty-config.sh                   │
│  export NODE_ENV="production"                       │
│  export VITE_IS_DEBUG_MODE="true"                   │
│                                                     │
│  在 build_all_services_prod_env.sh 中：             │
│  - 第 17 行：source twenty-config.sh                │
│  - 第 117-148 行：export 所有環境變數               │
│                                                     │
│  特點：                                              │
│  ✅ 統一管理所有配置                                 │
│  ✅ 優先級高於 .env 文件                             │
│  ✅ 適合自定義部署場景                               │
│  ⚠️  需要通過腳本載入（source）                      │
└─────────────────────────────────────────────────────┘
                        ↓ 覆蓋
┌─────────────────────────────────────────────────────┐
│  優先級 3：.env.{mode}.local（本機專用）             │
│  ─────────────────────────────────────────────────  │
│  檔案：                                              │
│  - .env.production.local（生產環境本機設定）          │
│  - .env.development.local（開發環境本機設定）         │
│                                                     │
│  特點：                                              │
│  ✅ 用於本機特殊配置（不同開發者機器）                │
│  ✅ 自動加入 .gitignore（不會提交到版本控制）         │
│  ✅ 優先級高於 .env.{mode}                          │
│  💡 適合存放：API Key、資料庫密碼等敏感資訊          │
└─────────────────────────────────────────────────────┘
                        ↓ 覆蓋
┌─────────────────────────────────────────────────────┐
│  優先級 4：.env.{mode}（環境專用）✅ 重點             │
│  ─────────────────────────────────────────────────  │
│  檔案：                                              │
│  - .env.production（生產環境配置）                   │
│  - .env.development（開發環境配置）                  │
│                                                     │
│  .env.production 範例內容：                         │
│  REACT_APP_PORT=8866                                │
│  REACT_APP_SERVER_BASE_URL=http://...               │
│  IS_DEBUG_MODE=true                                 │
│  VITE_IS_DEBUG_MODE=true                            │
│  REACT_APP_FIREBASE_API_KEY=...                     │
│                                                     │
│  何時使用：                                          │
│  - NODE_ENV=production 時自動載入 .env.production   │
│  - NODE_ENV=development 時自動載入 .env.development │
│                                                     │
│  特點：                                              │
│  ✅ 針對特定環境的配置                               │
│  ✅ 提交到 git（團隊共享配置）                       │
│  ✅ 適合存放：環境特定的 URL、端口等                 │
│  ⚠️  優先級低於 Shell export                         │
└─────────────────────────────────────────────────────┘
                        ↓ 覆蓋
┌─────────────────────────────────────────────────────┐
│  優先級 5：.env.local（通用本機設定）                 │
│  ─────────────────────────────────────────────────  │
│  特點：                                              │
│  ✅ 所有環境都會載入                                 │
│  ✅ 自動加入 .gitignore                             │
│  💡 適合個人開發偏好設定                             │
└─────────────────────────────────────────────────────┘
                        ↓ 覆蓋
┌─────────────────────────────────────────────────────┐
│  優先級 6（最低）：.env（通用默認值）                 │
│  ─────────────────────────────────────────────────  │
│  檔案：.env                                          │
│                                                     │
│  特點：                                              │
│  ✅ 所有環境的默認配置                               │
│  ✅ 通常提交到 git（作為範例）                       │
│  ⚠️  優先級最低，容易被覆蓋                          │
│  💡 適合存放：默認端口、範例配置等                   │
└─────────────────────────────────────────────────────┘
```

---

## 🔍 **你的 `build_all_services_prod_env.sh` 執行流程**

### **詳細執行順序：**

```bash
# ==========================================
# 步驟 1：載入 twenty-config.sh
# ==========================================
source "${SCRIPT_DIR}/twenty-config.sh"

# 此時 Shell 環境變數已設定：
# ✅ NODE_ENV="production"
# ✅ VITE_IS_DEBUG_MODE="true"
# ✅ FRONTEND_PORT=8866
# ✅ BACKEND_PORT=8867
# ... 等等

# ==========================================
# 步驟 2：設置更多環境變數
# ==========================================
# 第 117-148 行
export REACT_APP_PORT=${FRONTEND_PORT}
export REACT_APP_SERVER_BASE_URL=${BACKEND_URL}
export NODE_ENV=${NODE_ENV}  # 重複設定（其實已經有了）
export IS_MULTIWORKSPACE_ENABLED=${IS_MULTIWORKSPACE_ENABLED}
# ... 等等

# 此時 Shell 環境變數：
# ✅ REACT_APP_PORT=8866
# ✅ REACT_APP_SERVER_BASE_URL=http://118.168.188.27.nip.io:8867
# ✅ NODE_ENV=production
# ✅ VITE_IS_DEBUG_MODE=true

# ==========================================
# 步驟 3：執行前端 Build
# ==========================================
# 第 188 行
npx nx run-many -t build -p twenty-front

# ↓ Vite 開始執行

# ==========================================
# 步驟 4：Vite 載入環境變數（內部流程）
# ==========================================
# vite.config.ts 第 21 行
const env = loadEnv(mode, __dirname, '');

# Vite 按順序合併：
# 1️⃣ 讀取 Shell 環境變數（優先級最高）
#    - NODE_ENV=production         ✅ 來自 twenty-config.sh
#    - REACT_APP_PORT=8866          ✅ 來自 build 腳本
#    - REACT_APP_SERVER_BASE_URL=... ✅ 來自 build 腳本
#    - VITE_IS_DEBUG_MODE=true      ✅ 來自 twenty-config.sh
#
# 2️⃣ 讀取 .env.production（補充 Shell 沒設定的）
#    - IS_DEBUG_MODE=true           ✅ Shell 沒設定，使用這個
#    - REACT_APP_FIREBASE_API_KEY=... ✅ Firebase 配置
#
# 3️⃣ 合併結果（高優先級覆蓋低優先級）

# ==========================================
# 步驟 5：Vite 處理環境變數
# ==========================================
# vite.config.ts 第 274-281 行
define: {
  'process.env': {
    REACT_APP_SERVER_BASE_URL,  // 注入到代碼中的 process.env
    IS_DEBUG_MODE,               // 注入到代碼中的 process.env
  },
}

# ==========================================
# 最終結果
# ==========================================
# 前端代碼中可用的環境變數：
{
  NODE_ENV: "production",                    // Shell > .env.production
  REACT_APP_SERVER_BASE_URL: "http://...",   // Shell > .env.production
  REACT_APP_PORT: "8866",                    // Shell
  IS_DEBUG_MODE: "true",                     // .env.production（Shell 沒設定）
  VITE_IS_DEBUG_MODE: "true",                // Shell
  REACT_APP_FIREBASE_API_KEY: "...",         // .env.production
}
```

---

## 💡 **關鍵理解點**

### **1. Shell 環境變數永遠優先**

```bash
# 即使 .env.production 設定：
REACT_APP_PORT=3001

# 但如果 Shell 中有：
export REACT_APP_PORT=8866

# 最終結果：8866 ✅（Shell 優先）
```

---

### **2. `.env.production` 的作用**

**作用 A：提供默認值**
```bash
# 如果 Shell 沒設定 IS_DEBUG_MODE
# Vite 會從 .env.production 讀取
IS_DEBUG_MODE=true
```

**作用 B：環境特定配置**
```bash
# 生產環境的 Firebase 配置
REACT_APP_FIREBASE_API_KEY=prod_key_xxx

# 開發環境的 Firebase 配置（.env.development）
REACT_APP_FIREBASE_API_KEY=dev_key_xxx
```

---

### **3. 兩種配置策略對比**

#### **策略 A：只用 .env 文件（簡單）**

```bash
# .env.production
NODE_ENV=production
REACT_APP_PORT=8866
REACT_APP_SERVER_BASE_URL=http://...
IS_DEBUG_MODE=false

# 執行 build
npx nx build twenty-front
```

**優點：** 簡單直接
**缺點：** 不靈活，無法在不同機器使用不同配置

---

#### **策略 B：.env + twenty-config.sh（你的方案，靈活）**

```bash
# .env.production（默認值 + Firebase 等固定配置）
REACT_APP_FIREBASE_API_KEY=xxx
IS_DEBUG_MODE=true

# twenty-config.sh（可變配置）
export FRONTEND_PORT=8866
export BACKEND_PORT=8867
export NODE_ENV="production"

# build_all_services_prod_env.sh（整合）
source twenty-config.sh
export REACT_APP_PORT=${FRONTEND_PORT}
npx nx build twenty-front
```

**優點：**
- ✅ 靈活配置不同機器
- ✅ 一個地方修改所有服務配置
- ✅ Shell 變數可覆蓋 .env 文件

**缺點：**
- ⚠️ 配置來源多，可能混淆

---

## 🚀 **你的系統實際載入順序**

### **完整流程圖**

```
執行：./build_all_services_prod_env.sh
  │
  ├─ 第 17 行：source twenty-config.sh
  │   └─ 設定 Shell 環境變數：
  │       ✅ NODE_ENV="production"
  │       ✅ FRONTEND_PORT=8866
  │       ✅ BACKEND_PORT=8867
  │       ✅ VITE_IS_DEBUG_MODE="true"
  │       ✅ EXTERNAL_HOST="118.168.188.27.nip.io"
  │
  ├─ 第 117-148 行：export 更多變數
  │   └─ 基於 twenty-config.sh 的值生成：
  │       ✅ REACT_APP_PORT=8866
  │       ✅ REACT_APP_SERVER_BASE_URL=http://118.168.188.27.nip.io:8867
  │       ✅ NODE_ENV=production（重複 export，已經有了）
  │
  ├─ 第 188 行：npx nx build twenty-front
  │   │
  │   └─ Vite 開始執行：
  │       │
  │       ├─ vite.config.ts 第 21 行：loadEnv(mode, __dirname, '')
  │       │   │
  │       │   ├─ 讀取順序：
  │       │   │   1️⃣ Shell 環境變數（最高優先級）
  │       │   │      ├─ NODE_ENV=production ✅
  │       │   │      ├─ REACT_APP_PORT=8866 ✅
  │       │   │      ├─ REACT_APP_SERVER_BASE_URL=... ✅
  │       │   │      └─ VITE_IS_DEBUG_MODE=true ✅
  │       │   │
  │       │   │   2️⃣ .env.production.local（不存在，跳過）
  │       │   │
  │       │   │   3️⃣ .env.production ✅
  │       │   │      ├─ REACT_APP_PORT=8866（已有，忽略）
  │       │   │      ├─ REACT_APP_SERVER_BASE_URL=...（已有，忽略）
  │       │   │      ├─ IS_DEBUG_MODE=true ✅（Shell 沒設定，使用這個）
  │       │   │      ├─ VITE_IS_DEBUG_MODE=true（已有，忽略）
  │       │   │      └─ REACT_APP_FIREBASE_API_KEY=... ✅
  │       │   │
  │       │   │   4️⃣ .env.local（不存在，跳過）
  │       │   │
  │       │   │   5️⃣ .env（可能存在，優先級最低）
  │       │   │
  │       │   └─ 合併結果（最終的 env 對象）：
  │       │       {
  │       │         NODE_ENV: "production",
  │       │         REACT_APP_PORT: "8866",
  │       │         REACT_APP_SERVER_BASE_URL: "http://...",
  │       │         IS_DEBUG_MODE: "true",        // 來自 .env.production
  │       │         VITE_IS_DEBUG_MODE: "true",   // 來自 Shell
  │       │         REACT_APP_FIREBASE_API_KEY: "...",
  │       │       }
  │       │
  │       └─ 第 274-281 行：define（注入到代碼中）
  │           'process.env': {
  │             REACT_APP_SERVER_BASE_URL,  // 可在代碼中使用
  │             IS_DEBUG_MODE,               // 可在代碼中使用
  │           }
  │
  └─ 構建完成，生成 build/ 目錄
```

---

## 📊 **環境變數來源對比表**

| 環境變數名稱 | Shell (twenty-config.sh) | .env.production | 最終使用 | 來源 |
|------------|-------------------------|-----------------|---------|------|
| `NODE_ENV` | ✅ production | - | production | Shell |
| `REACT_APP_PORT` | ✅ 8866 | ✅ 8866 | 8866 | Shell（優先） |
| `REACT_APP_SERVER_BASE_URL` | ✅ http://... | ✅ http://... | http://... | Shell（優先） |
| `IS_DEBUG_MODE` | ❌ 未設定 | ✅ true | true | .env.production |
| `VITE_IS_DEBUG_MODE` | ✅ true | ✅ true | true | Shell（優先） |
| `REACT_APP_FIREBASE_API_KEY` | ❌ 未設定 | ✅ AIzaSy... | AIzaSy... | .env.production |

---

## 🎯 **重要結論**

### **你的理解需要修正：**

❌ **錯誤理解：**
> "先取得前端的 .env 後才會去取得 twenty-config.sh 裡面的參數"

✅ **正確理解：**
> "先執行 twenty-config.sh 設定 Shell 環境變數，然後在 build 時，Vite 優先使用 Shell 環境變數，再用 .env.production 補充 Shell 沒設定的值"

### **執行順序：**

```
1. source twenty-config.sh          （設定 Shell 環境變數）
   ↓
2. export REACT_APP_PORT=...        （基於 twenty-config.sh 設定更多）
   ↓
3. npx nx build twenty-front        （開始 build）
   ↓
4. Vite 載入環境變數：
   ├─ 優先讀取 Shell 環境變數 ✅（已經有值）
   └─ 補充讀取 .env.production  ✅（只讀 Shell 沒設定的）
   ↓
5. 合併結果，開始構建
```

---

## 💡 **實際應用建議**

### **情境 1：開發環境**

```bash
# .env.development
REACT_APP_PORT=3001
REACT_APP_SERVER_BASE_URL=http://localhost:3000
IS_DEBUG_MODE=true
VITE_IS_DEBUG_MODE=true

# 執行
npx nx start twenty-front
```

**結果：** 使用 `.env.development` 的配置

---

### **情境 2：生產環境（使用腳本）**

```bash
# 修改 twenty-config.sh
export NODE_ENV="production"
export VITE_IS_DEBUG_MODE="false"  # 關閉 debug

# 執行
./build_all_services_prod_env.sh
```

**結果：** Shell 環境變數覆蓋 `.env.production` 的配置

---

### **情境 3：單獨 Build 前端**

```bash
# 不使用腳本，直接 build
cd packages/twenty-front
npx vite build
```

**結果：** 只使用 `.env.production` 的配置（沒有 Shell 覆蓋）

---

## 🔧 **最佳實踐建議**

### **配置分工：**

#### **`twenty-config.sh`：**
存放**可變配置**（不同機器/部署環境可能不同）
```bash
export FRONTEND_PORT=8866
export BACKEND_PORT=8867
export EXTERNAL_HOST="118.168.188.27.nip.io"
export NODE_ENV="production"
export VITE_IS_DEBUG_MODE="true"
```

#### **`.env.production`：**
存放**固定配置**（所有生產環境都相同）
```bash
# Firebase 配置（所有生產環境都一樣）
REACT_APP_FIREBASE_API_KEY=xxx
REACT_APP_FIREBASE_PROJECT_ID=xxx

# 默認值（Shell 沒設定時使用）
IS_DEBUG_MODE=false
REACT_APP_PORT=8866
```

#### **`.env.development`：**
存放**開發環境配置**
```bash
REACT_APP_PORT=3001
REACT_APP_SERVER_BASE_URL=http://localhost:3000
IS_DEBUG_MODE=true
```

---

## 📝 **檢查當前配置的命令**

```bash
# 1. 查看 Shell 環境變數
source /Users/ym/twenty-ym/twenty-config.sh
env | grep -E "NODE_ENV|REACT_APP|IS_DEBUG|VITE"

# 2. 查看 .env.production 內容
cat /Users/ym/twenty-ym/packages/twenty-front/.env.production

# 3. 查看 .env.development 內容
cat /Users/ym/twenty-ym/packages/twenty-front/.env.development

# 4. 測試環境變數載入（不實際 build）
cd packages/twenty-front
node -e "
  const { loadEnv } = require('vite');
  const env = loadEnv('production', __dirname, '');
  console.log('Loaded env:', env);
"
```

---

## ⚠️ **常見誤區**

### **誤區 1：以為 .env 文件優先級最高**
❌ 錯誤：`.env.production` 會覆蓋 Shell 環境變數
✅ 正確：Shell 環境變數優先級最高，會覆蓋 `.env` 文件

### **誤區 2：修改 .env 後立即生效**
❌ 錯誤：修改 `.env.production` 後，運行中的服務會自動更新
✅ 正確：需要重新 build 前端才會生效（環境變數在構建時注入）

### **誤區 3：所有環境變數都會被注入**
❌ 錯誤：所有 `.env` 中的變數都可以在代碼中使用
✅ 正確：只有 `VITE_` 或 `REACT_APP_` 開頭的變數會被暴露給客戶端代碼

---

## 🎯 **總結**

1. **載入順序：** Shell > .env.{mode}.local > .env.{mode} > .env.local > .env

2. **你的腳本：** 先載入 `twenty-config.sh`（設定 Shell），再 build（Vite 讀取 Shell + .env）

3. **優先級：** Shell 永遠優先，會覆蓋 `.env` 文件

4. **建議：** 可變配置放 `twenty-config.sh`，固定配置放 `.env.production`

---

**💡 記住：Shell export > .env 文件，永遠如此！**

