# Twenty CRM ä»£ç¢¼è¿½è¹¤åˆ†æå ±å‘Š

> ç”Ÿæˆæ™‚é–“ï¼š2025-10-14  
> ç›®çš„ï¼šç³»çµ±æ€§åˆ†æç™»å…¥å¾Œé®ç½©å•é¡Œçš„æ ¹æœ¬åŸå› 

---

## ğŸ“‹ ç›®éŒ„

1. [å‰ç«¯å•Ÿå‹•æµç¨‹](#å‰ç«¯å•Ÿå‹•æµç¨‹)
2. [èªè­‰èˆ‡ç™»å…¥æµç¨‹](#èªè­‰èˆ‡ç™»å…¥æµç¨‹)
3. [ç”¨æˆ¶è¼‰å…¥æµç¨‹](#ç”¨æˆ¶è¼‰å…¥æµç¨‹)
4. [è·¯ç”±èˆ‡å°èˆªæ©Ÿåˆ¶](#è·¯ç”±èˆ‡å°èˆªæ©Ÿåˆ¶)
5. [UI é®ç½©é¡¯ç¤ºé‚è¼¯](#ui-é®ç½©é¡¯ç¤ºé‚è¼¯)
6. [å¾Œç«¯èªè­‰èˆ‡ Token è™•ç†](#å¾Œç«¯èªè­‰èˆ‡-token-è™•ç†)
7. [é—œéµå•é¡Œé»åˆ†æ](#é—œéµå•é¡Œé»åˆ†æ)
8. [å»ºè­°ä¿®å¾©æ–¹æ¡ˆ](#å»ºè­°ä¿®å¾©æ–¹æ¡ˆ)

---

## 1. å‰ç«¯å•Ÿå‹•æµç¨‹

### 1.1 å…¥å£é»éˆè·¯

```
index.html (line 87)
  â†“ <script type="module" src="/src/index.tsx"></script>
  â†“
index.tsx (line 14)
  â†“ root.render(<App />)
  â†“
App.tsx (line 18-47)
  â†“ <RecoilRoot> â†’ <AppErrorBoundary> â†’ <I18nProvider> â†’ <AppRouter>
  â†“
AppRouter.tsx (line 16-21)
  â†“ <RouterProvider router={useCreateAppRouter(...)} />
  â†“
useCreateAppRouter.tsx (line 31-82)
  â†“ createBrowserRouter with routes
```

### 1.2 é—œéµ Route é…ç½®

```typescript
// useCreateAppRouter.tsx: line 37-80
<Route element={<AppRouterProviders />}>
  <Route element={<DefaultLayout />}>
    <Route path={AppPath.Verify} element={<VerifyLoginTokenEffect />} />
    <Route path={AppPath.SignInUp} element={<SignInUp />} />
    // ... å…¶ä»–è·¯ç”±
  </Route>
</Route>
```

**é‡é»**ï¼š`AppPath.Verify` è·¯ç”±ä½¿ç”¨ `DefaultLayout`ï¼Œæœƒæ ¹æ“š `useShowAuthModal` æ±ºå®šæ˜¯å¦é¡¯ç¤ºé®ç½©ã€‚

---

## 2. èªè­‰èˆ‡ç™»å…¥æµç¨‹

### 2.1 VerifyLoginTokenEffect çµ„ä»¶

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/auth/components/VerifyLoginTokenEffect.tsx`

```typescript
// line 24-34
useEffect(() => {
  if (!clientConfigLoaded) return;

  if (isDefined(loginToken)) {
    verifyLoginToken(loginToken);  // å‘¼å«é©—è­‰
  } else if (!isLogged) {
    navigate(AppPath.SignInUp);
  }
}, [clientConfigLoaded]);
```

**æµç¨‹**ï¼š
1. ç­‰å¾… `clientConfigLoaded` ç‚º true
2. å¦‚æœ URL æœ‰ `loginToken`ï¼Œå‘¼å« `verifyLoginToken(loginToken)`
3. `verifyLoginToken` å…§éƒ¨å‘¼å« `getAuthTokensFromLoginToken(loginToken)`

### 2.2 useAuth Hook - getAuthTokensFromLoginToken

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/auth/hooks/useAuth.ts`

```typescript
// line 329-380
const handleGetAuthTokensFromLoginToken = useCallback(
  async (loginToken: string) => {
    try {
      const getAuthTokensResult = await getAuthTokensFromLoginToken({
        variables: { loginToken: loginToken, origin },
      });

      if (!getAuthTokensResult.data?.getAuthTokensFromLoginToken) {
        throw new Error('No getAuthTokensFromLoginToken result');
      }

      // é—œéµï¼šå‘¼å« handleLoadWorkspaceAfterAuthentication
      await handleLoadWorkspaceAfterAuthentication(
        getAuthTokensResult.data.getAuthTokensFromLoginToken.tokens,
      );
    } catch (error) {
      // è™•ç† 2FA éŒ¯èª¤...
    }
  },
  [/* deps */],
);
```

### 2.3 handleLoadWorkspaceAfterAuthentication

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/auth/hooks/useAuth.ts`

```typescript
// line 316-327
const handleLoadWorkspaceAfterAuthentication = useCallback(
  async (authTokens: AuthTokenPair) => {
    handleSetAuthTokens(authTokens);  // è¨­ç½® token

    // TODO: é€™è£¡æœ‰è¨»é‡‹èªªä¸èƒ½ä¸¦è¡ŒåŸ·è¡Œ
    await loadCurrentUser();           // è¼‰å…¥ç”¨æˆ¶
    await refreshObjectMetadataItems(); // åˆ·æ–° metadata
  },
  [loadCurrentUser, handleSetAuthTokens, refreshObjectMetadataItems],
);
```

**é—œéµå•é¡Œ**ï¼š`loadCurrentUser()` å®Œæˆå¾Œï¼Œ**æ²’æœ‰è¨­ç½® `isCurrentUserLoadedState` ç‚º true**ï¼

---

## 3. ç”¨æˆ¶è¼‰å…¥æµç¨‹

### 3.1 useLoadCurrentUser Hook

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/users/hooks/useLoadCurrentUser.ts`

```typescript
// line 45-135
const loadCurrentUser = useCallback(async () => {
  const currentUserResult = await getCurrentUser({
    fetchPolicy: 'network-only',
  });

  const coreViewsResult = await findAllCoreViews({
    fetchPolicy: 'network-only',
  });

  // ... è¨­ç½®å„ç¨® state
  setCurrentUser(user);
  setCurrentWorkspace(workspace);
  setCurrentWorkspaceMember(workspaceMember);
  // ... ç­‰ç­‰

  // âŒ å•é¡Œï¼šé€™è£¡æ²’æœ‰ setIsCurrentUserLoaded(true)

  return { user, workspaceMember, workspace };
}, [/* deps */]);
```

**å°æ¯”ï¼šUserAndViewsProviderEffect**

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/users/components/UserAndViewsProviderEffect.tsx`

```typescript
// line 207-211
useEffect(() => {
  if (localIsCurrentUserLoaded && localAreViewsLoaded) {
    setIsCurrentUserLoaded(true);  // âœ… é€™è£¡æœ‰è¨­ç½®ï¼
  }
}, [localIsCurrentUserLoaded, localAreViewsLoaded, setIsCurrentUserLoaded]);
```

**çµè«–**ï¼š
- `UserAndViewsProviderEffect` ä½¿ç”¨ `useGetCurrentUserQuery` (è‡ªå‹•åŸ·è¡Œ)
- `useLoadCurrentUser` ä½¿ç”¨ `useGetCurrentUserLazyQuery` (æ‰‹å‹•åŸ·è¡Œ)
- **`useLoadCurrentUser` æ²’æœ‰è¨­ç½® `isCurrentUserLoadedState`**ï¼Œå°è‡´å¾ŒçºŒé‚è¼¯ç„¡æ³•è§¸ç™¼ï¼

---

## 4. è·¯ç”±èˆ‡å°èˆªæ©Ÿåˆ¶

### 4.1 PageChangeEffect

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/app/effect-components/PageChangeEffect.tsx`

```typescript
// line 110-116
useEffect(() => {
  initializeQueryParamState();

  if (isDefined(pageChangeEffectNavigateLocation)) {
    navigate(pageChangeEffectNavigateLocation);  // åŸ·è¡Œå°èˆª
  }
}, [navigate, pageChangeEffectNavigateLocation, initializeQueryParamState]);
```

### 4.2 usePageChangeEffectNavigateLocation

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/hooks/usePageChangeEffectNavigateLocation.ts`

```typescript
// line 17-155
export const usePageChangeEffectNavigateLocation = () => {
  const isLoggedIn = useIsLogged();
  const { isOnAWorkspace } = useIsCurrentLocationOnAWorkspace();
  const onboardingStatus = useOnboardingStatus();

  // line 30-35: å®šç¾© onGoingUserCreationPaths
  const onGoingUserCreationPaths = [
    AppPath.Invite,
    AppPath.SignInUp,
    AppPath.VerifyEmail,
    AppPath.Verify,  // â† /verify åœ¨é€™è£¡
  ];

  // line 134-141: é—œéµé‚è¼¯
  if (
    onboardingStatus === OnboardingStatus.COMPLETED &&
    someMatchingLocationOf([...onboardingPaths, ...onGoingUserCreationPaths]) &&
    !isMatchingLocation(location, AppPath.ResetPassword) &&
    isLoggedIn
  ) {
    return defaultHomePagePath;  // æ‡‰è©²å°èˆªåˆ°é¦–é 
  }

  return;  // ä¸å°èˆª
};
```

**è§¸ç™¼æ¢ä»¶**ï¼š
1. `onboardingStatus === OnboardingStatus.COMPLETED` âœ…
2. ç•¶å‰åœ¨ `onGoingUserCreationPaths` (åŒ…æ‹¬ `/verify`) âœ…
3. `isLoggedIn` ç‚º true âœ…

**å•é¡Œ**ï¼šé€™å€‹é‚è¼¯ä¾è³´æ–¼ `onboardingStatus`ï¼Œè€Œ `onboardingStatus` ä¾†è‡ª `currentUserState`ã€‚

### 4.3 useOnboardingStatus

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/onboarding/hooks/useOnboardingStatus.ts`

```typescript
// line 7-11
export const useOnboardingStatus = (): OnboardingStatus | null | undefined => {
  const currentUser = useRecoilValue(currentUserState);
  const isLoggedIn = useIsLogged();
  return isLoggedIn ? currentUser?.onboardingStatus : undefined;
};
```

**é—œéµ**ï¼š`currentUser` å¿…é ˆå·²ç¶“è¼‰å…¥ï¼Œæ‰èƒ½å–å¾— `onboardingStatus`ã€‚

---

## 5. UI é®ç½©é¡¯ç¤ºé‚è¼¯

### 5.1 DefaultLayout

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/ui/layout/page/components/DefaultLayout.tsx`

```typescript
// line 64: å–å¾— showAuthModal
const showAuthModal = useShowAuthModal();

// line 99-116: æ ¹æ“š showAuthModal æ±ºå®šæ¸²æŸ“å…§å®¹
{showAuthModal ? (
  <>
    <StyledMainContainer>
      <SignInBackgroundMockPage />
    </StyledMainContainer>
    <AnimatePresence mode="wait">
      <LayoutGroup>
        <AuthModal>
          <Outlet />  {/* VerifyLoginTokenEffect åœ¨é€™è£¡ */}
        </AuthModal>
      </LayoutGroup>
    </AnimatePresence>
  </>
) : (
  <StyledMainContainer>
    <AppErrorBoundary FallbackComponent={AppPageErrorFallback}>
      <Outlet />
    </AppErrorBoundary>
  </StyledMainContainer>
)}
```

### 5.2 useShowAuthModal

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/ui/layout/hooks/useShowAuthModal.ts`

```typescript
// line 10-30
return useMemo(() => {
  if (
    isMatchingLocation(location, AppPath.Invite) ||
    isMatchingLocation(location, AppPath.InviteTeam) ||
    isMatchingLocation(location, AppPath.CreateProfile) ||
    isMatchingLocation(location, AppPath.SyncEmails) ||
    isMatchingLocation(location, AppPath.ResetPassword) ||
    isMatchingLocation(location, AppPath.VerifyEmail) ||
    isMatchingLocation(location, AppPath.Verify) ||  // â† é€™è£¡ï¼
    isMatchingLocation(location, AppPath.SignInUp) ||
    isMatchingLocation(location, AppPath.CreateWorkspace) ||
    isMatchingLocation(location, AppPath.PlanRequired) ||
    isMatchingLocation(location, AppPath.PlanRequiredSuccess) ||
    isMatchingLocation(location, AppPath.BookCallDecision) ||
    isMatchingLocation(location, AppPath.BookCall)
  ) {
    return true;  // é¡¯ç¤ºé®ç½©
  }

  return false;
}, [location]);
```

**çµè«–**ï¼šåªè¦åœ¨ `/verify` è·¯å¾‘ï¼Œ`showAuthModal` å°±æœƒæ˜¯ `true`ï¼Œé®ç½©å°±æœƒé¡¯ç¤ºã€‚

### 5.3 UserProvider

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/users/components/UserProvider.tsx`

```typescript
// line 12-34
export const UserProvider = ({ children }: React.PropsWithChildren) => {
  const isCurrentUserLoaded = useRecoilValue(isCurrentUserLoadedState);
  const location = useLocation();

  const { dateFormat, timeFormat, timeZone } = useDateTimeFormat();

  // line 18-22: å¦‚æœç”¨æˆ¶æœªè¼‰å…¥ä¸”ä¸åœ¨ç‰¹å®šè·¯å¾‘ï¼Œé¡¯ç¤º Loader
  return !isCurrentUserLoaded &&
    !isMatchingLocation(location, AppPath.Verify) &&
    !isMatchingLocation(location, AppPath.VerifyEmail) &&
    !isMatchingLocation(location, AppPath.CreateWorkspace) ? (
    <UserOrMetadataLoader />
  ) : (
    <UserContext.Provider value={{ dateFormat, timeFormat, timeZone }}>
      {children}
    </UserContext.Provider>
  );
};
```

**é‡é»**ï¼š`/verify` è·¯å¾‘è¢«æ’é™¤åœ¨ Loader æª¢æŸ¥ä¹‹å¤–ï¼Œæ‰€ä»¥å³ä½¿ `isCurrentUserLoaded` ç‚º falseï¼Œä¹Ÿä¸æœƒé¡¯ç¤º Loaderã€‚

---

## 6. å¾Œç«¯èªè­‰èˆ‡ Token è™•ç†

### 6.1 AuthResolver - getAuthTokensFromLoginToken

**æ–‡ä»¶**ï¼š`packages/twenty-server/src/engine/core-modules/auth/auth.resolver.ts`

```typescript
// line 549-600
@Mutation(() => AuthTokens)
@UseGuards(PublicEndpointGuard)
async getAuthTokensFromLoginToken(
  @Args() getAuthTokensFromLoginTokenInput: GetAuthTokensFromLoginTokenInput,
  @Args('origin') origin: string,
): Promise<AuthTokens> {
  const tokenPayload = await this.validateAndDecodeLoginToken(
    getAuthTokensFromLoginTokenInput.loginToken,
  );

  const workspace = await this.validateWorkspaceAccess(
    origin,
    tokenPayload.workspaceId,
  );

  const { user, userWorkspace } = await this.validateUserAccess(
    tokenPayload.sub,
    tokenPayload.workspaceId,
  );

  // ... é©—è­‰é‚è¼¯

  return await this.authService.verify(
    user.email,
    workspace.id,
    tokenPayload.authProvider,
  );
}
```

**æµç¨‹**ï¼š
1. é©—è­‰ loginToken
2. é©—è­‰ workspace å­˜å–æ¬Šé™
3. é©—è­‰ user å­˜å–æ¬Šé™
4. è¿”å› `AuthTokens` (accessToken + refreshToken)

### 6.2 å¾Œç«¯é…ç½®

**å•Ÿå‹•è…³æœ¬**ï¼š`start_all_service_start.sh`

```bash
# line 126-156: é—œéµç’°å¢ƒè®Šæ•¸
export SERVER_URL=${BACKEND_URL}
export FRONTEND_URL=${FRONTEND_URL}
export IS_MULTIWORKSPACE_ENABLED=${IS_MULTIWORKSPACE_ENABLED}
export DEFAULT_SUBDOMAIN=${DEFAULT_SUBDOMAIN}
```

**é…ç½®æ–‡ä»¶**ï¼š`twenty-config.sh`

```bash
# line 14: å¤–éƒ¨ä¸»æ©Ÿ
export EXTERNAL_HOST="118.168.188.27.nip.io"

# line 20-21: ç«¯å£
export FRONTEND_PORT=8866
export BACKEND_PORT=8867

# line 54: é»˜èªå­åŸŸå
export DEFAULT_SUBDOMAIN="app"
```

---

## 7. é—œéµå•é¡Œé»åˆ†æ

### ğŸ”´ å•é¡Œ 1ï¼šisCurrentUserLoadedState æœªè¢«è¨­ç½®

**ä½ç½®**ï¼š`useLoadCurrentUser.ts` (line 45-135)

**ç¾è±¡**ï¼š
- `loadCurrentUser()` å‡½æ•¸æˆåŠŸåŸ·è¡Œ
- æ‰€æœ‰ state éƒ½æ­£ç¢ºè¨­ç½® (currentUser, workspace, etc.)
- **ä½† `isCurrentUserLoadedState` æ²’æœ‰è¢«è¨­ç½®ç‚º true**

**å½±éŸ¿**ï¼š
- `UserAndViewsProviderEffect` çš„ `shouldSkip` æ¢ä»¶ (line 91-95) ä¾è³´ `isCurrentUserLoaded`
- å¦‚æœ `isCurrentUserLoaded` ç‚º falseï¼Œ`UserAndViewsProviderEffect` æœƒå˜—è©¦é‡æ–°è¼‰å…¥ç”¨æˆ¶
- ä½†å› ç‚º `useAuth` çš„ `loadCurrentUser` å·²ç¶“åŸ·è¡Œéï¼Œå¯èƒ½å°è‡´ç‹€æ…‹ä¸ä¸€è‡´

### ğŸ”´ å•é¡Œ 2ï¼šå°èˆªé‚è¼¯æœªè§¸ç™¼

**ä½ç½®**ï¼š`usePageChangeEffectNavigateLocation.ts` (line 134-141)

**æ¢ä»¶éˆ**ï¼š
```
onboardingStatus === COMPLETED
  â†“ ä¾è³´
currentUser?.onboardingStatus
  â†“ ä¾è³´
currentUserState (Recoil)
  â†“ è¨­ç½®æ–¼
loadCurrentUser() æˆ– UserAndViewsProviderEffect
```

**å•é¡Œ**ï¼š
- å¦‚æœ `loadCurrentUser()` æ²’æœ‰è¨­ç½® `isCurrentUserLoadedState`
- `UserAndViewsProviderEffect` å¯èƒ½æœƒé‡æ–°åŸ·è¡Œ
- ä½† `shouldSkip` æ¢ä»¶æœƒé˜»æ­¢å®ƒåœ¨ `/verify` è·¯å¾‘åŸ·è¡Œ (line 94)
- å°è‡´ `currentUser` å¯èƒ½æœªæ­£ç¢ºè¼‰å…¥ï¼Œ`onboardingStatus` ç‚º undefined
- å°èˆªé‚è¼¯ä¸æœƒè§¸ç™¼

### ğŸ”´ å•é¡Œ 3ï¼šé›™é‡ç”¨æˆ¶è¼‰å…¥æ©Ÿåˆ¶

**å…©å€‹è¼‰å…¥è·¯å¾‘**ï¼š

1. **useAuth â†’ loadCurrentUser (æ‰‹å‹•)**
   - ä½¿ç”¨ `useGetCurrentUserLazyQuery`
   - åœ¨ `handleLoadWorkspaceAfterAuthentication` ä¸­å‘¼å«
   - **ä¸è¨­ç½® `isCurrentUserLoadedState`**

2. **UserAndViewsProviderEffect (è‡ªå‹•)**
   - ä½¿ç”¨ `useGetCurrentUserQuery`
   - åœ¨ `AppRouterProviders` ä¸­è‡ªå‹•åŸ·è¡Œ
   - **è¨­ç½® `isCurrentUserLoadedState`**
   - ä½†æœ‰ `shouldSkip` æ¢ä»¶æœƒåœ¨ `/verify` è·¯å¾‘è·³é

**è¡çª**ï¼š
- åœ¨ `/verify` è·¯å¾‘ï¼Œ`UserAndViewsProviderEffect` è¢«è·³é
- `useAuth` çš„ `loadCurrentUser` åŸ·è¡Œï¼Œä½†ä¸è¨­ç½® `isCurrentUserLoadedState`
- å°è‡´ç³»çµ±èªç‚ºç”¨æˆ¶æœªè¼‰å…¥ï¼Œä½†å¯¦éš›ä¸Šå·²ç¶“è¼‰å…¥

### ğŸ”´ å•é¡Œ 4ï¼šé®ç½©é¡¯ç¤ºé‚è¼¯

**ä½ç½®**ï¼š`useShowAuthModal.ts` (line 18)

```typescript
isMatchingLocation(location, AppPath.Verify) ||  // åªè¦åœ¨ /verify å°±é¡¯ç¤º
```

**å•é¡Œ**ï¼š
- é®ç½©é¡¯ç¤ºå®Œå…¨åŸºæ–¼è·¯å¾‘
- ä¸è€ƒæ…®èªè­‰ç‹€æ…‹æˆ–ç”¨æˆ¶è¼‰å…¥ç‹€æ…‹
- åªè¦åœ¨ `/verify`ï¼Œé®ç½©å°±æœƒé¡¯ç¤º
- **å¿…é ˆå°èˆªé›¢é–‹ `/verify` æ‰èƒ½éš±è—é®ç½©**

---

## 8. å»ºè­°ä¿®å¾©æ–¹æ¡ˆ

### âœ… æ–¹æ¡ˆ 1ï¼šåœ¨ useLoadCurrentUser ä¸­è¨­ç½® isCurrentUserLoadedState

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/users/hooks/useLoadCurrentUser.ts`

**ä¿®æ”¹**ï¼š

```typescript
import { isCurrentUserLoadedState } from '@/auth/states/isCurrentUserLoadedState';
import { useSetRecoilState } from 'recoil';

export const useLoadCurrentUser = () => {
  // ... å…¶ä»– setters
  const setIsCurrentUserLoaded = useSetRecoilState(isCurrentUserLoadedState);

  const loadCurrentUser = useCallback(async () => {
    // ... ç¾æœ‰é‚è¼¯

    if (isDefined(coreViewsResult.data?.getCoreViews)) {
      setCoreViews(coreViewsResult.data.getCoreViews);
    }

    // âœ… æ–°å¢ï¼šè¨­ç½®ç”¨æˆ¶å·²è¼‰å…¥
    setIsCurrentUserLoaded(true);

    return { user, workspaceMember, workspace };
  }, [
    // ... ç¾æœ‰ deps
    setIsCurrentUserLoaded,  // âœ… æ–°å¢åˆ°ä¾è³´
  ]);

  return { loadCurrentUser };
};
```

**å„ªé»**ï¼š
- æœ€å°æ”¹å‹•
- ç¢ºä¿ `isCurrentUserLoadedState` æ­£ç¢ºè¨­ç½®
- è§¸ç™¼å¾ŒçºŒå°èˆªé‚è¼¯

**ç¼ºé»**ï¼š
- å¯èƒ½èˆ‡ `UserAndViewsProviderEffect` ç”¢ç”Ÿç«¶çˆ­æ¢ä»¶
- éœ€è¦ç¢ºä¿å…©å€‹è¼‰å…¥è·¯å¾‘ä¸æœƒè¡çª

### âœ… æ–¹æ¡ˆ 2ï¼šä¿®æ”¹ UserAndViewsProviderEffect çš„ shouldSkip æ¢ä»¶

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/users/components/UserAndViewsProviderEffect.tsx`

**ä¿®æ”¹**ï¼š

```typescript
// line 91-95
const shouldSkip =
  !isLoggedIn ||
  isCurrentUserLoaded ||
  // âŒ ç§»é™¤é€™å…©è¡Œ
  // isMatchingLocation(location, AppPath.Verify) ||
  // isMatchingLocation(location, AppPath.VerifyEmail);
```

**å„ªé»**ï¼š
- ç¢ºä¿ç”¨æˆ¶æ•¸æ“šåœ¨æ‰€æœ‰è·¯å¾‘éƒ½æœƒè¼‰å…¥
- çµ±ä¸€ç”¨æˆ¶è¼‰å…¥é‚è¼¯

**ç¼ºé»**ï¼š
- å¯èƒ½å°è‡´é‡è¤‡è¼‰å…¥
- éœ€è¦æ¸¬è©¦å°å…¶ä»–æµç¨‹çš„å½±éŸ¿

### âœ… æ–¹æ¡ˆ 3ï¼šä¿®æ”¹ VerifyLoginTokenEffect åœ¨æˆåŠŸå¾Œç«‹å³å°èˆª

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/auth/components/VerifyLoginTokenEffect.tsx`

**ä¿®æ”¹**ï¼š

```typescript
export const VerifyLoginTokenEffect = () => {
  const [searchParams] = useSearchParams();
  const loginToken = searchParams.get('loginToken');

  const isLogged = useIsLogged();
  const navigate = useNavigateApp();
  const { verifyLoginToken } = useVerifyLogin();
  const { defaultHomePagePath } = useDefaultHomePagePath();  // âœ… æ–°å¢

  const { isSaved: clientConfigLoaded } = useRecoilValue(
    clientConfigApiStatusState,
  );

  useEffect(() => {
    if (!clientConfigLoaded) return;

    if (isDefined(loginToken)) {
      verifyLoginToken(loginToken).then(() => {
        // âœ… æ–°å¢ï¼šé©—è­‰æˆåŠŸå¾Œç«‹å³å°èˆª
        navigate(defaultHomePagePath);
      });
    } else if (!isLogged) {
      navigate(AppPath.SignInUp);
    }
  }, [clientConfigLoaded, navigate, defaultHomePagePath]);  // âœ… æ›´æ–° deps

  return <></>;
};
```

**å„ªé»**ï¼š
- ç›´æ¥è§£æ±ºåœç•™åœ¨ `/verify` çš„å•é¡Œ
- ä¸ä¾è³´ `PageChangeEffect` çš„è¤‡é›œé‚è¼¯

**ç¼ºé»**ï¼š
- å¯èƒ½éæ—©å°èˆªï¼Œç”¨æˆ¶æ•¸æ“šå¯èƒ½æœªå®Œå…¨è¼‰å…¥
- éœ€è¦ç¢ºä¿ `loadCurrentUser` å®Œæˆå¾Œå†å°èˆª

### âœ… æ–¹æ¡ˆ 4ï¼šä¿®æ”¹ useVerifyLogin åœ¨æˆåŠŸå¾Œå°èˆª

**æ–‡ä»¶**ï¼š`packages/twenty-front/src/modules/auth/hooks/useVerifyLogin.ts`

**ä¿®æ”¹**ï¼š

```typescript
import { useDefaultHomePagePath } from '@/navigation/hooks/useDefaultHomePagePath';

export const useVerifyLogin = () => {
  const { enqueueErrorSnackBar } = useSnackBar();
  const navigate = useNavigateApp();
  const { getAuthTokensFromLoginToken } = useAuth();
  const { t } = useLingui();
  const { defaultHomePagePath } = useDefaultHomePagePath();  // âœ… æ–°å¢

  const verifyLoginToken = async (loginToken: string) => {
    try {
      await getAuthTokensFromLoginToken(loginToken);
      // âœ… æ–°å¢ï¼šæˆåŠŸå¾Œå°èˆª
      navigate(defaultHomePagePath);
    } catch {
      enqueueErrorSnackBar({
        message: t`Authentication failed`,
      });
      navigate(AppPath.SignInUp);
    }
  };

  return { verifyLoginToken };
};
```

**å„ªé»**ï¼š
- é›†ä¸­è™•ç†é©—è­‰å¾Œçš„å°èˆª
- ç¢ºä¿ token è¨­ç½®å®Œæˆå¾Œå†å°èˆª

**ç¼ºé»**ï¼š
- ä»ç„¶å¯èƒ½åœ¨ç”¨æˆ¶æ•¸æ“šå®Œå…¨è¼‰å…¥å‰å°èˆª
- éœ€è¦ç­‰å¾… `loadCurrentUser` å®Œæˆ

### âœ… æ–¹æ¡ˆ 5ï¼šçµ„åˆæ–¹æ¡ˆ (æ¨è–¦)

**æ­¥é©Ÿ 1**ï¼šåœ¨ `useLoadCurrentUser` ä¸­è¨­ç½® `isCurrentUserLoadedState`

**æ­¥é©Ÿ 2**ï¼šåœ¨ `useAuth.handleLoadWorkspaceAfterAuthentication` ä¸­ç­‰å¾…è¼‰å…¥å®Œæˆ

```typescript
const handleLoadWorkspaceAfterAuthentication = useCallback(
  async (authTokens: AuthTokenPair) => {
    handleSetAuthTokens(authTokens);

    await loadCurrentUser();
    await refreshObjectMetadataItems();

    // âœ… æ–°å¢ï¼šç¢ºä¿ç‹€æ…‹å·²æ›´æ–°
    // é€™è£¡å¯ä»¥æ·»åŠ ä¸€å€‹å°å»¶é²ï¼Œç¢ºä¿ Recoil state å·²ç¶“å‚³æ’­
  },
  [loadCurrentUser, handleSetAuthTokens, refreshObjectMetadataItems],
);
```

**æ­¥é©Ÿ 3**ï¼šä¾è³´ `PageChangeEffect` è‡ªå‹•å°èˆª

**å„ªé»**ï¼š
- ä¿æŒåŸæœ‰æ¶æ§‹
- ç¢ºä¿ç‹€æ…‹æ­£ç¢ºè¨­ç½®
- åˆ©ç”¨ç¾æœ‰çš„å°èˆªé‚è¼¯

**ç¼ºé»**ï¼š
- éœ€è¦å¤šè™•ä¿®æ”¹
- éœ€è¦ä»”ç´°æ¸¬è©¦

---

## 9. ç¸½çµ

### æ ¹æœ¬åŸå› 

1. **`useLoadCurrentUser` æ²’æœ‰è¨­ç½® `isCurrentUserLoadedState`**
2. **`UserAndViewsProviderEffect` åœ¨ `/verify` è·¯å¾‘è¢«è·³é**
3. **å°èˆªé‚è¼¯ä¾è³´ `onboardingStatus`ï¼Œä½† `currentUser` å¯èƒ½æœªæ­£ç¢ºè¼‰å…¥**
4. **é®ç½©é¡¯ç¤ºç´”ç²¹åŸºæ–¼è·¯å¾‘ï¼Œå¿…é ˆå°èˆªé›¢é–‹æ‰èƒ½éš±è—**

### å»ºè­°å„ªå…ˆç´š

1. **é«˜å„ªå…ˆç´š**ï¼šæ–¹æ¡ˆ 1 - åœ¨ `useLoadCurrentUser` ä¸­è¨­ç½® `isCurrentUserLoadedState`
2. **ä¸­å„ªå…ˆç´š**ï¼šæ–¹æ¡ˆ 4 - åœ¨ `useVerifyLogin` ä¸­æ·»åŠ å°èˆª
3. **ä½å„ªå…ˆç´š**ï¼šæ–¹æ¡ˆ 2 - ä¿®æ”¹ `UserAndViewsProviderEffect` çš„ `shouldSkip`

### æ¸¬è©¦æª¢æŸ¥é»

ä¿®å¾©å¾Œéœ€è¦é©—è­‰ï¼š

1. âœ… ç™»å…¥å¾Œèƒ½æ­£ç¢ºå°èˆªåˆ°é¦–é 
2. âœ… `isCurrentUserLoadedState` æ­£ç¢ºè¨­ç½®ç‚º true
3. âœ… `currentUser` åŒ…å«å®Œæ•´æ•¸æ“š
4. âœ… `onboardingStatus` æ­£ç¢º
5. âœ… é®ç½©æ­£ç¢ºéš±è—
6. âœ… ä¸å½±éŸ¿å…¶ä»–èªè­‰æµç¨‹ (Google, Microsoft, etc.)
7. âœ… ä¸å½±éŸ¿ onboarding æµç¨‹

---

## 10. é™„éŒ„ï¼šé—œéµæ–‡ä»¶æ¸…å–®

### å‰ç«¯æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾‘ | é—œéµå‡½æ•¸/çµ„ä»¶ |
|------|------|--------------|
| index.tsx | packages/twenty-front/src/index.tsx | root.render |
| App.tsx | packages/twenty-front/src/modules/app/components/App.tsx | App |
| AppRouter.tsx | packages/twenty-front/src/modules/app/components/AppRouter.tsx | AppRouter |
| useCreateAppRouter.tsx | packages/twenty-front/src/modules/app/hooks/useCreateAppRouter.tsx | useCreateAppRouter |
| AppRouterProviders.tsx | packages/twenty-front/src/modules/app/components/AppRouterProviders.tsx | AppRouterProviders |

### èªè­‰ç›¸é—œ

| æ–‡ä»¶ | è·¯å¾‘ | é—œéµå‡½æ•¸/çµ„ä»¶ |
|------|------|--------------|
| VerifyLoginTokenEffect.tsx | packages/twenty-front/src/modules/auth/components/VerifyLoginTokenEffect.tsx | VerifyLoginTokenEffect |
| useAuth.ts | packages/twenty-front/src/modules/auth/hooks/useAuth.ts | useAuth, handleGetAuthTokensFromLoginToken, handleLoadWorkspaceAfterAuthentication |
| useVerifyLogin.ts | packages/twenty-front/src/modules/auth/hooks/useVerifyLogin.ts | useVerifyLogin, verifyLoginToken |
| AuthProvider.tsx | packages/twenty-front/src/modules/auth/components/AuthProvider.tsx | AuthProvider |

### ç”¨æˆ¶è¼‰å…¥

| æ–‡ä»¶ | è·¯å¾‘ | é—œéµå‡½æ•¸/çµ„ä»¶ |
|------|------|--------------|
| useLoadCurrentUser.ts | packages/twenty-front/src/modules/users/hooks/useLoadCurrentUser.ts | useLoadCurrentUser, loadCurrentUser |
| UserProvider.tsx | packages/twenty-front/src/modules/users/components/UserProvider.tsx | UserProvider |
| UserAndViewsProviderEffect.tsx | packages/twenty-front/src/modules/users/components/UserAndViewsProviderEffect.tsx | UserAndViewsProviderEffect |

### è·¯ç”±èˆ‡å°èˆª

| æ–‡ä»¶ | è·¯å¾‘ | é—œéµå‡½æ•¸/çµ„ä»¶ |
|------|------|--------------|
| PageChangeEffect.tsx | packages/twenty-front/src/modules/app/effect-components/PageChangeEffect.tsx | PageChangeEffect |
| usePageChangeEffectNavigateLocation.ts | packages/twenty-front/src/hooks/usePageChangeEffectNavigateLocation.ts | usePageChangeEffectNavigateLocation |
| useOnboardingStatus.ts | packages/twenty-front/src/modules/onboarding/hooks/useOnboardingStatus.ts | useOnboardingStatus |

### UI Layout

| æ–‡ä»¶ | è·¯å¾‘ | é—œéµå‡½æ•¸/çµ„ä»¶ |
|------|------|--------------|
| DefaultLayout.tsx | packages/twenty-front/src/modules/ui/layout/page/components/DefaultLayout.tsx | DefaultLayout |
| useShowAuthModal.ts | packages/twenty-front/src/modules/ui/layout/hooks/useShowAuthModal.ts | useShowAuthModal |

### Recoil States

| æ–‡ä»¶ | è·¯å¾‘ | State åç¨± |
|------|------|-----------|
| isCurrentUserLoadedState.ts | packages/twenty-front/src/modules/auth/states/isCurrentUserLoadedState.ts | isCurrentUserLoadedState |
| tokenPairState.ts | packages/twenty-front/src/modules/auth/states/tokenPairState.ts | tokenPairState |
| currentUserState.ts | packages/twenty-front/src/modules/auth/states/currentUserState.ts | currentUserState |
| currentWorkspaceState.ts | packages/twenty-front/src/modules/auth/states/currentWorkspaceState.ts | currentWorkspaceState |

### å¾Œç«¯æ ¸å¿ƒ

| æ–‡ä»¶ | è·¯å¾‘ | é—œéµé¡/æ–¹æ³• |
|------|------|-----------|
| main.ts | packages/twenty-server/src/main.ts | bootstrap |
| app.module.ts | packages/twenty-server/src/app.module.ts | AppModule |
| auth.module.ts | packages/twenty-server/src/engine/core-modules/auth/auth.module.ts | AuthModule |
| auth.resolver.ts | packages/twenty-server/src/engine/core-modules/auth/auth.resolver.ts | AuthResolver, getAuthTokensFromLoginToken |
| workspace.service.ts | packages/twenty-server/src/engine/core-modules/workspace/services/workspace.service.ts | WorkspaceService |

### é…ç½®èˆ‡å•Ÿå‹•

| æ–‡ä»¶ | è·¯å¾‘ | ç”¨é€” |
|------|------|------|
| twenty-config.sh | /Users/ym/twenty-ym/twenty-config.sh | ç’°å¢ƒè®Šæ•¸é…ç½® |
| start_all_service_start.sh | /Users/ym/twenty-ym/start_all_service_start.sh | å•Ÿå‹•è…³æœ¬ |
| vite.config.ts | packages/twenty-front/vite.config.ts | å‰ç«¯æ§‹å»ºé…ç½® |

---

**å ±å‘ŠçµæŸ**

