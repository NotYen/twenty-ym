# 報價單功能 - 完整實施指南

## 📋 功能概述

本報價單系統包含以下完整功能：

✅ **核心功能**
- 報價單主記錄管理（Quote）
- 報價單明細項目管理（QuoteLineItem）
- 專業 PDF 格式導出（支持中英文、公司 Logo）
- 自動金額計算
- 狀態管理和工作流

✅ **自動化功能**
- 當項目變更時自動重新計算總額
- 過期時自動更新狀態
- 發送時自動郵件通知

---

## 🚀 實施步驟

### **第一步：創建數據庫對象（必須手動操作）**

請參考 `報價單功能_UI創建步驟.md` 文檔，在 Twenty UI 中創建：

1. **Quote 對象**（14 個字段）
2. **QuoteLineItem 對象**（7 個字段）

⚠️ **重要提醒**：
- Quote 的 API Name 必須是 `quote`
- QuoteLineItem 的 API Name 必須是 `quoteLineItem`
- 字段名稱必須使用駝峰式命名（如 `quoteNumber`、`productName`）

完成後，繼續下一步。

---

### **第二步：編譯前端代碼**

所有代碼文件已經創建完成，現在需要編譯：

```bash
cd /Users/ym/twenty-ym

# 編譯前端
npx nx build twenty-front

# 或啟動開發服務器
npx nx start twenty-front
```

等待編譯完成（約 2-3 分鐘）。

---

### **第三步：配置 Workflow 自動化（可選但推薦）**

請參考 `報價單功能_Workflow配置指南.md` 文檔，在 Twenty UI 中創建 3 個 Workflow：

1. **自動計算報價單總額**
2. **自動更新過期狀態**
3. **發送報價單郵件通知**

這些 Workflow 會大幅提升系統自動化程度。

---

### **第四步：測試功能**

#### 4.1 創建測試報價單

```
1. 刷新瀏覽器（Ctrl+Shift+R 硬刷新）
2. 左側菜單應該會出現「Quotes」選項
3. 點擊進入報價單列表頁
4. 點擊「+ New」創建新報價單
5. 填寫必要信息：
   - 報價單編號：Q-2025-001
   - 標題：網站開發專案報價
   - 客戶公司：選擇一個現有公司
   - 開立日期：今天
   - 有效期限：30 天後
   - 狀態：草稿（DRAFT）
   - 稅率：5
   - 小計：0（先填 0，後續會自動計算）
   - 總計：0（先填 0，後續會自動計算）
6. 點擊「Save」保存
```

#### 4.2 添加報價項目

```
1. 進入剛創建的報價單詳情頁
2. 找到「Quote Line Items」區域
3. 點擊「+ Add」添加項目：

項目 1：
- 產品名稱：網站首頁設計
- 描述：響應式首頁設計，包含5個區塊
- 數量：1
- 單價（輸入標準金額）：5000
  系統會自動轉換為微單位：5000000000
- 折扣：0
- 金額：5000（會自動計算）

項目 2：
- 產品名稱：內頁設計與開發
- 描述：10個內頁的設計和前端開發
- 數量：10
- 單價：800
- 折扣：0
- 金額：8000

項目 3：
- 產品名稱：後台管理系統
- 描述：CMS內容管理後台
- 數量：1
- 單價：3000
- 折扣：10（10% 折扣）
- 金額：2700
```

#### 4.3 測試 PDF 導出

```
1. 在報價單詳情頁
2. 點擊右上角的「⋮」（三個點）菜單
3. 應該會看到「Export as PDF」選項（PDF 圖標）
4. 點擊後會自動下載 PDF 文件（Quote-Q-2025-001.pdf）
5. 打開 PDF 檢查：
   ✅ 中文字體正常顯示
   ✅ 報價單編號、標題、日期正確
   ✅ 客戶信息完整
   ✅ 項目明細表格正確
   ✅ 金額計算正確（小計、稅金、總計）
   ✅ 條款說明和備註顯示
```

#### 4.4 測試自動計算（如果已配置 Workflow）

```
1. 修改某個 LineItem 的數量或單價
2. 保存後檢查 Quote 的金額是否自動更新
3. 添加新的 LineItem
4. 再次檢查 Quote 的總額是否正確
```

---

## 📁 已創建的文件清單

### **前端代碼文件**

```
packages/twenty-front/src/modules/

1. action-menu/actions/record-actions/single-record/quote-actions/
   ├── components/
   │   └── ExportQuoteToPdfSingleRecordAction.tsx    # 導出 Action 組件
   ├── templates/
   │   └── QuotePDFTemplate.tsx                       # PDF 模板（支持中英文、Logo）
   └── utils/
       └── exportQuoteToPdf.ts                        # 導出工具函數

2. action-menu/actions/record-actions/constants/
   └── QuoteActionsConfig.tsx                         # Action 配置

3. action-menu/actions/utils/
   └── getActionConfig.ts                             # 系統整合（已修改）

4. object-record/hooks/
   └── useQuoteCalculations.ts                        # 自動計算 Hook
```

### **文檔文件**

```
/Users/ym/twenty-ym/

1. 報價單功能_UI創建步驟.md                # UI 操作指南
2. 報價單功能_Workflow配置指南.md          # Workflow 配置詳解
3. 報價單功能_完整實施指南.md（本文件）     # 完整實施流程
```

---

## 🎨 PDF 模板功能說明

### **支持的功能**

1. **動態字體加載**
   - 中文：Noto Sans TC（繁體中文）
   - 英文：內建字體
   - 自動切換粗體和細體

2. **公司 Logo**
   - 支持在頁首顯示
   - 自動縮放適應
   - URL 可配置

3. **多語言支持**
   - 預設：繁體中文
   - 可選：英文
   - 所有標籤和格式都已翻譯

4. **專業排版**
   - A4 尺寸
   - 標準邊距
   - 響應式表格
   - 交替行顏色
   - 狀態徽章顯示

### **自定義 PDF 樣式**

如需修改 PDF 樣式，編輯以下文件：

```typescript
// packages/twenty-front/src/modules/action-menu/actions/record-actions/single-record/quote-actions/templates/QuotePDFTemplate.tsx

// 修改顏色
const styles = StyleSheet.create({
  page: {
    backgroundColor: '#ffffff', // 背景色
  },
  header: {
    borderBottom: '2 solid #4a5568', // 頁首邊框顏色
  },
  // ... 其他樣式
});

// 修改狀態顏色
const STATUS_COLORS: Record<string, string> = {
  DRAFT: '#718096',    // 草稿 - 灰色
  SENT: '#3182ce',     // 已發送 - 藍色
  ACCEPTED: '#38a169', // 已接受 - 綠色
  REJECTED: '#e53e3e', // 已拒絕 - 紅色
  EXPIRED: '#dd6b20',  // 已過期 - 橙色
};
```

### **添加公司 Logo**

修改 `ExportQuoteToPdfSingleRecordAction.tsx`：

```typescript
await exportQuoteToPdf({
  quote: {...},
  lineItems: [...],
  companyLogoUrl: 'https://your-company.com/logo.png', // 添加這行
  language: 'zh',
});
```

---

## 🔧 使用自動計算 Hook

在自定義表單或組件中使用計算功能：

```typescript
import { useQuoteCalculations } from '@/object-record/hooks/useQuoteCalculations';

const MyComponent = () => {
  const {
    calculateLineItemAmount,
    calculateQuoteAmounts,
    microsToAmount,
    amountToMicros,
  } = useQuoteCalculations();

  // 計算單個項目金額
  const lineItemAmountMicros = calculateLineItemAmount(
    10,        // 數量
    5000000,   // 單價（微單位）
    10         // 折扣 10%
  );

  // 計算報價單總額
  const { subtotalMicros, taxAmountMicros, totalMicros } = 
    calculateQuoteAmounts(lineItems, 5); // 5% 稅率

  // 轉換顯示
  const displayAmount = microsToAmount(totalMicros);
  console.log(`總計：$${displayAmount}`);
};
```

---

## 🐛 故障排除

### **問題 1：左側菜單沒有出現 Quotes 選項**

**原因**：對象沒有創建成功或前端沒有重新編譯

**解決方案**：
```bash
# 1. 確認對象已創建
Settings → Objects → 檢查是否有 Quote 和 QuoteLineItem

# 2. 重新編譯前端
cd /Users/ym/twenty-ym
npx nx build twenty-front

# 3. 硬刷新瀏覽器
Ctrl+Shift+R (Windows/Linux)
Cmd+Shift+R (Mac)
```

### **問題 2：操作菜單中沒有「Export as PDF」按鈕**

**原因**：對象名稱不匹配或系統配置未加載

**檢查項目**：
1. Quote 對象的 API Name Singular 必須是 `quote`（小寫）
2. 檢查瀏覽器控制台是否有錯誤
3. 確認前端已重新編譯

**解決方案**：
```bash
# 清除緩存重新編譯
rm -rf packages/twenty-front/node_modules/.vite
rm -rf packages/twenty-front/dist
npx nx build twenty-front --skip-nx-cache
```

### **問題 3：PDF 導出但是報錯**

**可能原因**：
- QuoteLineItem 關聯字段配置錯誤
- 必填字段缺少數據
- 貨幣字段格式錯誤

**解決方案**：
1. 打開瀏覽器開發者工具（F12）
2. 查看 Console 標籤的錯誤信息
3. 檢查 Network 標籤的 API 請求

**常見錯誤**：
```
Error: Cannot find quoteLineItem records
原因：QuoteLineItem 的 quote 關聯字段未正確配置
解決：重新配置 QuoteLineItem.quote 為 Many to One → Quote

Error: Missing required field: quoteNumber
原因：Quote 記錄缺少必填字段
解決：確保所有必填字段都有值
```

### **問題 4：PDF 中文字體顯示為方框**

**原因**：字體加載失敗

**解決方案**：
檢查網絡連接，字體是從 Google Fonts CDN 加載的。
如果需要離線字體，修改 `QuotePDFTemplate.tsx`：

```typescript
Font.register({
  family: 'Noto Sans TC',
  src: '/path/to/local/font.ttf', // 使用本地字體文件
});
```

### **問題 5：Workflow 沒有執行**

**檢查項目**：
1. Workflow 是否已激活（Active）
2. 觸發條件是否正確
3. 查看 Workflow Runs 日誌

**解決方案**：
```
Settings → Workflows → 選擇 Workflow
1. 檢查狀態是否為 Active
2. 點擊「Edit」檢查配置
3. 點擊「Runs」查看執行歷史
4. 查看錯誤日誌並根據提示修改
```

---

## 📊 數據結構說明

### **貨幣字段（Currency）**

Twenty 使用微單位（micros）存儲貨幣：
```
$1.00 = 1,000,000 micros
$100.50 = 100,500,000 micros
```

**轉換方法**：
```typescript
// 標準金額 → 微單位
const micros = amount * 1000000;

// 微單位 → 標準金額
const amount = micros / 1000000;

// 使用 Hook
const { amountToMicros, microsToAmount } = useQuoteCalculations();
const micros = amountToMicros(100.50);  // 100500000
const amount = microsToAmount(micros);   // 100.50
```

### **關聯字段（Relation）**

```typescript
// QuoteLineItem → Quote (Many to One)
{
  quote: { id: 'xxx' },     // 關聯對象
  quoteId: 'xxx'            // 外鍵（自動生成）
}

// Quote → QuoteLineItem (One to Many)
{
  lineItems: [              // 反向關聯（自動生成）
    { id: 'yyy' },
    { id: 'zzz' }
  ]
}
```

---

## 🎯 使用場景示例

### **場景 1：快速制作報價單**

```
1. Sales → Quotes → + New
2. 填寫基本信息（3分鐘）
3. 添加 3-5 個項目（5分鐘）
4. Export as PDF（10秒）
5. 發送給客戶
```

### **場景 2：從商機創建報價**

```
1. Opportunities → 選擇商機 → 進入詳情
2. Related Quotes 區域 → + Add Quote
3. 公司和聯絡人自動帶入
4. 添加項目並導出
```

### **場景 3：批量管理報價單**

```
1. Quotes → 列表頁
2. 使用篩選器：
   - 狀態 = DRAFT（查看草稿）
   - 有效期限 < 今天（查看過期）
   - 公司 = ABC（查看特定客戶）
3. 批量操作或逐個處理
```

---

## 📈 後續優化建議

### **短期（1-2週）**

1. **添加報價單編號自動生成**
   - 格式：Q-YYYY-MM-XXX
   - 使用 Workflow Code Action

2. **實現金額實時計算**
   - 在表單中集成 useQuoteCalculations Hook
   - 修改或添加項目時立即更新總額

3. **優化 PDF 樣式**
   - 添加公司 Logo
   - 自定義顏色主題
   - 添加頁碼和水印

### **中期（1個月）**

1. **審批流程**
   - 超過一定金額需要審批
   - 使用 Workflow 實現

2. **電子簽名**
   - 客戶線上簽署報價單
   - 記錄簽署時間和 IP

3. **報價轉訂單**
   - 一鍵將接受的報價轉為訂單
   - 自動創建專案

### **長期（3個月）**

1. **客戶自助門戶**
   - 客戶可查看報價單
   - 線上接受或拒絕
   - 提出修改請求

2. **AI 輔助報價**
   - 根據歷史數據建議價格
   - 自動生成項目描述
   - 預測成交概率

3. **高級分析**
   - 報價轉換率分析
   - 產品銷售排行
   - 銷售漏斗追蹤

---

## ✅ 完成檢查清單

### **必須完成（核心功能）**

- [ ] Quote 對象已創建（14 個字段）
- [ ] QuoteLineItem 對象已創建（7 個字段）
- [ ] 前端代碼已編譯
- [ ] 可以創建報價單
- [ ] 可以添加報價項目
- [ ] 可以導出 PDF
- [ ] PDF 內容正確（中文字體、格式、數據）

### **建議完成（自動化功能）**

- [ ] Workflow 1：自動計算總額
- [ ] Workflow 2：自動更新過期狀態
- [ ] Workflow 3：發送郵件通知
- [ ] 測試所有 Workflow 正常運作

### **可選完成（進階功能）**

- [ ] 添加公司 Logo 到 PDF
- [ ] 自定義 PDF 顏色和樣式
- [ ] 創建報價單模板
- [ ] 設置自動編號規則
- [ ] 配置審批流程

---

## 📞 技術支持

### **遇到問題時：**

1. **查看文檔**：先查看本指南的「故障排除」章節
2. **檢查日誌**：瀏覽器控制台和 Workflow Runs
3. **驗證配置**：對象名稱、字段名稱、關聯關係
4. **重新編譯**：清除緩存後重新編譯前端

### **提問時請提供：**

- 具體的錯誤信息（截圖或文字）
- 瀏覽器控制台的錯誤日誌
- 您執行的操作步驟
- 對象和字段的配置信息

---

## 🎉 恭喜完成！

您現在已經擁有一個功能完整的報價單系統，包括：

✅ 專業的數據管理
✅ 美觀的 PDF 導出
✅ 智能的自動化流程
✅ 靈活的擴展能力

開始使用吧！如有任何問題，歡迎隨時詢問。

---

**最後更新：** 2025-10-23  
**版本：** 1.0.0  
**維護者：** Twenty CRM Team

