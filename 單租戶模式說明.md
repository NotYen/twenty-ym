# Twenty CRM 單租戶模式配置說明

## ✅ 已完成的修改

### 1. 後端配置 (twenty-config.sh)
```bash
# 多租戶模式已關閉
export IS_MULTIWORKSPACE_ENABLED="false"
```

### 2. 後端環境變數 (packages/twenty-server/.env)
```bash
IS_MULTIWORKSPACE_ENABLED=false
```

### 3. 前端開發服務器配置 (packages/twenty-front/vite.config.ts)
```typescript
// 只允許 localhost 訪問
allowedHosts: ['localhost'],
```

---

## 🔄 重啟服務

**必須重啟所有服務才能讓配置生效！**

### 方式 1：使用現有腳本
```bash
# 停止所有服務
bash stop-twenty-local.sh

# 等待 3-5 秒確保所有進程完全停止
sleep 5

# 啟動所有服務
bash start_all_service_start.sh
```

### 方式 2：使用 twenty-config.sh
```bash
bash twenty-config.sh stop
sleep 5
bash twenty-config.sh start
```

---

## 🌐 訪問方式變更

### 單租戶模式下的訪問 URL

**本地開發**：
```
http://localhost:8866
```

**外部訪問**：
```
http://118.168.188.27.nip.io:8866
```

**⚠️ 注意**：單租戶模式下不再使用子域名，所有用戶訪問同一個 URL。

---

## 📊 單租戶 vs 多租戶對比

| 特性 | 單租戶模式 | 多租戶模式 |
|------|-----------|-----------|
| **Workspace 數量** | 只使用第一個 workspace | 多個 workspace，通過子域名區分 |
| **URL 格式** | `domain.com` | `workspace1.domain.com` |
| **適用場景** | 企業內部使用 | SaaS 服務，多客戶 |
| **Workspace 解析** | 固定第一個 workspace | 根據 subdomain/domain 動態解析 |
| **Domain 跳轉** | 無 | 自動跳轉到對應 workspace 域名 |

---

## 🔍 系統行為說明

### 後端行為
1. **所有請求都指向第一個 ACTIVE 的 workspace**
2. **不再根據 subdomain 查找 workspace**
3. **`DomainManagerService` 的 `getWorkspaceByOriginOrDefaultWorkspace` 方法直接返回默認 workspace**

### 前端行為
1. **不再進行 subdomain 檢查**
2. **不會執行 domain 跳轉邏輯**
3. **`isOnAWorkspace` 永遠為 `true`**

### 資料庫影響
- **資料庫中可能仍有多個 workspace**（這是正常的）
- **系統會自動選擇第一個 ACTIVE 的 workspace**
- **其他 workspace 不會被使用，但也不會被刪除**

查看當前的 workspace：
```sql
SELECT id, "displayName", subdomain, "activationStatus", "createdAt"
FROM core.workspace 
WHERE "activationStatus" = 'ACTIVE'
ORDER BY "createdAt" ASC;
```

---

## 💡 使用建議

### 你的場景：「一個客戶就是一個 workspace」

在單租戶模式下，每個部署實例對應一個客戶：

```
客戶 A -> Twenty CRM 實例 1 (使用 workspace1)
客戶 B -> Twenty CRM 實例 2 (使用 workspace1) 
客戶 C -> Twenty CRM 實例 3 (使用 workspace1)
```

**每個客戶需要**：
- 獨立的服務器/容器
- 獨立的數據庫
- 獨立的部署實例

**優點**：
- ✅ 數據完全隔離
- ✅ 性能獨立，互不影響
- ✅ 可以為不同客戶定制不同版本
- ✅ 安全性更高

**缺點**：
- ❌ 部署和維護成本較高
- ❌ 需要更多服務器資源

---

## 🔙 如何恢復多租戶模式

如果之後想恢復多租戶模式：

1. 修改 `twenty-config.sh`：
   ```bash
   export IS_MULTIWORKSPACE_ENABLED="true"
   ```

2. 修改 `packages/twenty-server/.env`：
   ```bash
   IS_MULTIWORKSPACE_ENABLED=true
   ```

3. 修改 `packages/twenty-front/vite.config.ts`：
   ```typescript
   allowedHosts: ['.nip.io', '.localhost', 'localhost'],
   ```

4. 重啟所有服務

---

## ✅ 驗證配置

重啟服務後，檢查以下內容：

### 1. 後端 API 配置
```bash
curl -s "http://localhost:8867/client-config" | python3 -c "import sys, json; data=json.load(sys.stdin); print('isMultiWorkspaceEnabled:', data.get('isMultiWorkspaceEnabled'))"
```
應該顯示：`isMultiWorkspaceEnabled: False`

### 2. 訪問測試
```bash
# 應該可以正常訪問
curl -I http://localhost:8866
# 或
curl -I http://118.168.188.27.nip.io:8866
```

### 3. 登入測試
使用瀏覽器訪問並登入，確認可以正常使用。

---

## 📝 注意事項

1. **必須重啟服務才能生效** - 配置更改後需要完全重啟前端和後端
2. **URL 訪問方式改變** - 不再使用子域名
3. **現有用戶不受影響** - 資料庫中的用戶和數據保持不變
4. **多個 workspace 仍然存在** - 但只有第一個會被使用

---

**修改完成時間**: 2025-10-15
**修改內容**: 關閉多租戶模式，切換到單租戶模式

