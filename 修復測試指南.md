# 修復測試指南

## ✅ 修復已完成

**修改文件**: `packages/twenty-front/src/modules/users/hooks/useLoadCurrentUser.ts`

**修改內容**:
1. ✅ 新增 import: `isCurrentUserLoadedState`
2. ✅ 新增 setter: `setIsCurrentUserLoaded`
3. ✅ 在 `loadCurrentUser` 函數結尾添加: `setIsCurrentUserLoaded(true)`
4. ✅ 將 `setIsCurrentUserLoaded` 添加到依賴陣列

**修改統計**:
- 新增行數: 4 行
- 修改文件: 1 個
- 無 Linter 錯誤

---

## 🧪 測試步驟

### 測試 1: 主要問題 - 登入後遮罩

**步驟**:
1. 清除瀏覽器 cookies 和 localStorage
2. 訪問: `http://apple.118.168.188.27.nip.io:8866/`
3. 輸入帳號密碼: `tim@apple.dev` / 密碼
4. 點擊登入

**預期結果**:
- ✅ 登入成功後，URL 會從 `/verify` 自動跳轉到首頁 (例如 `/objects/companies`)
- ✅ 遮罩消失
- ✅ 可以正常操作系統

**如果失敗**:
- 停留在 `/verify` 路徑 → 說明導航邏輯仍有問題
- 看到遮罩 → 確認是否在 `/verify` 路徑

---

### 測試 2: 檢查瀏覽器 Console (進階)

**在登入過程中，打開瀏覽器 Console (F12)**:

**執行以下命令檢查 Recoil State**:

```javascript
// 1. 檢查是否已登入
console.log('Token Pair:', 
  JSON.parse(localStorage.getItem('tokenPair') || 'null')
);

// 2. 檢查當前路徑
console.log('Current Path:', window.location.pathname);

// 3. 如果有 Recoil DevTools，檢查 state
// (需要先安裝 Recoil DevTools 瀏覽器擴展)
```

**預期 Console 輸出**:
- `Token Pair`: 應該包含 `accessOrWorkspaceAgnosticToken` 和 `refreshToken`
- `Current Path`: 登入後應該是 `/objects/companies` 或類似路徑，**不是** `/verify`

---

### 測試 3: 檢查 Network 請求

**在 Chrome DevTools → Network 標籤**:

**觀察以下請求**:
1. `getAuthTokensFromLoginToken` - 應該返回 200
2. `getCurrentUser` - 應該返回 200，包含用戶數據
3. `getCoreViews` - 應該返回 200
4. `refreshObjectMetadataItems` - 應該返回 200

**如果看到錯誤**:
- 401/403 → 認證問題
- 500 → 後端錯誤
- Network Error → 連接問題

---

### 測試 4: 刷新頁面 (已登入狀態)

**步驟**:
1. 登入成功後
2. 按 F5 刷新頁面

**預期結果**:
- ✅ 頁面正常載入
- ✅ 不會跳轉到登入頁
- ✅ 用戶數據正確顯示

---

### 測試 5: 登出再登入

**步驟**:
1. 點擊右上角頭像 → 登出
2. 再次登入

**預期結果**:
- ✅ 登出成功，跳轉到登入頁
- ✅ 登入成功，正常進入系統

---

## 🐛 問題排查

### 問題 1: 仍然看到遮罩

**可能原因**:
1. 瀏覽器快取未清除
2. 停留在 `/verify` 路徑

**解決方案**:
```bash
# 1. 清除瀏覽器快取
# Chrome: Ctrl+Shift+Delete → 清除所有數據

# 2. 重啟服務
cd /Users/ym/twenty-ym
bash twenty-config.sh restart
```

### 問題 2: 前端無法訪問

**檢查服務狀態**:
```bash
# 檢查端口
lsof -ti:8866,8867

# 查看日誌
tail -f /Users/ym/twenty-ym/twenty.log
```

### 問題 3: 登入後 401 錯誤

**可能原因**:
- Token 驗證失敗
- 後端認證配置問題

**解決方案**:
```bash
# 檢查後端日誌
tail -f /Users/ym/twenty-ym/twenty.log | grep -i error

# 重置 Redis 快取
redis-cli FLUSHALL
```

---

## 📊 驗證修復成功的標誌

### ✅ 成功標誌

1. **登入流程順暢**
   - 輸入帳密 → 短暫停留 `/verify` → 自動跳轉首頁
   - 全程無遮罩阻擋

2. **Console 無錯誤**
   - 無 GraphQL 錯誤
   - 無 React 錯誤
   - 無 Network 錯誤

3. **State 正確設置**
   - `isCurrentUserLoaded` 為 true
   - `currentUser` 包含完整數據
   - `currentWorkspace` 包含 workspace 數據

### ❌ 失敗標誌

1. **停留在 `/verify`**
   - 說明導航邏輯未觸發
   - 需要進一步調查

2. **遮罩仍然存在**
   - 確認當前路徑
   - 檢查 `useShowAuthModal` 返回值

3. **Console 有錯誤**
   - 查看具體錯誤信息
   - 可能需要額外修復

---

## 🔄 如果修復失敗

### 回滾步驟

```bash
cd /Users/ym/twenty-ym

# 1. 查看修改
git diff packages/twenty-front/src/modules/users/hooks/useLoadCurrentUser.ts

# 2. 回滾修改
git checkout packages/twenty-front/src/modules/users/hooks/useLoadCurrentUser.ts

# 3. 重啟服務
bash twenty-config.sh restart
```

### 替代方案

如果這個修復不起作用，我們可以嘗試：

**方案 A**: 在 `useVerifyLogin` 中添加導航
**方案 B**: 修改 `UserAndViewsProviderEffect` 的 `shouldSkip` 邏輯
**方案 C**: 在 `PageChangeEffect` 中添加額外的導航條件

---

## 📝 測試報告模板

請完成以下測試並記錄結果：

```
【測試 1: 登入流程】
- 測試時間: __________
- 結果: ⬜ 成功 / ⬜ 失敗
- 現象: __________

【測試 2: Console 檢查】
- Token Pair: ⬜ 正常 / ⬜ 異常
- Current Path: __________
- 錯誤信息: __________

【測試 3: Network 請求】
- getAuthTokensFromLoginToken: ⬜ 200 / ⬜ 錯誤
- getCurrentUser: ⬜ 200 / ⬜ 錯誤
- 其他問題: __________

【測試 4: 刷新頁面】
- 結果: ⬜ 正常 / ⬜ 異常
- 現象: __________

【測試 5: 登出再登入】
- 結果: ⬜ 正常 / ⬜ 異常
- 現象: __________

【總體評價】
- 修復是否成功: ⬜ 是 / ⬜ 否
- 額外發現: __________
```

---

## 🎯 下一步

**如果測試成功**:
1. ✅ 問題解決！
2. 可以考慮提交 PR 到 Twenty 官方倉庫
3. 記錄這次修復經驗

**如果測試失敗**:
1. 收集詳細的錯誤信息
2. 截圖或錄製問題現象
3. 我們一起分析並嘗試替代方案

---

**測試愉快！如有任何問題，隨時告訴我。** 🚀

