# 多租戶模式 - 報價單功能問題說明與部署指南

## 目錄
1. [問題說明](#問題說明)
2. [核心原因分析](#核心原因分析)
3. [解決方案](#解決方案)
4. [部署到新機器完整流程](#部署到新機器完整流程)

---

## 問題說明

### 現象
在 Y-CRM 從單租戶升級到多租戶模式後，新建立的 workspace 左側導航欄不會顯示：
- 報價單列表 (Sales Quotes)
- 報價單細項列表 (Sales Quote Line Items)

### 影響範圍
- 新建立的 workspace 無法看到報價單功能
- 現有 workspace 如果沒有手動修復，也可能缺少這些功能

---

## 核心原因分析

### 1. Favorites 未被創建
左側導航欄顯示的物件來自 `favorite` 資料表，而非直接顯示所有 object metadata。

當 workspace 建立時：
- ✅ Object metadata 已正確建立
- ✅ Views 已正確建立
- ❌ Favorites 未被建立 → 導致左側看不到

### 2. View 建立函數會拋出錯誤
原本的 `salesQuotesAllView` 和 `salesQuoteLineItemsAllView` 函數在找不到 metadata 時會 `throw new Error()`，這會導致整個 `prefillCoreViews` 流程中斷。

```typescript
// 原本的問題代碼
const salesQuoteObjectMetadata = objectMetadataMap.get('salesQuote');
if (!salesQuoteObjectMetadata) {
  throw new Error('Sales quote object metadata not found');  // ❌ 會中斷整個流程
}
```

### 3. View Fields 的 fieldMetadataId 為空
部分 view fields（如 `mingCheng` 和 `company`）的 `fieldMetadataId` 為空，導致這些欄位無法正確顯示。

---

## 解決方案

### 修復 1：修改 View 建立函數（防止錯誤中斷）

**檔案**: `packages/twenty-server/src/engine/workspace-manager/standard-objects-prefill-data/views/sales-quotes-all.view.ts`

修改為找不到 metadata 時返回 `null` 而非拋出錯誤：

```typescript
const salesQuoteObjectMetadata = objectMetadataMap.get('salesQuote');
if (!salesQuoteObjectMetadata) {
  return null;  // ✅ 返回 null，不中斷流程
}
```

**檔案**: `packages/twenty-server/src/engine/workspace-manager/standard-objects-prefill-data/views/sales-quote-line-items-all.view.ts`

同樣修改為返回 `null`。

### 修復 2：修改 prefillCoreViews 過濾 null 值

**檔案**: `packages/twenty-server/src/engine/workspace-manager/standard-objects-prefill-data/prefill-core-views.ts`

```typescript
const views = [
  // ... 其他 views
  salesQuotesAllView(...),
  salesQuoteLineItemsAllView(...),
].filter((view) => view !== null);  // ✅ 過濾掉 null 值
```

### 修復 3：建立補救命令（為現有 workspace 補充）

**新增檔案**: `packages/twenty-server/src/database/commands/seed-sales-quote-views.command.ts`

這個命令會：
1. 掃描所有現有 workspace
2. 檢查是否缺少報價單相關的 views 和 favorites
3. 自動補充缺少的資料

執行方式：
```bash
yarn command:prod workspace:seed-sales-quote-views
```

### 修復 4：整合到部署腳本

**檔案**: `docker/dev-flow/aws/deploy-to-aws.sh`

在部署流程中自動執行：
```bash
# 同步 metadata
docker compose -f docker-compose.aws.yml exec backend yarn command:prod workspace:sync-metadata || true

# 為現有 workspace 補充報價單 views
docker compose -f docker-compose.aws.yml exec backend yarn command:prod workspace:seed-sales-quote-views || true
```

---

## 部署到新機器完整流程

### 前置準備

1. **確認本地環境**
   - 確保本地代碼已包含上述修復
   - 確保 `docker/env.aws` 配置正確

2. **確認 AWS 環境**
   - SSH key 位於 `~/.ssh/y-crm-aws-key.pem`
   - AWS 機器已安裝 Docker 和 Docker Compose

### 步驟 1：本地構建 AMD64 映像

```bash
cd /Users/ym/twenty-ym/docker/dev-flow/aws
./build-amd64-images.sh
```

這會產生兩個 tag，例如：
- `backend-20251216-v1-amd64`
- `frontend-20251216-v1-amd64`

### 步驟 2：推送映像到 Docker Hub

```bash
docker push ycrm/y-crm:backend-20251216-v1-amd64
docker push ycrm/y-crm:frontend-20251216-v1-amd64
```

### 步驟 3：部署到 AWS

```bash
cd /Users/ym/twenty-ym/docker/dev-flow/aws
./deploy-to-aws.sh \
  --backend-tag backend-20251216-v1-amd64 \
  --frontend-tag frontend-20251216-v1-amd64
```

**注意**：
- 不要加 `--sync-data`，除非你確定要覆蓋 AWS 上的所有資料
- 腳本會自動執行：
  1. 拉取新映像
  2. 重啟服務
  3. 執行資料庫遷移 (`yarn database:migrate:prod`)
  4. 同步 metadata (`yarn command:prod workspace:sync-metadata`)
  5. 補充報價單 views (`yarn command:prod workspace:seed-sales-quote-views`)

### 步驟 4：驗證部署

1. **檢查服務狀態**
   ```bash
   ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@52.195.151.185
   docker compose -f docker-compose.aws.yml ps
   ```

2. **檢查日誌**
   ```bash
   docker compose -f docker-compose.aws.yml logs -f backend
   ```

3. **測試新 workspace**
   - 登入系統建立新 workspace
   - 確認左側導航欄有「報價單列表」和「報價單細項列表」

### 如果新 workspace 仍然沒有報價單功能

手動執行補救命令：
```bash
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@52.195.151.185
docker compose -f docker-compose.aws.yml exec backend yarn command:prod workspace:seed-sales-quote-views
```

---

## 相關檔案清單

| 檔案 | 說明 |
|------|------|
| `packages/twenty-server/src/engine/workspace-manager/standard-objects-prefill-data/views/sales-quotes-all.view.ts` | 報價單 view 定義 |
| `packages/twenty-server/src/engine/workspace-manager/standard-objects-prefill-data/views/sales-quote-line-items-all.view.ts` | 報價單細項 view 定義 |
| `packages/twenty-server/src/engine/workspace-manager/standard-objects-prefill-data/prefill-core-views.ts` | 核心 views 預填充邏輯 |
| `packages/twenty-server/src/database/commands/seed-sales-quote-views.command.ts` | 補救命令 |
| `docker/dev-flow/aws/deploy-to-aws.sh` | AWS 部署腳本 |
| `docker/dev-flow/aws/build-amd64-images.sh` | AMD64 映像構建腳本 |
| `docker/dev-flow/local/run-local.sh` | 本地開發環境腳本 |

---

## 常見問題

### Q: 為什麼不直接在 object metadata 層面解決？
A: 左側導航欄的顯示邏輯是讀取 `favorite` 資料表，這是 Twenty CRM 的設計。我們需要確保 favorites 被正確建立。

### Q: --sync-data 什麼時候該用？
A: 只有在以下情況才使用：
- 全新部署，AWS 上沒有任何資料
- 確定要用本地資料完全覆蓋 AWS 資料
- **絕對不要**在有正式用戶資料時使用

### Q: 如何確認修復是否生效？
A: 建立新 workspace 後，左側導航欄應該立即顯示「報價單列表」和「報價單細項列表」，無需任何手動操作。
