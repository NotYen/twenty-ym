# 本次修改總結文檔

## 修改日期
2026-01-07

---

## 一、問題描述

### 問題 1：報價單計算邏輯錯誤
原本的計算邏輯是錯誤的：
- ❌ 監聽「總計」(zongJi) → 計算「稅額」(shuiJin)

正確的計算邏輯應該是：
- ✅ 監聽「小計」(xiaoJi) 和「稅率」(shuiLu) → 計算「稅額」和「總計」

### 問題 2：isLabelSyncedWithName 驗證錯誤
在「設定 > 數據模型」修改報價單欄位設定時出現錯誤：
> 「更新後的欄位名稱與標籤不同步」

**根本原因**：
- 報價單欄位使用中文拼音命名（如 `zongJi`），但 label 是英文（如 `Total`）
- `computeMetadataNameFromLabel("Total")` = `total`，不等於 `zongJi`
- 所以 `isLabelSyncedWithName` 應該是 `false`
- 但資料庫中某些記錄的值是 `true`，導致驗證失敗

---

## 二、修正內容

### 2.1 報價單詳情頁計算 Effect

**檔案**：`packages/twenty-front/src/modules/object-record/record-show/components/SalesQuoteTaxCalculationEffect.tsx`

**修正內容**：
- 改為監聽 `xiaoJi`（小計）和 `shuiLu`（稅率）
- 自動計算 `shuiJin`（稅額）= 小計 × 稅率
- 自動計算 `zongJi`（總計）= 小計 + 稅額

### 2.2 報價單列表頁計算 Effect

**檔案**：`packages/twenty-front/src/modules/object-record/record-show/components/SalesQuoteTaxCalculationRowEffect.tsx`

**修正內容**：
- 改為監聯 `xiaoJi`（小計）和 `shuiLu`（稅率）
- 自動計算 `shuiJin`（稅額）和 `zongJi`（總計）
- 將 `console.log` 改為 `logDebug`（遵守開發規則）

### 2.3 欄位儲存時的計算邏輯

**檔案**：`packages/twenty-front/src/modules/object-record/record-field/ui/hooks/usePersistField.ts`

**修正內容**：
- `getSalesQuoteTaxSyncPayload` 函數改為監聽小計和稅率欄位
- 新增 `SALES_QUOTE_SUBTOTAL_FIELD_NAME = 'xiaoJi'` 常數
- 計算公式：
  - 稅額 = 小計 × 稅率
  - 總計 = 小計 + 稅額

---

## 三、計算公式

```
稅額 (shuiJin) = 小計 (xiaoJi) × 稅率 (shuiLu)
總計 (zongJi) = 小計 (xiaoJi) + 稅額 (shuiJin)
```

**範例**：
- 小計 = 10,000
- 稅率 = 0.05 (5%)
- 稅額 = 10,000 × 0.05 = 500
- 總計 = 10,000 + 500 = 10,500

---

## 四、isLabelSyncedWithName 修正

### 4.1 問題說明

Twenty 的欄位驗證機制會檢查 `isLabelSyncedWithName`：
- 如果 `isLabelSyncedWithName = true`，系統會驗證 `name` 是否等於 `computeMetadataNameFromLabel(label)`
- 中文拼音欄位名稱（如 `zongJi`）與英文 label（如 `Total`）不匹配，所以應該是 `false`

### 4.2 解決方案

**方案**：用 SQL 修正現有資料庫中的 `isLabelSyncedWithName = false`

這個方案符合 Twenty 開源的設計理念：
- `isLabelSyncedWithName` 本來就是用來標記「name 是否與 label 同步」
- 中文拼音欄位名稱本來就不應該與英文 label 同步
- 新建 workspace 時，程式碼會自動計算正確的值

### 4.3 本地 SQL 修正

```sql
-- 查詢需要修正的記錄
SELECT fm.id, fm.name, fm."isLabelSyncedWithName", om."nameSingular"
FROM core."fieldMetadata" fm
JOIN core."objectMetadata" om ON fm."objectMetadataId" = om.id
WHERE om."nameSingular" IN ('salesQuote', 'salesQuoteLineItem')
AND fm.name IN (
  'zongJi', 'xiaoJi', 'shuiLu', 'shuiJin',
  'baoJiaDanHao', 'baoJiaDanZhuangTai', 'baoJiaRiQi', 'beiZhu',
  'jiaoYiTiaoJian', 'jieZhiRiQi', 'mingCheng', 'fuZeYeWu',
  'baoJiaDanXiXiangMiaoShu', 'chanPinMingCheng', 'danJia', 'jinE', 'shuLiang', 'zheKou',
  'baoJiaDanGuanLian'
)
AND fm."isLabelSyncedWithName" = true;

-- 執行修正
UPDATE core."fieldMetadata"
SET "isLabelSyncedWithName" = false
WHERE "objectMetadataId" IN (
  SELECT id FROM core."objectMetadata"
  WHERE "nameSingular" IN ('salesQuote', 'salesQuoteLineItem')
)
AND name IN (
  'zongJi', 'xiaoJi', 'shuiLu', 'shuiJin',
  'baoJiaDanHao', 'baoJiaDanZhuangTai', 'baoJiaRiQi', 'beiZhu',
  'jiaoYiTiaoJian', 'jieZhiRiQi', 'mingCheng', 'fuZeYeWu',
  'baoJiaDanXiXiangMiaoShu', 'chanPinMingCheng', 'danJia', 'jinE', 'shuLiang', 'zheKou',
  'baoJiaDanGuanLian'
)
AND "isLabelSyncedWithName" = true;
```

### 4.4 AWS SQL 修正（部署後執行）

```bash
# SSH 連線到 AWS
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@52.195.151.185

# 進入 postgres 容器執行 SQL
docker exec -it Y-CRM-postgres psql -U postgres -d default
```

```sql
-- 執行相同的 UPDATE 語句
UPDATE core."fieldMetadata"
SET "isLabelSyncedWithName" = false
WHERE "objectMetadataId" IN (
  SELECT id FROM core."objectMetadata"
  WHERE "nameSingular" IN ('salesQuote', 'salesQuoteLineItem')
)
AND name IN (
  'zongJi', 'xiaoJi', 'shuiLu', 'shuiJin',
  'baoJiaDanHao', 'baoJiaDanZhuangTai', 'baoJiaRiQi', 'beiZhu',
  'jiaoYiTiaoJian', 'jieZhiRiQi', 'mingCheng', 'fuZeYeWu',
  'baoJiaDanXiXiangMiaoShu', 'chanPinMingCheng', 'danJia', 'jinE', 'shuLiang', 'zheKou',
  'baoJiaDanGuanLian'
)
AND "isLabelSyncedWithName" = true;
```

### 4.5 修正後清除 Cache

```bash
# 清除 Redis cache
docker exec Y-CRM-redis redis-cli FLUSHALL

# 重啟服務
docker compose restart backend worker
sleep 10

# 重新註冊 CRON jobs
docker compose exec backend yarn command:prod cron:register:all

# 驗證 CRON jobs
docker exec Y-CRM-redis redis-cli KEYS 'bull:cron-queue:repeat:*' | wc -l
```

---

## 五、影響範圍

### 修改的檔案
1. `packages/twenty-front/src/modules/object-record/record-show/components/SalesQuoteTaxCalculationEffect.tsx`
2. `packages/twenty-front/src/modules/object-record/record-show/components/SalesQuoteTaxCalculationRowEffect.tsx`
3. `packages/twenty-front/src/modules/object-record/record-field/ui/hooks/usePersistField.ts`

### 影響的功能
- 報價單詳情頁的自動計算
- 報價單列表頁的自動計算
- 報價單欄位儲存時的自動計算
- 數據模型欄位設定（不再出現驗證錯誤）

### 不影響的功能
- 報價單細項（LineItem）的計算邏輯（原本就是正確的）
- 其他 Standard Objects
- Line@ 整合功能
- 其他已有功能

---

## 六、驗證項目

### 6.1 報價單計算邏輯
1. 新增報價單，輸入小計和稅率
2. 確認稅額和總計自動計算正確
3. 修改小計，確認稅額和總計自動更新
4. 修改稅率，確認稅額和總計自動更新

### 6.2 數據模型欄位設定
1. 進入「設定 > 數據模型 > 報價單」
2. 修改任一欄位設定（如 short → full）
3. 確認不再出現「欄位名稱與標籤不同步」錯誤

### 6.3 新建 Workspace
1. 新建一個 workspace
2. 確認報價單欄位的 `isLabelSyncedWithName` 自動設為 `false`
3. 確認數據模型欄位設定正常

---

## 七、注意事項

1. **新建 workspace 會正常**：程式碼會自動計算 `isLabelSyncedWithName = false`
2. **現有 workspace 需要 SQL 修正**：本地和 AWS 都需要執行
3. **部署到 AWS 後**：需要執行 SQL 修正 + 清除 cache + 重新註冊 CRON jobs
4. **遵守開發規則**：使用 `logDebug` 而非 `console.log`
