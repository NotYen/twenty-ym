# ğŸ¯ Y-CRM Docker æ˜ åƒæ§‹å»ºå®Œæ•´ç¸½çµ

**æ›´æ–°æ™‚é–“**ï¼š2025-11-12 20:05

---

## âœ… æœå‹™æ¶æ§‹åˆ†æ

### æ‚¨çš„æœ¬åœ° Docker æœå‹™ï¼ˆå…± 5 å€‹å®¹å™¨ï¼‰

æ ¹æ“š `docker compose ps` çš„çµæœï¼š

| å®¹å™¨åç¨± | æ˜ åƒ | èªªæ˜ | æ˜¯å¦éœ€è¦ Build |
|---------|------|------|---------------|
| Y-CRM-postgres | postgres:16-alpine | PostgreSQL è³‡æ–™åº« | âŒ ä½¿ç”¨å®˜æ–¹æ˜ åƒ |
| Y-CRM-redis | redis:7-alpine | Redis å¿«å– | âŒ ä½¿ç”¨å®˜æ–¹æ˜ åƒ |
| Y-CRM-backend | twenty-backend:latest | API æœå‹™ | âœ… éœ€è¦ Build |
| Y-CRM-worker | twenty-backend:latest | èƒŒæ™¯ä»»å‹™è™•ç† | âš ï¸ **ä½¿ç”¨ Backend ç›¸åŒæ˜ åƒ** |
| Y-CRM-frontend | y-crm-company-docker-frontend | å‰ç«¯æœå‹™ | âœ… éœ€è¦ Build |

### é—œéµç™¼ç¾

**Worker å’Œ Backend ä½¿ç”¨åŒä¸€å€‹æ˜ åƒï¼**

æŸ¥çœ‹ `docker-compose.yml` ç™¼ç¾ï¼š
- Backend (line 64-79): 
  - `build` from `docker/backend/Dockerfile`
  - åŸ·è¡Œï¼š`node dist/src/main.js` (API æœå‹™)
  
- Worker (line 81-94):
  - `image: twenty-backend:latest` â† **å¼•ç”¨ Backend æ˜ åƒ**
  - åŸ·è¡Œï¼š`node dist/src/queue-worker/queue-worker.js` (èƒŒæ™¯ä»»å‹™)

**çµè«–ï¼šåªéœ€è¦ Build 2 å€‹è‡ªè¨‚æ˜ åƒ**

---

## ğŸ“¦ å·²å®Œæˆçš„æ˜ åƒæ§‹å»º

### 1ï¸âƒ£ Backend æ˜ åƒï¼ˆåŒ…å« Worker åŠŸèƒ½ï¼‰

```bash
âœ… æ˜ åƒï¼šycrm/y-crm:backend-20251112-amd64
ğŸ“¦ å¤§å°ï¼š9.13 GB
ğŸ—ï¸ æ¶æ§‹ï¼šlinux/amd64 (AWS x86_64 ç›¸å®¹)
â±ï¸ Build æ™‚é–“ï¼šç´„ 10 åˆ†é˜
ğŸ¯ ç”¨é€”ï¼š
   - Backend API æœå‹™ (Y-CRM-backend)
   - Worker èƒŒæ™¯ä»»å‹™ (Y-CRM-worker)
```

**Build å‘½ä»¤**ï¼š
```bash
docker buildx build --platform linux/amd64 \
  -f docker/backend/Dockerfile \
  -t ycrm/y-crm:backend-20251112-amd64 \
  --push .
```

### 2ï¸âƒ£ Frontend æ˜ åƒ

```bash
âœ… æ˜ åƒï¼šycrm/y-crm:frontend-20251112-amd64
ğŸ“¦ å¤§å°ï¼š153 MB
ğŸ—ï¸ æ¶æ§‹ï¼šlinux/amd64 (AWS x86_64 ç›¸å®¹)
â±ï¸ Build æ™‚é–“ï¼šç´„ 6 åˆ†é˜
   - Vite build: 3 åˆ† 18 ç§’
   - Nginx æ‰“åŒ…: 2 åˆ†é˜
ğŸ¯ ç”¨é€”ï¼š
   - Frontend ç¶²é æœå‹™ (Y-CRM-frontend)
```

**Build å‘½ä»¤**ï¼š
```bash
docker buildx build --platform linux/amd64 \
  -f docker/frontend/Dockerfile \
  --build-arg BACKEND_URL=http://localhost:8867 \
  -t ycrm/y-crm:frontend-20251112-amd64 \
  --push .
```

---

## ğŸ”§ docker-compose.aws.yml é…ç½®

### å·²ä¿®æ­£çš„æ˜ åƒæ¨™ç±¤

```yaml
services:
  postgres:
    image: postgres:16-alpine  # å®˜æ–¹æ˜ åƒ

  redis:
    image: redis:7-alpine  # å®˜æ–¹æ˜ åƒ

  backend:
    image: ycrm/y-crm:backend-20251112-amd64  # âœ… å·²ä¿®æ­£

  worker:
    image: ycrm/y-crm:backend-20251112-amd64  # âœ… å·²ä¿®æ­£ï¼ˆèˆ‡ Backend ç›¸åŒï¼‰
    command: ["node", "dist/src/queue-worker/queue-worker.js"]

  frontend:
    image: ycrm/y-crm:frontend-20251112-amd64  # âœ… å·²ä¿®æ­£
```

---

## ğŸ’¡ æŠ€è¡“ç´°ç¯€

### ç‚ºä»€éº¼ Worker ä¸éœ€è¦å–®ç¨ Buildï¼Ÿ

Twenty CRM çš„æ¶æ§‹è¨­è¨ˆï¼š
- Backend å’Œ Worker ä½¿ç”¨**ç›¸åŒçš„ç¨‹å¼ç¢¼åº«**
- åªæ˜¯åŸ·è¡Œä¸åŒçš„å…¥å£é»ï¼š
  - Backend: `dist/src/main.js` â†’ å•Ÿå‹• API æœå‹™
  - Worker: `dist/src/queue-worker/queue-worker.js` â†’ è™•ç†èƒŒæ™¯ä»»å‹™

é€™æ˜¯å¾®æœå‹™å¸¸è¦‹çš„è¨­è¨ˆæ¨¡å¼ï¼Œæ¸›å°‘æ˜ åƒé‡è¤‡ï¼Œæ–¹ä¾¿ç¶­è­·ã€‚

### è·¨å¹³å°æ§‹å»ºèªªæ˜

**å•é¡Œ**ï¼š
- æ‚¨çš„ Macï¼šARM64 (Apple Silicon)
- AWS EC2ï¼šx86_64 (AMD64)

**è§£æ±ºæ–¹å¼**ï¼š
ä½¿ç”¨ `docker buildx` æ§‹å»º `linux/amd64` æ¶æ§‹çš„æ˜ åƒ

**é‡è¦**ï¼š
- âœ… æ‚¨çš„ Mac ä»å¯é‹è¡Œ amd64 æ˜ åƒ
- Docker Desktop è‡ªå‹•ä½¿ç”¨ QEMU æ¨¡æ“¬å™¨
- æ•ˆèƒ½ç•¥é™ä½†å®Œå…¨å¯ç”¨

### Docker Hub æ¨é€ç‹€æ…‹

```bash
âœ… ycrm/y-crm:backend-20251112-amd64  â†’ å·²æ¨é€
âœ… ycrm/y-crm:frontend-20251112-amd64 â†’ å·²æ¨é€
```

**Repository è¨­å®š**ï¼š
- å¸³è™Ÿï¼š`ycrm`
- Repositoryï¼š`ycrm/y-crm` (ç§æœ‰)
- æ˜ åƒç¸½æ•¸ï¼š2 å€‹è‡ªè¨‚æ˜ åƒ

---

## ğŸ¯ ä¸‹ä¸€æ­¥æº–å‚™

### éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

- [x] Backend æ˜ åƒå·²æ§‹å»ºä¸¦æ¨é€
- [x] Frontend æ˜ åƒå·²æ§‹å»ºä¸¦æ¨é€
- [x] docker-compose.aws.yml æ˜ åƒæ¨™ç±¤å·²ä¿®æ­£
- [x] ç¢ºèª Worker ä½¿ç”¨ Backend æ˜ åƒ
- [ ] å‚™ä»½æœ€æ–°è³‡æ–™åº«ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æº–å‚™éƒ¨ç½²åŒ…
- [ ] ä¸Šå‚³åˆ° AWS

### å»ºè­°çš„æ¸¬è©¦æ­¥é©Ÿ

**é¸é … Aï¼šæœ¬åœ°æ¸¬è©¦ amd64 æ˜ åƒ**
```bash
cd /Users/ym/twenty-ym/docker

# Pull ä¸¦é‹è¡Œ amd64 æ˜ åƒ
docker compose -f Sync-to-AWS/docker-compose.aws.yml pull
docker compose -f Sync-to-AWS/docker-compose.aws.yml up -d

# ç­‰å¾…å•Ÿå‹•
sleep 30

# ä¿®æ­£ URL
./Sync-to-AWS/fix-frontend-url.sh http://localhost:8867

# æ¸¬è©¦è¨ªå•
open http://localhost:8866
```

**é¸é … Bï¼šç›´æ¥éƒ¨ç½²åˆ° AWS**
```bash
cd /Users/ym/twenty-ym/docker/Sync-to-AWS

# 1. å‚™ä»½è³‡æ–™åº«
./01-å‚™ä»½è³‡æ–™åº«.sh

# 2. æº–å‚™éƒ¨ç½²åŒ…
./03-æº–å‚™éƒ¨ç½²åŒ….sh

# 3. ä¸Šå‚³åˆ° AWS
./04-ä¸Šå‚³åˆ°AWS.sh YOUR_AWS_IP
```

---

## ğŸ“Š è³‡æºéœ€æ±‚çµ±è¨ˆ

### Docker Hub ä½¿ç”¨é‡
- Private Repository: 1 å€‹
- ç¸½æ˜ åƒå¤§å°: 9.28 GB (9.13 + 0.15)
- æ˜ åƒæ•¸é‡: 2 å€‹æ¨™ç±¤

### æœ¬åœ°æ§‹å»ºè³‡æº
- Docker Desktop è¨˜æ†¶é«”: 15.6 GB âœ…
- Backend Build: ~10 åˆ†é˜
- Frontend Build: ~6 åˆ†é˜
- ç¸½è€—æ™‚: ~16 åˆ†é˜

### AWS æœ€ä½éœ€æ±‚
- å¯¦ä¾‹é¡å‹: t3.medium (2 vCPU, 4 GB RAM)
- å„²å­˜ç©ºé–“: 60 GB gp3 SSD
- ç¶²è·¯: å®‰å…¨ç¾¤çµ„é–‹æ”¾ 22, 80, 8866, 8867

---

## âœ¨ ç¸½çµ

**âœ… æ˜ åƒæ§‹å»ºå®Œæˆï¼**

æˆ‘å€‘æˆåŠŸæ§‹å»ºä¸¦æ¨é€äº†ï¼š
1. Backend æ˜ åƒ (åŒ…å« Worker åŠŸèƒ½) - 9.13 GB
2. Frontend æ˜ åƒ - 153 MB

**âœ… é…ç½®æª”æ¡ˆå·²ä¿®æ­£ï¼**

`docker-compose.aws.yml` å·²æ›´æ–°æ­£ç¢ºçš„æ˜ åƒæ¨™ç±¤ï¼š
- Backend: `backend-20251112-amd64`
- Worker: `backend-20251112-amd64` (èˆ‡ Backend ç›¸åŒ)
- Frontend: `frontend-20251112-amd64`

**ğŸš€ æº–å‚™å°±ç·’ï¼**

ç¾åœ¨å¯ä»¥ï¼š
- åœ¨æœ¬åœ°æ¸¬è©¦ amd64 æ˜ åƒ
- æˆ–ç›´æ¥éƒ¨ç½²åˆ° AWS

---

**éœ€è¦ä»»ä½•å”åŠ©å—ï¼Ÿ**

è«‹å‘Šè¨´æˆ‘æ‚¨æƒ³ï¼š
- A. å…ˆåœ¨æœ¬åœ°æ¸¬è©¦
- B. ç›´æ¥æº–å‚™ AWS éƒ¨ç½²
- C. å…¶ä»–å•é¡Œæˆ–ç–‘æ…®
