# 📘 同步本地資料到 AWS - 使用說明

**腳本名稱**：`同步本地資料到AWS.sh`  
**功能**：完整複製本地 Y-CRM 資料庫到 AWS  
**作者**：AI Assistant  
**版本**：1.0  
**日期**：2025-11-12  

---

## 🎯 腳本功能

### 主要功能
- ✅ **完整備份**本地 PostgreSQL 資料庫（所有 schema 和資料）
- ✅ **完整備份**本地 Redis 資料
- ✅ **自動上傳**到 AWS
- ✅ **安全還原**到 AWS（先備份 AWS 現有資料）
- ✅ **自動驗證**同步結果
- ✅ **智能清理**臨時檔案

### 同步內容
```
PostgreSQL:
├─ 所有 schema（core, workspace_xxx）
├─ 所有資料表
├─ 用戶資料
├─ 公司資料
├─ 人員資料
├─ 報價單（salesquote）
├─ 報價單細項（salesquotelineitem）
├─ Workflow 資料
└─ 所有自訂物件和欄位

Redis:
├─ 快取資料
├─ Session 資料
└─ Queue 資料
```

---

## 🚀 使用方式

### 基本用法

```bash
cd /Users/ym/twenty-ym/docker/Sync-to-AWS
./同步本地資料到AWS.sh YOUR_AWS_IP
```

### 範例

```bash
# 同步到 AWS（IP: 52.195.151.185）
./同步本地資料到AWS.sh 52.195.151.185
```

---

## 📋 使用前提

### 1. 本地環境
- ✅ 本地 Docker 服務運行中
- ✅ Y-CRM 容器正常運行
  - Y-CRM-postgres
  - Y-CRM-redis
  - Y-CRM-backend
  - Y-CRM-worker
  - Y-CRM-frontend

### 2. AWS 環境
- ✅ AWS EC2 實例已運行
- ✅ SSH 金鑰已設定（`~/.ssh/y-crm-aws-key.pem`）
- ✅ 安全群組已開放 SSH (port 22)
- ✅ Docker 已安裝
- ✅ Y-CRM 已部署（或首次部署）

### 3. 網路連線
- ✅ 穩定的網路連線
- ✅ 可以 SSH 到 AWS
- ✅ 可以 SCP 上傳檔案

---

## ⚙️ 執行流程

### 步驟 1：環境檢查
```
檢查項目：
├─ 本地 Docker 服務
├─ PostgreSQL 容器
├─ Redis 容器
├─ SSH 金鑰
└─ AWS 連線
```

### 步驟 2：備份本地資料
```
備份內容：
├─ PostgreSQL（完整 dump）
│   └─ 使用 pg_dump --no-owner --no-acl
├─ Redis（完整 dump）
│   └─ 使用 redis-cli SAVE
└─ 驗證備份完整性
```

**❓ 第一次確認**：是否繼續上傳到 AWS？

### 步驟 3：上傳到 AWS
```
操作：
├─ 壓縮備份檔案
├─ 透過 SCP 上傳
└─ 驗證上傳成功
```

### 步驟 4：驗證 AWS 環境
```
檢查：
├─ SSH 連線
├─ Docker 服務
└─ 現有容器狀態
```

**❓ 第二次確認**：確定要執行還原嗎？

### 步驟 5：執行還原（關鍵步驟）
```
5.1 安全備份
    └─ 備份 AWS 現有資料庫（如果存在）

5.2 停止服務
    ├─ 停止 Frontend
    ├─ 停止 Worker
    └─ 停止 Backend

5.3 還原 PostgreSQL
    ├─ 驗證 SQL 檔案完整性
    ├─ 使用事務保護執行
    └─ 驗證還原成功

5.4 還原 Redis
    ├─ 複製 dump.rdb
    └─ 重啟 Redis

5.5 重啟服務
    ├─ 啟動 Backend
    ├─ 啟動 Worker
    ├─ 啟動 Frontend
    └─ 等待服務就緒

5.6 修正前端 URL
    └─ 更新 REACT_APP_SERVER_BASE_URL

5.7 清理臨時檔案
    └─ 刪除 AWS 舊備份（還原成功後）
```

### 步驟 6：驗證結果
```
驗證項目：
├─ PostgreSQL 連線
├─ Redis 連線
├─ Backend API
├─ Frontend
├─ Worker
└─ 資料完整性
```

---

## 🛡️ 安全機制

### 1. 雙重確認
- ✅ 備份完成後確認是否上傳
- ✅ 上傳完成後確認是否還原

### 2. 自動備份
- ✅ 還原前自動備份 AWS 現有資料
- ✅ 備份檔名：`aws-backup-before-restore-YYYYMMDD_HHMMSS.sql`

### 3. 事務保護
- ✅ PostgreSQL 還原使用事務
- ✅ 失敗自動回滾
- ✅ 確保資料一致性

### 4. 完整性檢查
- ✅ 備份前驗證容器運行
- ✅ 備份後驗證檔案完整
- ✅ 還原前驗證 SQL 檔案
- ✅ 還原後驗證服務狀態

### 5. 錯誤處理
- ✅ 遇到錯誤立即停止
- ✅ 保留所有備份檔案
- ✅ 顯示詳細錯誤訊息
- ✅ 提供恢復指令

### 6. 智能清理
- ✅ 還原成功：自動刪除 AWS 舊備份
- ✅ 還原失敗：保留所有備份
- ✅ 本地臨時檔案：自動清理

---

## ⏱️ 時間估計

### 正常情況
```
步驟 1：環境檢查       10 秒
步驟 2：備份本地資料   30 秒
步驟 3：上傳到 AWS     1-2 分鐘（取決於網速）
步驟 4：驗證環境       10 秒
步驟 5：執行還原       2-3 分鐘
步驟 6：驗證結果       10 秒

總計：約 4-6 分鐘
停機時間：約 2-3 分鐘
```

---

## ⚠️ 重要注意事項

### 1. 資料覆蓋
- ⚠️ **此操作會完全覆蓋 AWS 上的所有資料**
- ⚠️ 確認 AWS 上沒有重要的新資料
- ⚠️ 如有重要資料，請先手動備份

### 2. 停機時間
- ⚠️ 還原期間 AWS 服務會停止 2-3 分鐘
- ⚠️ 請在低峰時段執行
- ⚠️ 通知相關用戶

### 3. 網路穩定性
- ⚠️ 需要穩定的網路連線
- ⚠️ 上傳大檔案需要時間
- ⚠️ 如果中斷，可以重新執行

### 4. 權限要求
- ⚠️ 需要本地 Docker 權限
- ⚠️ 需要 SSH 到 AWS 的權限
- ⚠️ SSH 金鑰必須正確設定

---

## 🐛 故障排除

### 問題 1：環境檢查失敗

**錯誤訊息**：
```
❌ PostgreSQL 容器未運行
```

**解決方式**：
```bash
# 檢查容器狀態
docker ps

# 啟動容器
cd /Users/ym/twenty-ym/docker
docker compose up -d
```

---

### 問題 2：SSH 連線失敗

**錯誤訊息**：
```
❌ 無法連接到 AWS
```

**解決方式**：
```bash
# 檢查 SSH 金鑰權限
chmod 400 ~/.ssh/y-crm-aws-key.pem

# 測試連線
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP

# 檢查安全群組是否開放 port 22
```

---

### 問題 3：上傳失敗

**錯誤訊息**：
```
❌ 上傳失敗
```

**原因**：
- 網路不穩定
- AWS 磁碟空間不足
- SSH 連線中斷

**解決方式**：
```bash
# 檢查 AWS 磁碟空間
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP "df -h"

# 清理 AWS 磁碟空間
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP "docker system prune -af"

# 重新執行腳本
./同步本地資料到AWS.sh YOUR_AWS_IP
```

---

### 問題 4：還原失敗

**錯誤訊息**：
```
❌ PostgreSQL 還原失敗
```

**AWS 備份已保留**：
```
aws-backup-before-restore-YYYYMMDD_HHMMSS.sql
```

**手動恢復**：
```bash
# SSH 到 AWS
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP

# 恢復資料
docker exec -i Y-CRM-postgres psql -U postgres -d default < aws-backup-before-restore-YYYYMMDD_HHMMSS.sql

# 重啟服務
docker compose -f docker-compose.aws.yml restart
```

---

### 問題 5：服務無法啟動

**錯誤訊息**：
```
⚠️ Backend 狀態異常
```

**檢查方式**：
```bash
# SSH 到 AWS
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP

# 查看服務狀態
docker compose -f docker-compose.aws.yml ps

# 查看日誌
docker compose -f docker-compose.aws.yml logs backend
docker compose -f docker-compose.aws.yml logs postgres

# 重啟服務
docker compose -f docker-compose.aws.yml restart
```

---

### 問題 6：前端 URL 不正確

**症狀**：
- 前端可以訪問
- 但無法連接到 API

**解決方式**：
```bash
# SSH 到 AWS
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP

# 執行 URL 修正
cd Sync-to-AWS
./fix-frontend-url.sh http://YOUR_AWS_IP:8867

# 驗證
docker exec Y-CRM-frontend cat /usr/share/nginx/html/index.html | grep REACT_APP_SERVER_BASE_URL
```

---

## 📝 執行範例

### 完整執行流程

```bash
$ cd /Users/ym/twenty-ym/docker/Sync-to-AWS
$ ./同步本地資料到AWS.sh 52.195.151.185

════════════════════════════════════════════════════════════════════════
  🚀 同步本地 Y-CRM 資料到 AWS
════════════════════════════════════════════════════════════════════════

📋 目標 AWS：52.195.151.185
📋 同步內容：PostgreSQL + Redis（完整資料）
⚠️  警告：此操作會覆蓋 AWS 上的所有資料

🔍 步驟 1/6：檢查本地環境
   ├─ ✅ 本地 Docker 服務運行中
   ├─ ✅ PostgreSQL 容器正常
   ├─ ✅ Redis 容器正常
   ├─ ✅ SSH 金鑰已找到
   └─ ✅ 環境檢查完成

🔍 步驟 2/6：備份本地資料（完整備份）
   ├─ 📦 正在備份 PostgreSQL（所有 schema 和資料）...
   ├─ ✅ PostgreSQL 備份完成 (24M)
   ├─ 📦 正在備份 Redis...
   ├─ ✅ Redis 備份完成 (26M)
   ├─ 🔐 驗證備份完整性...
   ├─ ✅ 備份檔案完整
   └─ ✅ 備份完成

📊 本地資料統計：
   - 資料庫大小：24M
   - Redis 大小：26M

❓ 是否繼續上傳到 AWS？(y/n): y

🔍 步驟 3/6：上傳到 AWS
   ├─ 🗜️  正在壓縮備份檔案...
   ├─ ✅ 壓縮完成 (18M)
   ├─ 📤 正在上傳到 AWS (52.195.151.185)...
   ├─ ✅ 上傳完成
   └─ ✅ 上傳完成

🔍 步驟 4/6：驗證 AWS 環境
   ├─ 🔐 測試 SSH 連線...
   ├─ ✅ SSH 連線成功
   ├─ 🔍 檢查 Docker 服務...
   ├─ ✅ Y-CRM-postgres 運行中
   ├─ ✅ Y-CRM-redis 運行中
   ├─ ✅ Y-CRM-backend 運行中
   └─ ✅ AWS 環境檢查完成

⚠️  準備執行資料還原
   - 這將會覆蓋 AWS 上的所有資料
   - 還原期間服務將停止約 2-3 分鐘
   - AWS 現有資料會先自動備份

❓ 確定要執行還原嗎？(y/n): y

🔍 步驟 5/6：執行 AWS 資料還原
   ├─ 📦 解壓縮備份檔案...
   ├─ ✅ 解壓縮完成

   🛡️  安全措施：備份 AWS 現有資料
   ├─ 📦 正在備份 AWS PostgreSQL...
   ├─ ✅ 備份完成：aws-backup-before-restore-20251112_203000.sql (23M)
   └─ 💡 如需恢復，請使用此備份檔案

   🔄 停止 AWS 服務
   └─ ✅ 服務已停止

   📥 還原 PostgreSQL（完整資料）
   ├─ 🔍 驗證 SQL 檔案完整性...
   ├─ ✅ SQL 檔案完整
   ├─ 🔄 開始執行 SQL（使用事務保護）...
   ├─ ✅ PostgreSQL 還原完成
   └─ 📊 還原統計：24M

   📥 還原 Redis
   └─ ✅ Redis 還原完成 (26M)

   🚀 重啟 AWS 服務
   ├─ ⏳ 等待服務啟動...
   └─ ✅ 所有服務已啟動

   🔧 修正前端 URL
   └─ ✅ 前端 URL 已更新

   🧹 清理臨時檔案
   ├─ 🗑️  刪除 AWS 舊備份（還原成功）
   └─ ✅ 清理完成

════════════════════════════════════════════════════════════════════════

🔍 步驟 6/6：驗證同步結果
   ├─ ✅ PostgreSQL 運行正常
   ├─ ✅ Redis 運行正常
   ├─ ✅ Backend API 正常
   ├─ ✅ Frontend 正常
   ├─ ✅ Worker 運行中
   └─ ✅ 驗證完成

📈 同步統計
   ├─ 資料庫：24M (100% 完整複製)
   ├─ Redis：26M (100% 完整複製)
   └─ 狀態：所有資料已同步

════════════════════════════════════════════════════════════════════════
  ✅ 同步完成！
════════════════════════════════════════════════════════════════════════

🎯 結果：
   - 本地資料已完整同步到 AWS
   - AWS 系統已恢復正常運行
   - 所有服務驗證通過

🌐 訪問 AWS Y-CRM：
   前端：http://52.195.151.185:8866
   登入：notyenyu@gmail.com

📝 備份已保留在：
   本地：./history/backup-20251112_203000/ (自動保存)

════════════════════════════════════════════════════════════════════════
  同步流程結束
════════════════════════════════════════════════════════════════════════
```

---

## 📊 資料完整性保證

### PostgreSQL 完整備份
```sql
-- 腳本使用的命令
pg_dump -U postgres -d default --no-owner --no-acl

包含內容：
✅ 所有 schema（CREATE SCHEMA）
✅ 所有表結構（CREATE TABLE）
✅ 所有資料（COPY ... FROM stdin）
✅ 所有索引（CREATE INDEX）
✅ 所有約束（ALTER TABLE ADD CONSTRAINT）
✅ 所有序列（CREATE SEQUENCE）
✅ 所有視圖（CREATE VIEW）
✅ 所有函數（CREATE FUNCTION）

不包含（確保安全）：
❌ 不會 DROP DATABASE
❌ 不會 DROP SCHEMA ... CASCADE
❌ 只用 DROP TABLE IF EXISTS（單表）
```

### Redis 完整備份
```bash
-- 腳本使用的命令
redis-cli SAVE
docker cp Y-CRM-redis:/data/dump.rdb

包含內容：
✅ 所有 keys
✅ 所有資料
✅ TTL 資訊
✅ 資料型態
```

---

## 🔒 安全性說明

### 1. 不會初始化資料庫
- ✅ **絕對不會**執行 `DROP DATABASE`
- ✅ **絕對不會**執行 `DROP SCHEMA ... CASCADE`
- ✅ 只使用 `DROP TABLE IF EXISTS`（單表重建）

### 2. 事務保護
- ✅ SQL 執行包裝在事務中
- ✅ 失敗自動回滾
- ✅ 確保資料一致性

### 3. 備份保護
- ✅ 還原前自動備份 AWS
- ✅ 失敗時保留所有備份
- ✅ 可隨時恢復到還原前狀態

### 4. 權限控制
- ✅ 使用 SSH 金鑰認證
- ✅ 不會暴露密碼
- ✅ 安全傳輸（SCP）

---

## 📞 技術支援

### 需要協助？

如果遇到問題：
1. 檢查本文件的「故障排除」章節
2. 查看錯誤訊息
3. 保留所有備份檔案
4. 隨時告訴我具體的錯誤訊息

### 常見問題

**Q1：可以多次執行嗎？**  
A：可以！每次執行都是獨立的，有完整的備份和恢復機制。

**Q2：會刪除 AWS 的資料嗎？**  
A：會覆蓋，但會先自動備份。如果失敗，可以恢復。

**Q3：本地資料會被影響嗎？**  
A：不會！只是複製到 AWS，本地完全不變。

**Q4：需要手動操作嗎？**  
A：只需要兩次確認（y/n），其他全自動。

**Q5：如果中途取消了怎麼辦？**  
A：輸入 n 就會安全退出，不會有任何影響。

---

**最後更新**：2025-11-12  
**版本**：1.0  
**腳本路徑**：`/Users/ym/twenty-ym/docker/Sync-to-AWS/同步本地資料到AWS.sh`

