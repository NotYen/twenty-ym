# ğŸš€ Y-CRM å®Œæ•´é·ç§»åˆ° AWS æ­¥é©Ÿ

**ç›®æ¨™**ï¼šå°‡æœ¬åœ° Docker Y-CRM æœå‹™å®Œæ•´è¤‡è£½åˆ° AWS

åŒ…å«ï¼š
- âœ… æ‰€æœ‰é…ç½®ï¼ˆç«¯å£ã€ç’°å¢ƒè®Šæ•¸ï¼‰
- âœ… PostgreSQL è³‡æ–™åº«ï¼ˆæ‰€æœ‰ schemaã€è³‡æ–™ã€workflowï¼‰
- âœ… Redis è³‡æ–™
- âœ… Worker æœå‹™
- âœ… å ±åƒ¹å–®ã€å ±åƒ¹å–®ç´°é …ç­‰è‡ªè¨‚åŠŸèƒ½

---

## ğŸ“‹ å·²å®Œæˆçš„æº–å‚™å·¥ä½œ

### âœ… 1. Docker æ˜ åƒæ§‹å»º
- Backend (å« Worker): `ycrm/y-crm:backend-20251112-amd64` (9.13 GB)
- Frontend: `ycrm/y-crm:frontend-20251112-amd64` (153 MB)
- å·²æ¨é€åˆ° Docker Hub ç§æœ‰ repository

### âœ… 2. å®Œæ•´ç³»çµ±å‚™ä»½
- PostgreSQL: `backups/postgres/db-all.sql` (24 MB)
  - åŒ…å«æ‰€æœ‰ schemaï¼ˆcore + workspaceï¼‰
  - åŒ…å«æ‰€æœ‰è³‡æ–™ï¼ˆusers, workflow, salesquote, salesquotelineitemï¼‰
- Redis: `backups/redis/dump.rdb` (26 MB)
  - åŒ…å«æ‰€æœ‰å¿«å–è³‡æ–™

### âœ… 3. éƒ¨ç½²è…³æœ¬æº–å‚™
- `01-å‚™ä»½è³‡æ–™åº«.sh` - å‚™ä»½è…³æœ¬
- `03-æº–å‚™éƒ¨ç½²åŒ….sh` - æ‰“åŒ…è…³æœ¬
- `04-ä¸Šå‚³åˆ°AWS.sh` - ä¸Šå‚³è…³æœ¬
- `deploy-to-aws.sh` - AWS éƒ¨ç½²è…³æœ¬
- `fix-frontend-url.sh` - URL ä¿®æ­£è…³æœ¬
- `.env.template` - ç’°å¢ƒè®Šæ•¸ç¯„æœ¬

---

## ğŸ¯ å®Œæ•´é·ç§»æµç¨‹

### éšæ®µä¸€ï¼šæœ¬åœ°æº–å‚™ï¼ˆåœ¨æ‚¨çš„ Mac ä¸Šï¼‰

#### æ­¥é©Ÿ 1ï¼šç¢ºèªå‚™ä»½å®Œæ•´
```bash
cd /Users/ym/twenty-ym/docker/Sync-to-AWS

# æª¢æŸ¥å‚™ä»½æª”æ¡ˆ
ls -lh backups/postgres/db-all.sql
ls -lh backups/redis/dump.rdb
```

æ‡‰è©²çœ‹åˆ°ï¼š
- `db-all.sql` ç´„ 24 MB
- `dump.rdb` ç´„ 26 MB

#### æ­¥é©Ÿ 2ï¼šæº–å‚™éƒ¨ç½²åŒ…
```bash
./03-æº–å‚™éƒ¨ç½²åŒ….sh
```

é€™æœƒå‰µå»º `aws-deployment-YYYYMMDD.tar.gz`ï¼ŒåŒ…å«ï¼š
- Docker Compose é…ç½®
- æ‰€æœ‰è…³æœ¬
- å®Œæ•´çš„è³‡æ–™åº«å‚™ä»½
- ç’°å¢ƒè®Šæ•¸ç¯„æœ¬

#### æ­¥é©Ÿ 3ï¼šä¸Šå‚³åˆ° AWS
```bash
./04-ä¸Šå‚³åˆ°AWS.sh YOUR_AWS_IP

# ç¯„ä¾‹ï¼š
# ./04-ä¸Šå‚³åˆ°AWS.sh 52.195.151.185
```

---

### éšæ®µäºŒï¼šAWS éƒ¨ç½²ï¼ˆåœ¨ AWS VM ä¸Šï¼‰

#### æ­¥é©Ÿ 1ï¼šSSH é€£ç·šåˆ° AWS
```bash
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP
```

#### æ­¥é©Ÿ 2ï¼šè§£å£“ç¸®éƒ¨ç½²åŒ…
```bash
tar -xzf aws-deployment-*.tar.gz
ls -la
```

æ‡‰è©²çœ‹åˆ°ï¼š
- `docker-compose.aws.yml`
- `deploy-to-aws.sh`
- `fix-frontend-url.sh`
- `.env`
- `backups/` è³‡æ–™å¤¾

#### æ­¥é©Ÿ 3ï¼šä¿®æ”¹ç’°å¢ƒè®Šæ•¸
```bash
nano .env
```

**å¿…é ˆä¿®æ”¹çš„åœ°æ–¹**ï¼ˆæŒ‰ Ctrl+\ æœå°‹ä¸¦æ›¿æ›ï¼‰ï¼š
1. æœå°‹ï¼š`YOUR_AWS_IP`
2. æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› AWS IPï¼ˆä¾‹å¦‚ï¼š`52.195.151.185`ï¼‰
3. æŒ‰ Ctrl+Xï¼Œç„¶å¾Œ Yï¼Œç„¶å¾Œ Enter å„²å­˜

#### æ­¥é©Ÿ 4ï¼šç™»å…¥ Docker Hub
```bash
docker login -u ycrm
# è¼¸å…¥æ‚¨çš„ Docker Hub Personal Access Token
```

#### æ­¥é©Ÿ 5ï¼šè¨­ç½®åŸ·è¡Œæ¬Šé™
```bash
chmod +x deploy-to-aws.sh fix-frontend-url.sh
```

#### æ­¥é©Ÿ 6ï¼šåŸ·è¡Œéƒ¨ç½²
```bash
./deploy-to-aws.sh
```

é€™å€‹è…³æœ¬æœƒï¼š
1. âœ… æ‹‰å– Docker æ˜ åƒ
2. âœ… å•Ÿå‹• PostgreSQL ä¸¦è‡ªå‹•å°å…¥å‚™ä»½
3. âœ… å•Ÿå‹• Redis ä¸¦è¼‰å…¥è³‡æ–™
4. âœ… å•Ÿå‹• Backend æœå‹™
5. âœ… å•Ÿå‹• Worker æœå‹™
6. âœ… å•Ÿå‹• Frontend æœå‹™

ç­‰å¾…ç´„ 30-60 ç§’è®“æœå‹™å®Œå…¨å•Ÿå‹•ã€‚

#### æ­¥é©Ÿ 7ï¼šä¿®æ­£å‰ç«¯ URL
```bash
./fix-frontend-url.sh http://YOUR_AWS_IP:8867

# ç¯„ä¾‹ï¼š
# ./fix-frontend-url.sh http://52.195.151.185:8867
```

#### æ­¥é©Ÿ 8ï¼šé©—è­‰æœå‹™
```bash
# æª¢æŸ¥æ‰€æœ‰å®¹å™¨ç‹€æ…‹
docker compose -f docker-compose.aws.yml ps

# æ‡‰è©²çœ‹åˆ° 5 å€‹å®¹å™¨éƒ½åœ¨é‹è¡Œï¼š
# - Y-CRM-postgres (Up)
# - Y-CRM-redis (Up)
# - Y-CRM-backend (Up)
# - Y-CRM-worker (Up)
# - Y-CRM-frontend (Up)
```

#### æ­¥é©Ÿ 9ï¼šè¨ªå•ç³»çµ±
```bash
# åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ï¼š
http://YOUR_AWS_IP:8866

# ä½¿ç”¨ä»¥ä¸‹å¸³è™Ÿç™»å…¥ï¼š
# Email: notyenyu@gmail.com
# Password: ï¼ˆæ‚¨çš„å¯†ç¢¼ï¼‰
```

---

## âœ… é©—è­‰é·ç§»å®Œæ•´æ€§

ç™»å…¥å¾Œæª¢æŸ¥ï¼š

1. **ç”¨æˆ¶è³‡æ–™**
   - æª¢æŸ¥ç”¨æˆ¶åˆ—è¡¨æ˜¯å¦å®Œæ•´
   - æ¬Šé™è¨­å®šæ˜¯å¦æ­£ç¢º

2. **è‡ªè¨‚ç‰©ä»¶**
   - å ±åƒ¹å–®ï¼ˆsalesquoteï¼‰
   - å ±åƒ¹å–®ç´°é …ï¼ˆsalesquotelineitemï¼‰
   - æ‰€æœ‰è‡ªè¨‚æ¬„ä½

3. **Workflow**
   - é€²å…¥è¨­å®š > Workflows
   - ç¢ºèªæ‰€æœ‰ workflow éƒ½å­˜åœ¨
   - æ¸¬è©¦ workflow æ˜¯å¦æ­£å¸¸é‹è¡Œ

4. **è³‡æ–™å®Œæ•´æ€§**
   - æª¢æŸ¥å ±åƒ¹å–®åˆ—è¡¨
   - æª¢æŸ¥å ±åƒ¹å–®ç´°é …
   - ç¢ºèªæ‰€æœ‰è³‡æ–™éƒ½æ­£ç¢º

---

## ğŸ”„ é‡è¦æé†’

### æ¯æ¬¡é‡å•Ÿå®¹å™¨å¾Œéœ€è¦åŸ·è¡Œ
```bash
./fix-frontend-url.sh http://YOUR_AWS_IP:8867
```

é€™æ˜¯å› ç‚º Twenty CRM æœƒåœ¨å•Ÿå‹•æ™‚é‡æ–°ç”Ÿæˆ `index.html`ã€‚

### ç«¯å£å°æ‡‰
æœ¬åœ° â†’ AWSï¼ˆå®Œå…¨ç›¸åŒï¼‰
- Frontend: 8866 â†’ 8866
- Backend: 8867 â†’ 8867
- PostgreSQL: 5432 â†’ 5432
- Redis: 6379 â†’ 6379

### å®‰å…¨ç¾¤çµ„è¨­å®š
AWS å®‰å…¨ç¾¤çµ„å¿…é ˆé–‹æ”¾ï¼š
- 22 (SSH)
- 80 (HTTP)
- 8866 (Frontend)
- 8867 (Backend API)

---

## ğŸ†˜ æ•…éšœæ’é™¤

### å•é¡Œ 1ï¼šå®¹å™¨ç„¡æ³•å•Ÿå‹•
```bash
# æŸ¥çœ‹æ—¥èªŒ
docker compose -f docker-compose.aws.yml logs -f

# ç‰¹åˆ¥æ³¨æ„ postgres å’Œ backend çš„æ—¥èªŒ
```

### å•é¡Œ 2ï¼šå‰ç«¯ç„¡æ³•é€£æ¥å¾Œç«¯
```bash
# é‡æ–°åŸ·è¡Œ URL ä¿®æ­£
./fix-frontend-url.sh http://YOUR_AWS_IP:8867

# é©—è­‰
docker exec Y-CRM-frontend cat /usr/share/nginx/html/index.html | grep REACT_APP_SERVER_BASE_URL
```

### å•é¡Œ 3ï¼šè³‡æ–™åº«æ²’æœ‰è³‡æ–™
```bash
# æª¢æŸ¥ postgres å®¹å™¨æ—¥èªŒ
docker logs Y-CRM-postgres

# æ‰‹å‹•å°å…¥å‚™ä»½ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker exec -i Y-CRM-postgres psql -U postgres -d default < backups/postgres/db-all.sql
```

### å•é¡Œ 4ï¼šWorkflow ä¸é‹è¡Œ
```bash
# æª¢æŸ¥ worker å®¹å™¨æ˜¯å¦é‹è¡Œ
docker compose -f docker-compose.aws.yml ps worker

# æª¢æŸ¥ worker æ—¥èªŒ
docker logs Y-CRM-worker -f
```

---

## ğŸ“Š å®Œæ•´æœå‹™å°ç…§è¡¨

| æœå‹™ | æœ¬åœ°å®¹å™¨å | AWS å®¹å™¨å | ç«¯å£ | æ˜ åƒ |
|-----|-----------|-----------|------|------|
| PostgreSQL | Y-CRM-postgres | Y-CRM-postgres | 5432 | postgres:16-alpine |
| Redis | Y-CRM-redis | Y-CRM-redis | 6379 | redis:7-alpine |
| Backend | Y-CRM-backend | Y-CRM-backend | 8867 | ycrm/y-crm:backend-20251112-amd64 |
| Worker | Y-CRM-worker | Y-CRM-worker | - | ycrm/y-crm:backend-20251112-amd64 |
| Frontend | Y-CRM-frontend | Y-CRM-frontend | 8866 | ycrm/y-crm:frontend-20251112-amd64 |

---

## ğŸ‰ å®Œæˆï¼

å¦‚æœä¸€åˆ‡é †åˆ©ï¼Œæ‚¨ç¾åœ¨å·²ç¶“æˆåŠŸå°‡æœ¬åœ°çš„ Y-CRM ç³»çµ±å®Œæ•´é·ç§»åˆ° AWSï¼

æ‰€æœ‰çš„è³‡æ–™ã€é…ç½®ã€workflowã€è‡ªè¨‚ç‰©ä»¶éƒ½æ‡‰è©²å’Œæœ¬åœ°å®Œå…¨ä¸€è‡´ã€‚

**éœ€è¦å”åŠ©å—ï¼Ÿ**
è«‹éš¨æ™‚å‘Šè¨´æˆ‘é‡åˆ°çš„ä»»ä½•å•é¡Œï¼
