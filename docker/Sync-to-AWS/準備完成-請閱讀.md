# ✅ Y-CRM AWS 遷移準備完成！

**準備時間**：2025-11-12 20:09
**狀態**：✅ 所有準備工作已完成，隨時可以部署到 AWS

---

## 📦 已準備好的內容

### 1. Docker 映像（已推送到 Docker Hub）
```
✅ ycrm/y-crm:backend-20251112-amd64 (9.13 GB)
   用途：Backend API + Worker 背景任務

✅ ycrm/y-crm:frontend-20251112-amd64 (153 MB)
   用途：Frontend 網頁服務
```

### 2. 完整資料備份
```
✅ PostgreSQL: backups/postgres/db-all.sql (24 MB)
   包含：
   - 所有 schema（core + workspace_xxx）
   - 所有資料表
   - 用戶資料 (notyenyu@gmail.com 等)
   - 報價單 (salesquote)
   - 報價單細項 (salesquotelineitem)
   - Workflow 資料
   - 所有自訂物件和欄位

✅ Redis: backups/redis/dump.rdb (26 MB)
   包含：
   - 快取資料
   - Session 資料
   - Queue 資料
```

### 3. 部署包
```
✅ aws-deployment-20251112.tar.gz (18 MB)
   位置：/Users/ym/twenty-ym/docker/Sync-to-AWS/
   
   包含檔案：
   - docker-compose.aws.yml (服務配置)
   - deploy-to-aws.sh (自動部署腳本)
   - fix-frontend-url.sh (URL 修正腳本)
   - .env (環境變數 - 需要修改 YOUR_AWS_IP)
   - backups/postgres/db-all.sql (資料庫備份)
   - backups/redis/dump.rdb (Redis 備份)
```

---

## 🎯 現在可以做什麼？

### 選項 A：上傳到 AWS（推薦）

如果您的 AWS VM 已準備好：

```bash
cd /Users/ym/twenty-ym/docker/Sync-to-AWS

# 上傳到 AWS
./04-上傳到AWS.sh YOUR_AWS_IP

# 範例：
# ./04-上傳到AWS.sh 52.195.151.185
```

### 選項 B：先在本地測試

如果想先測試映像是否正常：

```bash
cd /Users/ym/twenty-ym/docker/Sync-to-AWS

# Pull 映像
docker compose -f docker-compose.aws.yml pull

# 啟動服務
docker compose -f docker-compose.aws.yml up -d

# 修正 URL
./fix-frontend-url.sh http://localhost:8867

# 訪問測試
open http://localhost:8866
```

---

## 📋 AWS 部署清單

在上傳前，請確認：

- [ ] AWS EC2 實例已創建
  - 建議規格：t3.medium (2 vCPU, 4 GB RAM)
  - 作業系統：Ubuntu 24.04 LTS
  - 儲存空間：60 GB gp3 SSD

- [ ] 安全群組已配置
  - Port 22 (SSH)
  - Port 80 (HTTP)
  - Port 8866 (Frontend)
  - Port 8867 (Backend API)

- [ ] SSH 金鑰已設定
  - 位置：~/.ssh/y-crm-aws-key.pem
  - 權限：chmod 400 ~/.ssh/y-crm-aws-key.pem

- [ ] Docker 已安裝在 AWS
  ```bash
  # 如果還沒安裝，執行：
  curl -fsSL https://get.docker.com -o get-docker.sh
  sudo sh get-docker.sh
  sudo usermod -aG docker ubuntu
  ```

---

## 🚀 完整部署流程（快速參考）

### 步驟 1：上傳（本地執行）
```bash
cd /Users/ym/twenty-ym/docker/Sync-to-AWS
./04-上傳到AWS.sh YOUR_AWS_IP
```

### 步驟 2：部署（AWS 執行）
```bash
# SSH 連線
ssh -i ~/.ssh/y-crm-aws-key.pem ubuntu@YOUR_AWS_IP

# 解壓縮
tar -xzf aws-deployment-20251112.tar.gz

# 修改 .env
nano .env
# 將所有 YOUR_AWS_IP 替換為實際 IP

# 登入 Docker Hub
docker login -u ycrm

# 執行部署
chmod +x deploy-to-aws.sh fix-frontend-url.sh
./deploy-to-aws.sh

# 修正 URL
./fix-frontend-url.sh http://YOUR_AWS_IP:8867
```

### 步驟 3：訪問系統
```
前端：http://YOUR_AWS_IP:8866
登入：notyenyu@gmail.com
```

---

## 🔍 遷移內容對照表

| 項目 | 本地 | AWS | 狀態 |
|-----|------|-----|------|
| Frontend 端口 | 8866 | 8866 | ✅ 相同 |
| Backend 端口 | 8867 | 8867 | ✅ 相同 |
| PostgreSQL 端口 | 5432 | 5432 | ✅ 相同 |
| Redis 端口 | 6379 | 6379 | ✅ 相同 |
| 資料庫資料 | 完整 | 完整 | ✅ 完全相同 |
| Workflow | 完整 | 完整 | ✅ 完全相同 |
| 用戶資料 | 完整 | 完整 | ✅ 完全相同 |
| 報價單 | 完整 | 完整 | ✅ 完全相同 |
| Redis 快取 | 完整 | 完整 | ✅ 完全相同 |
| Worker 服務 | 運行 | 運行 | ✅ 完全相同 |

---

## 📚 相關文件

1. **完整遷移步驟.md**
   - 詳細的步驟說明
   - 故障排除指南
   - 驗證清單

2. **README.md**
   - 部署流程概覽
   - 腳本說明
   - 維運指南

3. **映像構建總結.md**
   - 映像構建細節
   - 架構說明
   - 技術細節

---

## 💡 重要提醒

### 關於 Worker 服務
- Worker 使用和 Backend **相同的映像**
- 只是執行不同的命令（queue-worker.js）
- 這是標準的微服務設計模式

### 關於前端 URL
- 每次重啟 Docker 容器後需要重新執行 `fix-frontend-url.sh`
- 這是 Twenty CRM 的設計特性，會重新生成 `index.html`

### 關於資料完整性
- PostgreSQL 備份包含所有 schema 和資料
- Redis 備份包含所有快取和 session
- 遷移後的 AWS 系統和本地**完全一致**

---

## 🆘 需要協助？

如果遇到任何問題：

1. 檢查本資料夾中的 `完整遷移步驟.md`
2. 查看 `README.md` 中的故障排除
3. 隨時告訴我遇到的具體問題

---

## ✨ 總結

**✅ 準備工作 100% 完成！**

您現在擁有：
- ✅ 跨平台 Docker 映像（amd64）
- ✅ 完整的資料備份（PostgreSQL + Redis）
- ✅ 自動化部署腳本
- ✅ 打包好的部署包 (18 MB)
- ✅ 完整的文件和指南

**下一步：執行 `./04-上傳到AWS.sh YOUR_AWS_IP`**

---

**需要我現在幫您上傳到 AWS 嗎？**

請提供您的 AWS IP 地址，我可以立即執行上傳！
或者您想先在本地測試一下映像？

請告訴我您的決定！🚀
